<%- include('partials/head', { title: 'ç®¡ç†åå°' }) %>

  <!-- å¯¼èˆª -->
  <nav class="glass-solid sticky top-0 z-40 px-6 py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-sm">ğŸ‘</div>
        <span class="text-white font-semibold hidden sm:block">å°å§¨å­ã®åå°</span>
      </div>
      <div class="flex items-center gap-3">
        <a href="/" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-white transition">è¿”å›é¢æ¿</a>
        <a href="/auth/logout" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-red-400 transition">é€€å‡º</a>
      </div>
    </div>
  </nav>

  <!-- Tab å¯¼èˆª -->
  <div class="max-w-6xl mx-auto px-4 sm:px-6 pt-6">
    <div class="flex gap-1 glass-solid rounded-2xl p-1.5 overflow-x-auto">
      <button onclick="switchTab('nodes')" class="tab-btn active text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="nodes">ğŸŒ èŠ‚ç‚¹</button>
      <button onclick="switchTab('users')" class="tab-btn text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="users">ğŸ‘¥ ç”¨æˆ·</button>
      <button onclick="switchTab('traffic')" class="tab-btn text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="traffic">ğŸ“Š æµé‡</button>
      <button onclick="switchTab('whitelist')" class="tab-btn text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="whitelist">ğŸ”’ ç™½åå•</button>
      <button onclick="switchTab('ai')" class="tab-btn text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="ai">ğŸ§  AI</button>
      <button onclick="switchTab('logs')" class="tab-btn text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="logs">ğŸ“‹ æ—¥å¿—</button>
      <button onclick="switchTab('abuse')" class="tab-btn text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="abuse">ğŸ” ç›‘æ§</button>
      <button onclick="switchTab('ops')" class="tab-btn text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="ops">ğŸ”§ è¿ç»´</button>
      <button onclick="switchTab('notify')" class="tab-btn text-sm px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="notify">ğŸ”” é€šçŸ¥</button>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6">
    <%- include('partials/admin-nodes') %>
    <%- include('partials/admin-sections') %>
    <%- include('partials/admin-traffic') %>
  </main>

  <style>
    .tab-btn{color:#9ca3af}.tab-btn:hover{color:#fff;background:rgba(255,255,255,0.05)}
    .tab-btn.active{color:#fff;background:rgba(244,63,94,0.2);font-weight:500}
    .tab-panel{display:none}.tab-panel.active{display:block}
  </style>
  <script>
    function switchTab(name) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.dataset.tab === name));
      location.hash = name;
      if (name === 'ops') loadOps();
    }
    if (location.hash.slice(1)) switchTab(location.hash.slice(1));
    const _msg = new URLSearchParams(location.search).get('msg');
    if (_msg) { const m = {deploying:'ğŸš€ éƒ¨ç½²ä¸­ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹',added:'âœ… èŠ‚ç‚¹å·²æ·»åŠ ',dup:'âš ï¸ IP å·²å­˜åœ¨'}; if (m[_msg]) showToast(m[_msg]); history.replaceState(null,'',location.pathname+location.hash); }

    function toggleEdit(id) {
      document.getElementById('host-display-' + id).classList.toggle('hidden');
      document.getElementById('host-form-' + id).classList.toggle('hidden');
    }

    function updateNodeLevel(id, level) {
      fetch('/admin/api/nodes/' + id + '/update-level', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ level })
      }).then(r => r.json()).then(d => { if (d.ok) showToast('ç­‰çº§å·²æ›´æ–°ï¼ŒèŠ‚ç‚¹é…ç½®åŒæ­¥ä¸­'); });
    }

    const defaultEndpoints = { openai: 'https://api.openai.com/v1', gemini: 'https://generativelanguage.googleapis.com/v1beta', claude: 'https://api.anthropic.com/v1' };
    const defaultModels = { openai: 'gpt-4o', gemini: 'gemini-2.0-flash', claude: 'claude-sonnet-4-20250514' };

    function fillDefaults() {
      const type = document.getElementById('pf-type').value;
      document.getElementById('pf-endpoint').placeholder = defaultEndpoints[type] || '';
      document.getElementById('pf-model-id').placeholder = defaultModels[type] || '';
      if (!document.getElementById('pf-edit-id').value) {
        document.getElementById('pf-endpoint').value = defaultEndpoints[type] || '';
        document.getElementById('pf-model-id').value = defaultModels[type] || '';
      }
    }

    async function saveProvider() {
      const editId = document.getElementById('pf-edit-id').value;
      const data = { type: document.getElementById('pf-type').value, name: document.getElementById('pf-name').value.trim(), endpoint: document.getElementById('pf-endpoint').value.trim(), api_key: document.getElementById('pf-key').value.trim(), model_id: document.getElementById('pf-model-id').value.trim(), system_prompt: document.getElementById('pf-prompt').value.trim(), enabled: true };
      if (!data.name || !data.endpoint || !data.model_id || (!editId && !data.api_key)) { _alert('è¯·å¡«å†™å¿…å¡«å­—æ®µ'); return; }
      const btn = document.getElementById('pf-save-btn'); btn.disabled = true; btn.textContent = 'ä¿å­˜ä¸­...';
      try {
        const url = editId ? '/admin/api/ai/providers/' + editId : '/admin/api/ai/providers';
        if (editId && !data.api_key) delete data.api_key;
        const res = await fetch(url, { method: editId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (res.ok) { location.hash='ai'; location.reload(); } else _alert('ä¿å­˜å¤±è´¥: ' + (await res.json()).error);
      } catch (e) { _alert('è¯·æ±‚å¤±è´¥: ' + e.message); }
      btn.disabled = false; btn.textContent = 'ä¿å­˜';
    }

    async function toggleProvider(id) { await fetch('/admin/api/ai/providers/' + id + '/toggle', { method: 'POST', headers:{'Content-Type':'application/json'} }); location.hash='ai'; location.reload(); }
    async function deleteProvider(id) { if (!await _confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return; await fetch('/admin/api/ai/providers/' + id, { method: 'DELETE', headers:{'Content-Type':'application/json'} }); location.hash='ai'; location.reload(); }

    function editProvider(id) {
      const el = document.querySelector('[data-provider-id="' + id + '"]');
      if (!el) return;
      const texts = el.querySelectorAll('p');
      const nameTxt = texts[0]?.textContent?.trim() || '';
      const metaTxt = texts[1]?.textContent || '';
      const endpointTxt = texts[2]?.textContent?.trim() || '';
      const typeMatch = metaTxt.match(/^\s*(OPENAI|GEMINI|CLAUDE)/);
      const type = typeMatch ? typeMatch[1].toLowerCase() : 'openai';
      const modelMatch = metaTxt.match(/Â·\s*(.+)$/);
      const modelId = modelMatch ? modelMatch[1].trim() : '';
      document.getElementById('pf-edit-id').value = id;
      document.getElementById('pf-type').value = type;
      document.getElementById('pf-name').value = nameTxt;
      document.getElementById('pf-endpoint').value = endpointTxt;
      document.getElementById('pf-key').value = '';
      document.getElementById('pf-key').placeholder = 'ç•™ç©ºä¿ç•™åŸ Key';
      document.getElementById('pf-model-id').value = modelId;
      document.getElementById('pf-prompt').value = el.dataset.prompt || '';
      document.getElementById('pf-save-btn').textContent = 'æ›´æ–°';
      document.getElementById('add-provider-details').open = true;
      document.getElementById('provider-form-container').scrollIntoView({ behavior: 'smooth' });
    }

    async function saveAnnouncement() {
      const text = document.getElementById('announcement-text').value.trim();
      await fetch('/admin/api/announcement', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text}) });
      showToast(text ? 'âœ… å…¬å‘Šå·²æ›´æ–°' : 'âœ… å…¬å‘Šå·²æ¸…é™¤');
    }
    async function saveTG() {
      const token = document.getElementById('tg-token').value.trim();
      const chatId = document.getElementById('tg-chat-id').value.trim();
      const res = await fetch('/admin/api/notify/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, chatId }) });
      if (res.ok) toast('âœ… å·²ä¿å­˜'); else toast('âŒ ä¿å­˜å¤±è´¥');
    }
    async function testTG() {
      const res = await fetch('/admin/api/notify/test', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();
      toast(data.ok ? 'âœ… æµ‹è¯•æ¶ˆæ¯å·²å‘é€' : 'âŒ ' + (data.error || 'å‘é€å¤±è´¥'));
    }
    async function toggleEvent(el) {
      await fetch('/admin/api/notify/event', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: el.dataset.key, enabled: el.checked }) });
    }

    function fmtBytes(b) { if(!b)return'0 B'; const u=['B','KB','MB','GB','TB']; const i=Math.floor(Math.log(b)/Math.log(1024)); return (b/Math.pow(1024,i)).toFixed(1)+' '+u[i]; }
    async function loadTraffic(page) {
      const date = document.getElementById('traffic-date').value;
      const res = await fetch('/admin/api/traffic?date=' + date + '&page=' + page);
      const d = await res.json();
      const body = document.getElementById('traffic-body');
      if (d.rows.length === 0) { body.innerHTML = '<tr><td colspan="4" class="py-6 px-4 text-gray-600 text-xs text-center">è¯¥æ—¥æš‚æ— æµé‡æ•°æ®</td></tr>'; }
      else { body.innerHTML = d.rows.map(u => `<tr class="border-b border-white/5"><td class="py-2 px-4 text-xs">${u.username}</td><td class="py-2 px-4 text-xs">${fmtBytes(u.total_up)}</td><td class="py-2 px-4 text-xs">${fmtBytes(u.total_down)}</td><td class="py-2 px-4 text-xs font-medium text-white">${fmtBytes(u.total_up+u.total_down)}</td></tr>`).join(''); }
      document.getElementById('traffic-info').textContent = `å…± ${d.total} äºº`;
      const pager = document.getElementById('traffic-pager'); pager.innerHTML = '';
      for (let i=1;i<=d.pages;i++) { const btn=document.createElement('button'); btn.textContent=i; btn.className='text-xs px-2 py-1 rounded '+(i===d.page?'bg-rose-600 text-white':'glass text-gray-400 hover:text-white'); btn.onclick=()=>loadTraffic(i); pager.appendChild(btn); }
    }

    async function loadLogs(page) {
      const res = await fetch('/admin/api/logs?page=' + page);
      const d = await res.json();
      document.getElementById('log-body').innerHTML = d.rows.map(l =>
        `<tr class="border-b border-white/5"><td class="py-2 px-4 text-xs text-gray-500">${l.created_at}</td><td class="py-2 px-4 text-xs">${l.username||'-'}</td><td class="py-2 px-4 text-xs">${l.action}</td><td class="py-2 px-4 text-xs text-gray-500 max-w-xs truncate">${l.detail||''}</td></tr>`
      ).join('');
      document.getElementById('log-info').textContent = `å…± ${d.total} æ¡`;
      const pager = document.getElementById('log-pager');
      pager.innerHTML = '';
      for (let i = 1; i <= d.pages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'text-xs px-2 py-1 rounded ' + (i===d.page ? 'bg-rose-600 text-white' : 'glass text-gray-400 hover:text-white');
        btn.onclick = () => loadLogs(i);
        pager.appendChild(btn);
      }
    }
    async function clearLogs() {
      if (!await _confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ—¥å¿—ï¼Ÿ')) return;
      await fetch('/admin/api/logs/clear', { method:'POST', headers:{'Content-Type':'application/json'} });
      loadLogs(1);
    }

    async function saveOpsAi() {
      const data = { type: document.getElementById('ops-type').value, endpoint: document.getElementById('ops-endpoint').value.trim(), key: document.getElementById('ops-key').value.trim(), model: document.getElementById('ops-model').value.trim() };
      await fetch('/admin/api/ops/ai-config', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
      document.getElementById('ops-key').value = '';
      showToast('âœ… è¿ç»´ AI å·²ä¿å­˜');
      loadOpsConfig();
    }
    async function loadOpsConfig() {
      const res = await fetch('/admin/api/ops/ai-config');
      const cfg = await res.json();
      document.getElementById('ops-type').value = cfg.type || 'openai';
      document.getElementById('ops-endpoint').value = cfg.endpoint || '';
      document.getElementById('ops-model').value = cfg.model || '';
      document.getElementById('ops-key').placeholder = cfg.configured ? 'API Keyï¼ˆå·²é…ç½®ï¼Œç•™ç©ºä¿ç•™ï¼‰' : 'API Key';
      document.getElementById('ops-ai-status').textContent = cfg.configured ? 'âœ… å·²é…ç½®' : 'æœªé…ç½®';
      document.getElementById('ops-ai-status').className = 'text-xs px-2 py-0.5 rounded-full ' + (cfg.configured ? 'bg-emerald-500/20 text-emerald-300' : 'bg-gray-500/20 text-gray-400');
    }
    async function clearOps() {
      if (!await _confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¯Šæ–­è®°å½•ï¼Ÿ')) return;
      await fetch('/admin/api/ops/clear', { method:'POST', headers:{'Content-Type':'application/json'} });
      loadOps();
    }
    async function manualDiagnose() {
      const id = document.getElementById('ops-node-select').value;
      if (!id) return;
      const btn = event.target;
      btn.disabled = true; btn.textContent = 'â³ è¯Šæ–­ä¸­...'; btn.classList.add('opacity-50');
      const res = await fetch('/admin/api/ops/'+id+'/diagnose', { method:'POST', headers:{'Content-Type':'application/json'} });
      const d = await res.json();
      if (d.ok) { showToast('ğŸ” è¯Šæ–­å·²è§¦å‘ï¼ŒAI åˆ†æä¸­...'); setTimeout(() => loadOps(), 5000); }
      else showToast('âŒ ' + d.error);
      setTimeout(() => { btn.disabled = false; btn.textContent = 'ğŸ” æ‰‹åŠ¨è¯Šæ–­'; btn.classList.remove('opacity-50'); }, 3000);
    }
    async function loadOps() {
      loadOpsConfig();
      const listRes = await fetch('/admin/api/ops/list');
      const list = await listRes.json();
      const container = document.getElementById('ops-list');
      if (list.length === 0) { container.innerHTML = '<p class="text-gray-600 text-sm text-center py-4">æš‚æ— è¯Šæ–­è®°å½•</p>'; return; }
      container.innerHTML = list.map(d => {
        const cmds = d.fix_commands ? JSON.parse(d.fix_commands) : [];
        const statusMap = {pending:'â³ å¾…åˆ†æ',analyzed:'ğŸ” å¾…ç¡®è®¤',no_ai:'âš ï¸ AIä¸å¯ç”¨',fixed:'âœ… å·²ä¿®å¤',dismissed:'ğŸš« å·²å¿½ç•¥'};
        return `<div class="mb-3 p-4 rounded-xl bg-black/20 border border-white/5">
          <div class="flex items-center justify-between mb-2">
            <div><span class="text-white text-sm font-medium">${d.node_name}</span> <span class="text-gray-500 text-xs">${d.host}</span></div>
            <div class="flex items-center gap-2">
              <span class="text-xs ${d.status==='fixed'?'text-emerald-400':d.status==='analyzed'?'text-amber-400':'text-gray-500'}">${statusMap[d.status]||d.status}</span>
              <span class="text-gray-600 text-xs">${d.created_at}</span>
            </div>
          </div>
          ${d.ai_analysis ? `<div class="mb-2"><p class="text-gray-500 text-xs mb-1">AI åˆ†æï¼š</p><p class="text-gray-300 text-xs whitespace-pre-wrap">${d.ai_analysis}</p></div>` : ''}
          ${cmds.length ? `<div class="mb-2"><p class="text-gray-500 text-xs mb-1">ä¿®å¤å‘½ä»¤ï¼š</p><pre class="text-xs text-amber-300/80 bg-black/30 p-2 rounded-lg overflow-x-auto">${cmds.join('\\n')}</pre></div>` : ''}
          ${d.fix_result ? `<div class="mb-2"><p class="text-gray-500 text-xs mb-1">æ‰§è¡Œç»“æœï¼š</p><pre class="text-xs text-gray-400 bg-black/30 p-2 rounded-lg overflow-x-auto max-h-32">${d.fix_result}</pre></div>` : ''}
          ${d.diag_info ? `<details class="mb-2"><summary class="text-gray-600 text-xs cursor-pointer hover:text-gray-400">ğŸ“„ æŸ¥çœ‹è¯Šæ–­æ—¥å¿—</summary><pre class="text-xs text-gray-500 bg-black/30 p-2 rounded-lg overflow-x-auto max-h-48 mt-1">${d.diag_info}</pre></details>` : ''}
          ${d.status==='analyzed' ? `<div class="flex gap-2 mt-2"><button onclick="execFix(${d.id})" class="bg-rose-600 hover:bg-rose-500 text-white text-xs px-3 py-1.5 rounded-lg transition">æ‰§è¡Œä¿®å¤</button><button onclick="dismissFix(${d.id})" class="glass text-gray-400 hover:text-white text-xs px-3 py-1.5 rounded-lg transition">å¿½ç•¥</button></div>` : ''}
        </div>`;
      }).join('');
    }
    async function execFix(id) {
      if (!confirm('ç¡®è®¤æ‰§è¡Œ AI ç”Ÿæˆçš„ä¿®å¤å‘½ä»¤ï¼Ÿ')) return;
      const res = await fetch('/admin/api/ops/'+id+'/execute', { method:'POST', headers:{'Content-Type':'application/json'} });
      const d = await res.json();
      if (d.ok) { showToast('âœ… ä¿®å¤å‘½ä»¤å·²æ‰§è¡Œ'); loadOps(); } else showToast('âŒ '+d.error);
    }
    async function dismissFix(id) {
      await fetch('/admin/api/ops/'+id+'/dismiss', { method:'POST', headers:{'Content-Type':'application/json'} });
      loadOps();
    }

    async function checkAbuse() {
      const hours = document.getElementById('abuse-hours').value;
      const min = hours === '24' ? 20 : 100;
      const container = document.getElementById('abuse-result');
      container.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">æ£€æµ‹ä¸­...</p>';
      try {
        const res = await fetch('/admin/api/sub-abuse?hours=' + hours + '&min=' + min);
        const data = await res.json();
        if (data.length === 0) {
          container.innerHTML = '<p class="text-emerald-400 text-sm text-center py-4">âœ… æœªå‘ç°å¼‚å¸¸ï¼Œæ‰€æœ‰ç”¨æˆ·è®¢é˜…æ‹‰å–æ­£å¸¸</p>';
          return;
        }
        container.innerHTML = '<div class="space-y-2">' + data.map(u =>
          '<div class="flex items-center justify-between p-3 rounded-xl bg-black/20 cursor-pointer hover:bg-white/5 transition" onclick="showDetail(' + u.user_id + ',' + hours + ')">' +
          '<div><span class="text-white text-sm">' + u.username + '</span><span class="text-gray-500 text-xs ml-2">ID:' + u.user_id + '</span></div>' +
          '<span class="text-xs px-2 py-0.5 rounded-full ' + (u.ip_count >= 5 ? 'bg-red-500/20 text-red-300' : 'bg-amber-500/20 text-amber-300') + '">' + u.ip_count + ' ä¸ª IP</span>' +
          '</div>'
        ).join('') + '</div>';
      } catch(e) { container.innerHTML = '<p class="text-red-400 text-sm">æ£€æµ‹å¤±è´¥</p>'; }
    }

    async function showDetail(userId, hours) {
      const panel = document.getElementById('abuse-detail-panel');
      const container = document.getElementById('abuse-detail');
      panel.classList.remove('hidden');
      container.innerHTML = '<p class="text-gray-500 text-xs">åŠ è½½ä¸­...</p>';
      const res = await fetch('/admin/api/sub-access/' + userId + '?hours=' + hours);
      const ips = await res.json();
      container.innerHTML = '<div class="space-y-1">' + ips.map(ip =>
        '<div class="flex items-center justify-between p-2 rounded-lg bg-black/20 text-xs">' +
        '<span class="text-gray-300 font-mono">' + ip.ip + '</span>' +
        '<div class="flex gap-3"><span class="text-gray-500">æ‹‰å– ' + ip.count + ' æ¬¡</span><span class="text-gray-600">' + ip.last_access + '</span></div>' +
        '</div>'
      ).join('') + '</div>';
    }

    async function askAI() {
      const input = document.getElementById('ai-input'), btn = document.getElementById('ai-btn'), resp = document.getElementById('ai-response');
      const provider = document.getElementById('admin-ai-model')?.value || '';
      const message = input.value.trim();
      if (!message || !provider) return;
      btn.disabled = true; btn.textContent = 'â³'; resp.classList.remove('hidden'); resp.textContent = ''; input.value = '';
      try {
        const evtSource = new EventSource('/panel/ai/chat/stream?message=' + encodeURIComponent(message) + '&provider=' + provider);
        evtSource.onmessage = (e) => {
          if (e.data === '[DONE]') { evtSource.close(); btn.disabled = false; btn.textContent = 'æé—®'; return; }
          try { const data = JSON.parse(e.data); if (data.error) { resp.textContent += data.error; evtSource.close(); btn.disabled = false; btn.textContent = 'æé—®'; return; } if (data.text) resp.textContent += data.text; resp.scrollTop = resp.scrollHeight; } catch {}
        };
        evtSource.onerror = () => { evtSource.close(); if (!resp.textContent) resp.textContent = 'è¿æ¥å¤±è´¥'; btn.disabled = false; btn.textContent = 'æé—®'; };
      } catch (e) { resp.textContent = 'è¯·æ±‚å¤±è´¥'; btn.disabled = false; btn.textContent = 'æé—®'; }
    }
  </script>
<%- include('partials/foot') %>
