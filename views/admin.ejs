<%- include('partials/head', { title: 'ç®¡ç†åå°' }) %>

  <!-- å¯¼èˆª -->
  <nav class="glass-solid sticky top-0 z-40 px-6 py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-sm">ğŸ‘</div>
        <span class="text-white font-semibold hidden sm:block">å°å§¨å­ã®åå°</span>
      </div>
      <div class="flex items-center gap-3">
        <a href="/" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-white transition">è¿”å›é¢æ¿</a>
        <a href="/auth/logout" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-red-400 transition">é€€å‡º</a>
      </div>
    </div>
  </nav>

  <!-- Tab å¯¼èˆª -->
  <div class="max-w-6xl mx-auto px-4 sm:px-6 pt-6">
    <div class="sm:hidden mb-2">
      <label class="text-[11px] text-gray-500 block mb-1">å¿«é€Ÿåˆ‡æ¢åŠŸèƒ½</label>
      <select id="tab-select" onchange="switchTab(this.value)" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        <option value="nodes">ğŸŒ èŠ‚ç‚¹</option>
        <option value="users">ğŸ‘¥ ç”¨æˆ·</option>
        <option value="traffic">ğŸ“Š æµé‡</option>
        <option value="whitelist">ğŸ”’ ç™½åå•</option>
        <option value="logs">ğŸ“‹ æ—¥å¿—</option>
        <option value="abuse">ğŸ“ˆ è®¢é˜…ç»Ÿè®¡</option>
        <option value="notify">ğŸ”” é€šçŸ¥</option>
        <option value="aws">â˜ï¸ AWS</option>
        <option value="ops">ğŸ§  è¿ç»´</option>
        <option value="diary">ğŸ“” è¿è¥æ—¥è®°</option>
        <option value="docs">ğŸ“– ä½¿ç”¨è¯´æ˜</option>
        <option value="backup">ğŸ’¾ å¤‡ä»½</option>
      </select>
    </div>
    <div class="relative">
      <div class="flex gap-1 glass-solid rounded-2xl p-1.5 overflow-x-auto scrollbar-hide tab-bar" style="-webkit-overflow-scrolling:touch">
        <button onclick="switchTab('nodes')" class="tab-btn active text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="nodes">ğŸŒ èŠ‚ç‚¹</button>
        <button onclick="switchTab('users')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="users">ğŸ‘¥ ç”¨æˆ·</button>
        <button onclick="switchTab('traffic')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="traffic">ğŸ“Š æµé‡</button>
        <button onclick="switchTab('whitelist')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="whitelist">ğŸ”’ ç™½åå•</button>
        <button onclick="switchTab('logs')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="logs">ğŸ“‹ æ—¥å¿—</button>
        <button onclick="switchTab('notify')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="notify">ğŸ”” é€šçŸ¥</button>
        <button onclick="switchTab('abuse')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="abuse">ğŸ“ˆ è®¢é˜…</button>
        <button onclick="switchTab('aws')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="aws">â˜ï¸ AWS</button>
        <button onclick="switchTab('ops')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="ops">ğŸ§  è¿ç»´</button>
        <button onclick="switchTab('backup')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="backup">ğŸ’¾ å¤‡ä»½</button>
        <button onclick="switchTab('diary')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="diary">ğŸ“” æ—¥è®°</button>
        <button onclick="switchTab('docs')" class="tab-btn text-sm px-3 sm:px-4 py-2 rounded-xl transition whitespace-nowrap" data-tab="docs">ğŸ“– è¯´æ˜</button>
      </div>
      <div class="tab-fade-right pointer-events-none absolute right-0 top-0 bottom-0 w-12 rounded-r-2xl" style="background:linear-gradient(to right, transparent, rgba(15,11,30,0.95))"></div>
      <div class="sm:hidden text-[10px] text-gray-600 mt-1 text-right">å¯å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šåŠŸèƒ½</div>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6">
    <%- include('partials/admin-nodes') %>
    <%- include('partials/admin-sections') %>
    <%- include('partials/admin-traffic') %>
    <%- include('partials/admin-ops') %>
    <%- include('partials/admin-diary') %>
    <%- include('partials/admin-docs') %>
    <%- include('partials/admin-backup') %>
  </main>

  <style>
    .tab-btn{color:#9ca3af}.tab-btn:hover{color:#fff;background:rgba(255,255,255,0.05)}
    .tab-btn.active{color:#fff;background:rgba(244,63,94,0.2);font-weight:500}
    .tab-panel{display:none}.tab-panel.active{display:block}
  </style>
  <script>
    function showToast(msg, ms) { toast(msg, ms); }
    function switchTab(name) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.dataset.tab === name));
      const sel = document.getElementById('tab-select');
      if (sel) sel.value = name;
      location.hash = name;
      if (name === 'aws') { loadAwsConfig(); }
      if (name === 'ops') { loadOpsConfig(); }
      if (name === 'diary') { loadDiary(1); }
      if (name === 'logs') loadLogs(1);
      if (name === 'abuse') loadSubStats(1);
      if (name === 'users') loadUsers(1);
      if (name === 'traffic') loadTraffic(1);
      if (name === 'backup') loadBackups();
    }
    if (location.hash.slice(1)) switchTab(location.hash.slice(1));

    // Tab æ»šåŠ¨æ¸éšæç¤º
    (function() {
      const bar = document.querySelector('.tab-bar');
      const fade = document.querySelector('.tab-fade-right');
      if (bar && fade) {
        function checkFade() {
          const atEnd = bar.scrollLeft + bar.clientWidth >= bar.scrollWidth - 10;
          fade.style.opacity = atEnd ? '0' : '1';
        }
        bar.addEventListener('scroll', checkFade);
        checkFade();
        // åˆ‡æ¢tabæ—¶æ»šåŠ¨åˆ°å¯è§
        const origSwitch = window.switchTab;
        window.switchTab = function(name) {
          origSwitch(name);
          const btn = bar.querySelector('[data-tab="'+name+'"]');
          if (btn) btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
          setTimeout(checkFade, 300);
        };
      }
    })();
    const _msg = new URLSearchParams(location.search).get('msg');
    if (_msg) { const m = {deploying:'ğŸš€ éƒ¨ç½²ä¸­ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹',added:'âœ… èŠ‚ç‚¹å·²æ·»åŠ ',dup:'âš ï¸ IP å·²å­˜åœ¨'}; if (m[_msg]) showToast(m[_msg]); history.replaceState(null,'',location.pathname+location.hash); }

    function toggleEdit(id) {
      document.getElementById('host-display-' + id).classList.toggle('hidden');
      document.getElementById('host-form-' + id).classList.toggle('hidden');
    }

    function updateNodeLevel(id, level) {
      fetch('/admin/api/nodes/' + id + '/update-level', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ level })
      }).then(r => r.json()).then(d => { if (d.ok) showToast('ç­‰çº§å·²æ›´æ–°ï¼ŒèŠ‚ç‚¹é…ç½®åŒæ­¥ä¸­'); });
    }


    async function saveAnnouncement() {
      const text = document.getElementById('announcement-text').value.trim();
      await fetch('/admin/api/announcement', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text}) });
      showToast(text ? 'âœ… å…¬å‘Šå·²æ›´æ–°' : 'âœ… å…¬å‘Šå·²æ¸…é™¤');
    }
    async function saveMaxUsers() {
      const max = parseInt(document.getElementById('max-users-input').value) || 0;
      const res = await fetch('/admin/api/max-users', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({max}) });
      if (res.ok) showToast(max > 0 ? 'âœ… æ³¨å†Œä¸Šé™å·²è®¾ä¸º ' + max + ' äºº' : 'âœ… å·²å–æ¶ˆæ³¨å†Œé™åˆ¶');
      else showToast('âŒ ä¿å­˜å¤±è´¥');
    }

    // ========== AWS ==========
    window._awsAccounts = [];
    async function loadAwsConfig() {
      const res = await fetch('/admin/api/aws/config');
      const cfg = await res.json();
      window._awsAccounts = cfg.accounts || [];
      const el = document.getElementById('aws-status');
      const list = document.getElementById('aws-accounts');
      const bindSel = document.getElementById('bind-account-id');

      if (cfg.configured) {
        el.textContent = `âœ… ${cfg.count} ä¸ªè´¦å·`;
        el.className = 'text-xs px-2 py-0.5 rounded-full bg-white/10 text-gray-300';
      } else {
        el.textContent = 'æœªé…ç½®';
        el.className = 'text-xs px-2 py-0.5 rounded-full bg-gray-500/20 text-gray-400';
      }

      list.innerHTML = (cfg.accounts || []).map(a =>
        `<div class="flex items-center justify-between rounded-xl bg-black/20 border border-white/5 px-3 py-2.5">
          <div class="min-w-0">
            <div class="text-xs text-white font-medium truncate">#${a.id} ${a.name}</div>
            <div class="text-[11px] text-gray-500 mt-0.5 truncate">${a.accessKeyMasked}${a.socks5_host ? ' Â· SOCKS ' + a.socks5_host + ':' + a.socks5_port : ''}</div>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" class="text-gray-300 hover:text-white text-xs px-2 py-1 rounded-lg bg-white/5 border border-white/10" onclick="editAwsAccount(${a.id})">ç¼–è¾‘</button>
            <button type="button" class="text-red-400 hover:text-red-300 text-xs px-2 py-1 rounded-lg bg-red-500/10 border border-red-500/20" onclick="deleteAwsAccount(${a.id})">åˆ é™¤</button>
          </div>
        </div>`
      ).join('') || '<p class="text-gray-500 text-xs">æš‚æ—  AWS è´¦å·</p>';

      bindSel.innerHTML = (cfg.accounts || []).map(a => `<option value="${a.id}">#${a.id} ${a.name}</option>`).join('');
    }

    async function saveAwsConfig() {
      const name = document.getElementById('aws-name').value.trim();
      const ak = document.getElementById('aws-ak').value.trim();
      const sk = document.getElementById('aws-sk').value.trim();
      const socks5Url = document.getElementById('aws-socks-url').value.trim();

      if (!name) { toast('è¯·å¡«å†™è´¦å·å', 2500, 'error'); return; }
      if (!ak) { toast('è¯·å¡«å†™ Access Key', 2500, 'error'); return; }
      if (!sk) { toast('è¯·å¡«å†™ Secret Key', 2500, 'error'); return; }

      const res = await fetch('/admin/api/aws/config', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ name, accessKey:ak, secretKey:sk, socks5Url })
      });

      if (res.ok) {
        showToast('âœ… AWS è´¦å·å·²æ–°å¢');
        ['aws-name','aws-ak','aws-sk','aws-socks-url'].forEach(id => document.getElementById(id).value='');
        document.getElementById('aws-socks-test-result').textContent = '';
        loadAwsConfig();
      } else {
        const d = await res.json().catch(() => ({}));
        showToast('âŒ ' + (d.error || 'ä¿å­˜å¤±è´¥'));
      }
    }

    async function testSocksProxyInput(inputId, resultId) {
      const socks5Url = document.getElementById(inputId).value.trim();
      const resultEl = document.getElementById(resultId);
      if (!socks5Url) { showToast('è¯·å…ˆå¡«å†™ SOCKS5 URL'); return; }
      resultEl.textContent = 'éªŒè¯ä¸­...';
      const res = await fetch('/admin/api/aws/socks-test', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ socks5Url })
      });
      const d = await res.json().catch(() => ({}));
      if (res.ok && d.ok) {
        resultEl.textContent = `âœ… ä»£ç†å¯ç”¨ï¼Œå‡ºå£ IP: ${d.ip}`;
        resultEl.className = 'text-[11px] text-emerald-400 mt-1';
      } else {
        resultEl.textContent = `âŒ éªŒè¯å¤±è´¥: ${d.error || 'æœªçŸ¥é”™è¯¯'}`;
        resultEl.className = 'text-[11px] text-red-400 mt-1';
      }
    }
    async function testSocksProxy() {
      return testSocksProxyInput('aws-socks-url', 'aws-socks-test-result');
    }

    async function deleteAwsAccount(id) {
      if (!await _confirm('ç¡®å®šåˆ é™¤è¯¥ AWS è´¦å·ï¼Ÿ')) return;
      const res = await fetch('/admin/api/aws/config/' + id, { method:'DELETE', headers:{'Content-Type':'application/json'} });
      if (res.ok) { showToast('âœ… å·²åˆ é™¤è´¦å·'); loadAwsConfig(); }
      else showToast('âŒ åˆ é™¤å¤±è´¥');
    }

    function editAwsAccount(id) {
      const a = (window._awsAccounts || []).find(x => x.id === id);
      if (!a) { showToast('è´¦å·ä¸å­˜åœ¨'); return; }

      document.getElementById('edit-aws-id').value = id;
      document.getElementById('edit-aws-name').value = a.name || '';
      document.getElementById('edit-aws-ak').value = a.accessKeyMasked || '';
      document.getElementById('edit-aws-socks').value = a.socks5_host ? `socks5://${a.socks5_host}:${a.socks5_port || 1080}` : '';
      document.getElementById('edit-aws-socks-test').textContent = '';
      document.getElementById('aws-edit-modal').classList.remove('hidden');
    }

    function closeAwsEditModal() {
      document.getElementById('aws-edit-modal').classList.add('hidden');
    }

    async function saveAwsEdit() {
      const id = parseInt(document.getElementById('edit-aws-id').value);
      const name = document.getElementById('edit-aws-name').value.trim();
      const socks5Url = document.getElementById('edit-aws-socks').value.trim();
      if (!id) { showToast('å‚æ•°é”™è¯¯'); return; }
      if (!name) { showToast('è´¦å·åä¸èƒ½ä¸ºç©º'); return; }

      const res = await fetch('/admin/api/aws/config/' + id, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, socks5Url })
      });
      const d = await res.json().catch(() => ({}));
      if (res.ok) {
        showToast('âœ… è´¦å·å·²æ›´æ–°');
        closeAwsEditModal();
        loadAwsConfig();
      } else {
        showToast('âŒ ' + (d.error || 'æ›´æ–°å¤±è´¥'));
      }
    }

    function showBindAws(nodeId) {
      document.getElementById('bind-node-id').value = nodeId;
      if (!window._awsAccounts || window._awsAccounts.length === 0) { showToast('è¯·å…ˆæ–°å¢ AWS è´¦å·'); return; }
      document.getElementById('aws-bind-modal').classList.remove('hidden');
    }

    async function confirmBindAws() {
      const nodeId = document.getElementById('bind-node-id').value;
      const data = {
        aws_account_id: parseInt(document.getElementById('bind-account-id').value),
        aws_instance_id: document.getElementById('bind-instance-id').value.trim(),
        aws_type: document.getElementById('bind-type').value,
        aws_region: document.getElementById('bind-region').value || null
      };
      if (!data.aws_account_id) { showToast('è¯·é€‰æ‹© AWS è´¦å·'); return; }
      if (!data.aws_instance_id) { showToast('è¯·å¡«å†™å®ä¾‹ ID'); return; }
      const res = await fetch('/admin/api/nodes/' + nodeId + '/aws-bind', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
      if (res.ok) { showToast('âœ… å·²ç»‘å®š'); document.getElementById('aws-bind-modal').classList.add('hidden'); location.hash='aws'; location.reload(); }
      else showToast('âŒ ç»‘å®šå¤±è´¥');
    }
    async function unbindAws(nodeId) {
      if (!await _confirm('ç¡®å®šè§£ç»‘ï¼Ÿ')) return;
      const res = await fetch('/admin/api/nodes/' + nodeId + '/aws-bind', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({aws_instance_id:null, aws_type:null, aws_region:null, aws_account_id:null}) });
      if (res.ok) { showToast('âœ… å·²è§£ç»‘'); location.hash='aws'; location.reload(); }
    }
    async function swapNodeIp(nodeId, nodeName, btn) {
      if (!await _confirm('ç¡®å®šç»™ ' + nodeName + ' æ¢ IPï¼Ÿå°†é‡Šæ”¾æ—§ IP å¹¶åˆ†é…æ–° IP')) return;
      const done = btnLoading(btn, 'ğŸ”„ æ¢IPä¸­...');
      try {
        const res = await fetch('/admin/api/nodes/' + nodeId + '/swap-ip', { method:'POST', headers:{'Content-Type':'application/json'} });
        const data = await res.json();
        if (data.success) { toast('âœ… æ¢ IP æˆåŠŸ: ' + data.newIp); setTimeout(() => { location.hash='aws'; location.reload(); }, 1500); }
        else toast('âŒ ' + (data.error || 'æ¢ IP å¤±è´¥'), 3000, 'error');
      } catch(e) { toast('âŒ ç½‘ç»œé”™è¯¯', 3000, 'error'); }
      done();
    }
    // åˆå§‹åŒ– AWS é…ç½®çŠ¶æ€
    if (location.hash === '#aws') setTimeout(() => { loadAwsConfig(); }, 100);
    if (location.hash === '#logs') setTimeout(() => loadLogs(1), 100);

    // ========== å®ä¾‹ä»ªè¡¨ç›˜ ==========
    async function loadAllInstances(force = false) {
      const loading = document.getElementById('aws-instances-loading');
      const container = document.getElementById('aws-instances-container');
      loading.classList.remove('hidden');
      container.classList.add('hidden');

      try {
        const res = await fetch('/admin/api/aws/all-instances' + (force ? '?force=1' : ''));
        const accounts = await res.json();
        if (!res.ok) throw new Error(accounts.error || 'åŠ è½½å¤±è´¥');

        let html = '';
        for (const acc of accounts) {
          if (acc.instances.length === 0) continue;
          html += `<div class="mb-3"><div class="text-xs text-gray-400 mb-2 font-medium">ğŸ“¦ ${acc.accountName} (#${acc.accountId})</div><div class="space-y-1.5">`;
          for (const inst of acc.instances) {
            const isBlocked = inst.boundNode && (inst.boundNode.remark?.includes('è¢«å¢™') || inst.boundNode.remark?.includes('ç¦»çº¿') || !inst.boundNode.is_active);
            const stateColor = inst.state === 'running' ? 'text-emerald-400' : inst.state === 'stopped' ? 'text-gray-500' : 'text-yellow-400';
            const stateDot = inst.state === 'running' ? 'bg-emerald-400' : inst.state === 'stopped' ? 'bg-gray-500' : 'bg-yellow-400';
            const rowBg = isBlocked ? 'bg-red-500/10 border border-red-500/20' : 'bg-black/20';

            html += `<div class="p-2.5 rounded-xl ${rowBg} space-y-2">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="inline-block w-2 h-2 rounded-full ${stateDot} flex-shrink-0"></span>
                <span class="text-xs text-white font-medium">${inst.name || inst.instanceId}</span>
                <span class="text-[10px] ${stateColor}">${inst.state}</span>
                <span class="text-[10px] text-gray-600">${inst.region}</span>
                <span class="text-[10px] px-1 py-0.5 rounded ${inst.instanceType === 'lightsail' ? 'bg-purple-500/20 text-purple-300' : 'bg-sky-500/20 text-sky-300'}">${inst.instanceType}</span>
              </div>
              <div class="flex items-center gap-2 flex-wrap text-[10px]">
                ${inst.publicIp ? `<span class="text-blue-300 font-mono">${inst.publicIp}</span>` : ''}
                ${inst.boundNode ? `<span class="px-1 py-0.5 rounded bg-emerald-500/20 text-emerald-300">ğŸ”— ${inst.boundNode.name}</span>` : ''}
                ${isBlocked ? '<span class="px-1 py-0.5 rounded bg-red-500/30 text-red-300">âš ï¸ å¼‚å¸¸</span>' : ''}
              </div>
              <div class="flex items-center gap-1 flex-wrap">
                ${inst.state === 'stopped' ? `<button onclick="awsInstanceAction('start','${inst.instanceId}','${inst.instanceType}','${inst.region}',${inst.accountId})" class="text-[10px] px-2 py-1 rounded-lg bg-emerald-500/20 text-emerald-300 hover:bg-emerald-500/30">â–¶ å¼€æœº</button>` : ''}
                ${inst.state === 'running' ? `<button onclick="awsInstanceAction('stop','${inst.instanceId}','${inst.instanceType}','${inst.region}',${inst.accountId})" class="text-[10px] px-2 py-1 rounded-lg bg-gray-500/20 text-gray-300 hover:bg-gray-500/30">â¹ å…³æœº</button>` : ''}
                ${inst.state === 'running' ? `<button onclick="awsInstanceAction('swap-ip','${inst.instanceId}','${inst.instanceType}','${inst.region}',${inst.accountId})" class="text-[10px] px-2 py-1 rounded-lg ${isBlocked ? 'bg-red-500/30 text-red-200 hover:bg-red-500/40 font-medium' : 'bg-amber-500/20 text-amber-300 hover:bg-amber-500/30'}">ğŸ”„ æ¢IP</button>` : ''}
                <button onclick="awsInstanceAction('terminate','${inst.instanceId}','${inst.instanceType}','${inst.region}',${inst.accountId})" class="text-[10px] px-2 py-1 rounded-lg bg-red-500/20 text-red-300 hover:bg-red-500/30">ğŸ—‘ ç»ˆæ­¢</button>
              </div>
            </div>`;
          }
          html += '</div></div>';
        }

        if (!html) html = '<p class="text-gray-500 text-xs text-center py-4">æš‚æ— å®ä¾‹</p>';
        container.innerHTML = html;
        loading.classList.add('hidden');
        container.classList.remove('hidden');
      } catch (e) {
        loading.textContent = 'âŒ ' + e.message;
      }
    }

    async function awsInstanceAction(action, instanceId, type, region, accountId) {
      const actionNames = { start: 'å¼€æœº', stop: 'å…³æœº', terminate: 'ç»ˆæ­¢', 'swap-ip': 'æ¢ IP' };
      if (action === 'terminate') {
        if (!await _confirm(`ç¡®å®šç»ˆæ­¢å®ä¾‹ ${instanceId}ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      } else if (action === 'swap-ip') {
        if (!await _confirm(`ç¡®å®šç»™ ${instanceId} æ¢ IPï¼Ÿ`)) return;
      }
      showToast(`â³ ${actionNames[action]}ä¸­...`);
      try {
        const res = await fetch('/admin/api/aws/' + action, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ instanceId, type, region, accountId })
        });
        const data = await res.json();
        if (res.ok && (data.ok || data.success)) {
          showToast(`âœ… ${actionNames[action]}æˆåŠŸ` + (data.newIp ? ` æ–°IP: ${data.newIp}` : ''));
          setTimeout(() => loadAllInstances(true), 2000);
        } else {
          showToast(`âŒ ${data.error || 'æ“ä½œå¤±è´¥'}`);
        }
      } catch (e) {
        showToast('âŒ ç½‘ç»œé”™è¯¯');
      }
    }

    // ========== æ–°å»ºå®ä¾‹ ==========
    function showLaunchModal() {
      if (!window._awsAccounts || window._awsAccounts.length === 0) { showToast('è¯·å…ˆæ–°å¢ AWS è´¦å·'); return; }
      const sel = document.getElementById('launch-account-id');
      sel.innerHTML = window._awsAccounts.map(a => `<option value="${a.id}">#${a.id} ${a.name}</option>`).join('');
      updateLaunchSpecs();
      document.getElementById('aws-launch-modal').classList.remove('hidden');
    }

    function updateLaunchSpecs() {
      const type = document.getElementById('launch-type').value;
      const sel = document.getElementById('launch-spec');
      if (type === 'lightsail') {
        sel.innerHTML = '<option value="nano_3_0">nano (512MB/$3.5)</option><option value="micro_3_0">micro (1GB/$5)</option><option value="small_3_0">small (2GB/$10)</option><option value="medium_3_0">medium (4GB/$20)</option>';
      } else {
        sel.innerHTML = '<option value="t4g.micro">t4g.micro (1C/1G)</option><option value="t4g.small">t4g.small (2C/2G)</option><option value="t4g.medium">t4g.medium (2C/4G)</option>';
      }
    }

    async function confirmLaunch() {
      const accountId = document.getElementById('launch-account-id').value;
      const region = document.getElementById('launch-region').value;
      const type = document.getElementById('launch-type').value;
      const spec = document.getElementById('launch-spec').value;
      const sshPassword = document.getElementById('launch-ssh-password').value;
      if (!sshPassword) { showToast('è¯·å¡«å†™ SSH å¯†ç '); return; }

      const btn = document.getElementById('launch-btn');
      btn.disabled = true; btn.textContent = 'â³ åˆ›å»ºä¸­...';

      try {
        const res = await fetch('/admin/api/aws/launch-and-deploy', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId: parseInt(accountId), region, type, spec, sshPassword })
        });
        const data = await res.json();
        if (res.ok) {
          showToast('ğŸš€ æ­£åœ¨åå°åˆ›å»ºå¹¶éƒ¨ç½²ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹');
          document.getElementById('aws-launch-modal').classList.add('hidden');
        } else {
          showToast('âŒ ' + (data.error || 'åˆ›å»ºå¤±è´¥'));
        }
      } catch (e) {
        showToast('âŒ ç½‘ç»œé”™è¯¯');
      }
      btn.disabled = false; btn.textContent = 'ğŸš€ åˆ›å»ºå¹¶éƒ¨ç½²';
    }

    async function setTrafficLimit(userId, username, currentLimit) {
      const currentTB = currentLimit ? (currentLimit / 1099511627776).toFixed(2) : '0';
      const input = await _prompt(`è®¾ç½® ${username} çš„æµé‡é™é¢`, { value: currentTB, placeholder: '0 = æ— é™', hint: 'å•ä½ï¼šTBï¼Œ0 = æ— é™' });
      if (input === null) return;
      const limitTB = parseFloat(input) || 0;
      const limitGB = limitTB * 1024;
      const res = await fetch('/admin/api/users/' + userId + '/traffic-limit', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ limit: limitGB })
      });
      if (res.ok) { showToast(limitTB > 0 ? `âœ… å·²è®¾ä¸º ${limitTB} TB` : 'âœ… å·²è®¾ä¸ºæ— é™'); setTimeout(() => location.reload(), 500); }
      else showToast('âŒ è®¾ç½®å¤±è´¥');
    }

    async function setExpiry(userId, username, currentExpiry) {
      const input = await _prompt(`è®¾ç½® ${username} çš„åˆ°æœŸæ—¶é—´`, { value: currentExpiry ? currentExpiry.slice(0,10) : '', placeholder: 'YYYY-MM-DDï¼ˆç•™ç©º=æ°¸ä¸è¿‡æœŸï¼‰', hint: 'æ ¼å¼ï¼š2025-12-31ï¼Œç•™ç©ºåˆ™æ°¸ä¸è¿‡æœŸ' });
      if (input === null) return;
      const expires_at = input.trim() ? input.trim() + 'T23:59:59Z' : '';
      const res = await fetch('/admin/api/users/' + userId + '/set-expiry', {
        method: 'POST', headers: {'Content-Type':'application/json', 'X-CSRF-Token': _csrf },
        body: JSON.stringify({ expires_at })
      });
      if (res.ok) { showToast(input.trim() ? `âœ… å·²è®¾ä¸º ${input.trim()}` : 'âœ… å·²è®¾ä¸ºæ°¸ä¸è¿‡æœŸ'); loadUsers(); }
      else showToast('âŒ è®¾ç½®å¤±è´¥');
    }

    async function saveDefaultTrafficLimit() {
      const limitTB = parseFloat(document.getElementById('default-traffic-limit').value) || 0;
      const limitGB = limitTB * 1024;
      const res = await fetch('/admin/api/default-traffic-limit', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ limit: limitGB })
      });
      if (res.ok) showToast(limitTB > 0 ? `âœ… é»˜è®¤é™é¢å·²è®¾ä¸º ${limitTB} TB` : 'âœ… å·²è®¾ä¸ºæ— é™');
      else showToast('âŒ ä¿å­˜å¤±è´¥');
    }

    async function applyDefaultTrafficLimit() {
      if (!await _confirm('å°†å½“å‰é»˜è®¤æµé‡é™é¢è¦†ç›–åº”ç”¨åˆ°å…¨éƒ¨ç”¨æˆ·ï¼ˆåŒ…æ‹¬å·²æ‰‹åŠ¨è®¾ç½®è¿‡çš„ï¼‰ï¼Ÿ')) return;
      const res = await fetch('/admin/api/default-traffic-limit/apply', { method: 'POST', headers: {'Content-Type':'application/json'} });
      const d = await res.json().catch(() => ({}));
      if (res.ok && d.ok) {
        showToast(`âœ… å·²è¦†ç›–åº”ç”¨åˆ° ${d.updated || 0} ä¸ªç”¨æˆ·`);
        setTimeout(() => location.reload(), 600);
      } else {
        showToast('âŒ åº”ç”¨å¤±è´¥');
      }
    }

    async function saveTG() {
      const token = document.getElementById('tg-token').value.trim();
      const chatId = document.getElementById('tg-chat-id').value.trim();
      const res = await fetch('/admin/api/notify/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, chatId }) });
      if (res.ok) toast('âœ… å·²ä¿å­˜'); else toast('âŒ ä¿å­˜å¤±è´¥');
    }
    async function testTG() {
      const res = await fetch('/admin/api/notify/test', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();
      toast(data.ok ? 'âœ… æµ‹è¯•æ¶ˆæ¯å·²å‘é€' : 'âŒ ' + (data.error || 'å‘é€å¤±è´¥'));
    }
    async function toggleEvent(el) {
      await fetch('/admin/api/notify/event', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: el.dataset.key, enabled: el.checked }) });
    }

    let currentRange = 'today';
    function fmtBytes(b) { if(!b)return'0 B'; const u=['B','KB','MB','GB','TB']; const i=Math.floor(Math.log(b)/Math.log(1024)); return (b/Math.pow(1024,i)).toFixed(1)+' '+u[i]; }

    function switchRange(range) {
      currentRange = range;
      document.querySelectorAll('#traffic-range-btns button').forEach(btn => {
        btn.className = btn.dataset.range === range
          ? 'text-[11px] px-2.5 py-1 rounded-lg transition bg-rose-600 text-white'
          : 'text-[11px] px-2.5 py-1 rounded-lg transition glass text-gray-400 hover:text-white';
      });
      if (range === 'date') {
        document.querySelectorAll('#traffic-range-btns button').forEach(btn => {
          btn.className = 'text-[11px] px-2.5 py-1 rounded-lg transition glass text-gray-400 hover:text-white';
        });
      }
      loadTraffic(1);
    }

    async function loadTraffic(page) {
      let url;
      if (currentRange === 'date') {
        const date = document.getElementById('traffic-date').value;
        url = '/admin/api/traffic?date=' + date + '&page=' + page;
      } else {
        url = '/admin/api/traffic?range=' + currentRange + '&page=' + page;
      }
      const res = await fetch(url);
      const d = await res.json();
      const body = document.getElementById('traffic-body');
      const offset = (d.page - 1) * 20;
      if (d.rows.length === 0) {
        body.innerHTML = '<tr><td colspan="5" class="py-6 px-4 text-gray-600 text-xs text-center">è¯¥æ—¶æ®µæš‚æ— æµé‡æ•°æ®</td></tr>';
      } else {
        body.innerHTML = d.rows.map((u, i) => `<tr class="border-b border-white/5 hover:bg-white/[0.02]"><td class="py-2 px-4 text-[11px] text-gray-500">${offset+i+1}</td><td class="py-2 px-4 text-xs text-white">${u.username}</td><td class="py-2 px-4 text-xs">${fmtBytes(u.total_up)}</td><td class="py-2 px-4 text-xs">${fmtBytes(u.total_down)}</td><td class="py-2 px-4 text-xs font-medium text-rose-400">${fmtBytes(u.total_up+u.total_down)}</td></tr>`).join('');
      }
      document.getElementById('traffic-info').textContent = `å…± ${d.total} äºº`;
      const pager = document.getElementById('traffic-pager'); pager.innerHTML = '';
      for (let i=1;i<=d.pages;i++) { const btn=document.createElement('button'); btn.textContent=i; btn.className='text-xs px-2 py-1 rounded '+(i===d.page?'bg-rose-600 text-white':'glass text-gray-400 hover:text-white'); btn.onclick=()=>loadTraffic(i); pager.appendChild(btn); }
      loadNodeTraffic();
    }

    async function loadNodeTraffic() {
      let rangeParam;
      if (currentRange === 'date') {
        rangeParam = document.getElementById('traffic-date').value;
      } else {
        rangeParam = currentRange;
      }
      const res = await fetch('/admin/api/traffic/nodes?range=' + rangeParam);
      const d = await res.json();
      const body = document.getElementById('node-traffic-body');
      if (d.rows.length === 0) {
        body.innerHTML = '<tr><td colspan="5" class="py-6 px-4 text-gray-600 text-xs text-center">æš‚æ— èŠ‚ç‚¹æµé‡æ•°æ®</td></tr>';
      } else {
        body.innerHTML = d.rows.map((n, i) => `<tr class="border-b border-white/5 hover:bg-white/[0.02]"><td class="py-2 px-4 text-[11px] text-gray-500">${i+1}</td><td class="py-2 px-4 text-xs text-white">${n.name}</td><td class="py-2 px-4 text-xs">${fmtBytes(n.total_up)}</td><td class="py-2 px-4 text-xs">${fmtBytes(n.total_down)}</td><td class="py-2 px-4 text-xs font-medium text-rose-400">${fmtBytes(n.total_up+n.total_down)}</td></tr>`).join('');
      }
    }

    // åˆå§‹åŠ è½½èŠ‚ç‚¹æµé‡
    document.addEventListener('DOMContentLoaded', () => loadNodeTraffic());

    let currentLogType = 'system';
    function switchLogType(type) {
      currentLogType = type;
      document.querySelectorAll('[data-logtype]').forEach(btn => {
        btn.className = btn.dataset.logtype === type
          ? 'text-xs px-3 py-1.5 rounded-lg transition bg-rose-600 text-white'
          : 'text-xs px-3 py-1.5 rounded-lg transition glass text-gray-400 hover:text-white';
      });
      loadLogs(1);
    }

    async function loadLogs(page) {
      const res = await fetch('/admin/api/logs?page=' + page + '&type=' + currentLogType);
      const d = await res.json();
      document.getElementById('log-body').innerHTML = d.rows.map(l =>
        `<tr class="border-b border-white/5"><td class="py-2 px-4 text-xs text-gray-500">${l.created_at}</td><td class="py-2 px-4 text-xs">${l.ip === 'system' ? '<span class="text-amber-400">ç³»ç»Ÿ</span>' : (l.username||'-')}</td><td class="py-2 px-4 text-xs">${l.action}</td><td class="py-2 px-4 text-xs text-gray-500 max-w-xs truncate">${l.detail||''}</td></tr>`
      ).join('');
      document.getElementById('log-info').textContent = `å…± ${d.total} æ¡`;
      const pager = document.getElementById('log-pager');
      pager.innerHTML = '';
      for (let i = 1; i <= d.pages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'text-xs px-2 py-1 rounded ' + (i===d.page ? 'bg-rose-600 text-white' : 'glass text-gray-400 hover:text-white');
        btn.onclick = () => loadLogs(i);
        pager.appendChild(btn);
      }
    }
    async function clearLogs() {
      if (!await _confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ—¥å¿—ï¼Ÿ')) return;
      await fetch('/admin/api/logs/clear', { method:'POST', headers:{'Content-Type':'application/json'} });
      loadLogs(1);
    }

    async function loadSubStats(page = 1) {
      const hours = document.getElementById('substats-hours').value;
      const sort = document.getElementById('substats-sort').value;
      const high = document.getElementById('substats-high').checked ? '1' : '0';
      const container = document.getElementById('substats-result');
      const pager = document.getElementById('substats-pager');
      container.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">åŠ è½½ä¸­...</p>';
      pager.innerHTML = '';
      try {
        const res = await fetch('/admin/api/sub-stats?hours=' + hours + '&page=' + page + '&sort=' + sort + '&high=' + high);
        const json = await res.json();
        if (!json.data || json.data.length === 0) {
          container.innerHTML = '<p class="text-emerald-400 text-sm text-center py-4">âœ… æ— æ•°æ®</p>';
          return;
        }
        const riskBadge = r => {
          const cls = r === 'high' ? 'bg-red-500/20 text-red-300' : r === 'mid' ? 'bg-amber-500/20 text-amber-300' : 'bg-white/10 text-gray-400';
          return '<span class="text-xs px-2 py-0.5 rounded-full ' + cls + '">' + r + '</span>';
        };
        container.innerHTML = '<div class="overflow-x-auto"><table class="w-full text-xs">' +
          '<thead><tr class="text-gray-500 border-b border-white/10"><th class="py-2 text-left">ç”¨æˆ·</th><th>æ‹‰å–</th><th>IPæ•°</th><th>æœ€è¿‘æ‹‰å–</th><th>å¹³å‡é—´éš”</th><th>é£é™©</th><th></th></tr></thead><tbody>' +
          json.data.map(u =>
            '<tr class="border-b border-white/5 hover:bg-white/5">' +
            '<td class="py-2 text-white">' + u.username + ' <span class="text-gray-600">ID:' + u.user_id + '</span></td>' +
            '<td class="text-center text-gray-300">' + u.pull_count + '</td>' +
            '<td class="text-center text-gray-300">' + u.ip_count + '</td>' +
            '<td class="text-center text-gray-400">' + (u.last_access || '-') + '</td>' +
            '<td class="text-center text-gray-400">' + u.avg_interval_sec + 's</td>' +
            '<td class="text-center">' + riskBadge(u.risk_level) + '</td>' +
            '<td class="text-right"><button onclick="showSubStatDetail(' + u.user_id + ',' + hours + ')" class="text-rose-400 hover:text-rose-300">è¯¦æƒ…</button></td>' +
            '</tr>'
          ).join('') + '</tbody></table></div>';
        // åˆ†é¡µ
        const totalPages = Math.ceil(json.total / json.limit);
        if (totalPages > 1) {
          let html = '';
          for (let i = 1; i <= totalPages && i <= 10; i++) {
            html += '<button onclick="loadSubStats(' + i + ')" class="text-xs px-2 py-1 rounded ' + (i === page ? 'bg-rose-600 text-white' : 'bg-white/10 text-gray-400') + '">' + i + '</button>';
          }
          pager.innerHTML = html;
        }
      } catch(e) { container.innerHTML = '<p class="text-red-400 text-sm">åŠ è½½å¤±è´¥</p>'; }
    }

    async function showSubStatDetail(userId, hours) {
      const panel = document.getElementById('substats-detail-panel');
      const container = document.getElementById('substats-detail');
      panel.classList.remove('hidden');
      container.innerHTML = '<p class="text-gray-500 text-xs">åŠ è½½ä¸­...</p>';
      try {
        const res = await fetch('/admin/api/sub-stats/' + userId + '/detail?hours=' + hours);
        const d = await res.json();
        let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
        // IP åˆ†å¸ƒ
        html += '<div><h4 class="text-gray-400 text-xs mb-2">IP åˆ†å¸ƒ (' + d.ips.length + ')</h4><div class="space-y-1">' +
          d.ips.map(ip => '<div class="flex justify-between p-1.5 rounded bg-black/20 text-xs"><span class="text-gray-300 font-mono">' + ip.ip + '</span><span class="text-gray-500">' + ip.count + 'æ¬¡ ' + ip.last_access + '</span></div>').join('') + '</div></div>';
        // UA TOP
        html += '<div><h4 class="text-gray-400 text-xs mb-2">UA TOP</h4><div class="space-y-1">' +
          d.uas.map(ua => '<div class="p-1.5 rounded bg-black/20 text-xs"><span class="text-gray-300 break-all">' + (ua.ua || '(empty)') + '</span> <span class="text-gray-500">' + ua.count + 'æ¬¡</span></div>').join('') + '</div></div>';
        // Timeline
        html += '<div><h4 class="text-gray-400 text-xs mb-2">æœ€è¿‘æ‹‰å–</h4><div class="space-y-1">' +
          d.timeline.map(t => '<div class="p-1.5 rounded bg-black/20 text-xs"><span class="text-gray-400">' + t.time + '</span> <span class="text-gray-300 font-mono">' + t.ip + '</span></div>').join('') + '</div></div>';
        html += '</div>';
        container.innerHTML = html;
        document.getElementById('substats-detail-title').textContent = 'ç”¨æˆ· #' + userId + ' è¯¦æƒ…';
      } catch(e) { container.innerHTML = '<p class="text-red-400 text-xs">åŠ è½½å¤±è´¥</p>'; }
    }

    // å…¼å®¹æ—§è°ƒç”¨
    async function checkAbuse() { loadSubStats(1); }
    function loadAbuse() { loadSubStats(1); }

    async function showDetail(userId, hours) {
      const panel = document.getElementById('substats-detail-panel');
      const container = document.getElementById('substats-detail');
      panel.classList.remove('hidden');
      container.innerHTML = '<p class="text-gray-500 text-xs">åŠ è½½ä¸­...</p>';
      const res = await fetch('/admin/api/sub-access/' + userId + '?hours=' + hours);
      const ips = await res.json();
      container.innerHTML = '<div class="space-y-1">' + ips.map(ip =>
        '<div class="flex items-center justify-between p-2 rounded-lg bg-black/20 text-xs">' +
        '<span class="text-gray-300 font-mono">' + ip.ip + '</span>' +
        '<div class="flex gap-3"><span class="text-gray-500">æ‹‰å– ' + ip.count + ' æ¬¡</span><span class="text-gray-600">' + ip.last_access + '</span></div>' +
        '</div>'
      ).join('') + '</div>';
    }

  </script>
  <script src="/js/chart.umd.min.js"></script>
  <script>
    let trafficChart = null;
    async function loadTrafficChart() {
      try {
        const res = await fetch('/admin/api/traffic/trend?days=30');
        const data = await res.json();
        const ctx = document.getElementById('traffic-chart');
        if (!ctx) return;
        if (trafficChart) trafficChart.destroy();
        const labels = data.map(d => d.date.slice(5));
        const toGB = v => +(v / 1073741824).toFixed(2);
        trafficChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'ä¸Šä¼  (GB)', data: data.map(d => toGB(d.total_up)), borderColor: '#f43f5e', backgroundColor: 'rgba(244,63,94,0.1)', fill: true, tension: 0.3, pointRadius: 2 },
              { label: 'ä¸‹è½½ (GB)', data: data.map(d => toGB(d.total_down)), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', fill: true, tension: 0.3, pointRadius: 2 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#9ca3af', font: { size: 11 } } } },
            scales: {
              x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.03)' } },
              y: { ticks: { color: '#6b7280', font: { size: 10 }, callback: v => v + ' GB' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
      } catch(e) { console.error('chart error', e); }
    }
    // åˆ‡æ¢åˆ°æµé‡ tab æ—¶åŠ è½½å›¾è¡¨
    const origSwitchTab = switchTab;
    switchTab = function(name) {
      origSwitchTab(name);
      if (name === 'traffic') loadTrafficChart();
    };
    if (location.hash === '#traffic') setTimeout(loadTrafficChart, 200);
  </script>
<%- include('partials/foot') %>
