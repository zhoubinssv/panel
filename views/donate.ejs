<%- include('partials/head', { title: 'æèµ èŠ‚ç‚¹' }) %>

  <!-- å¯¼èˆª -->
  <nav class="glass-solid sticky top-0 z-40 px-6 py-3">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-sm">ğŸ‘</div>
        <span class="text-white font-semibold hidden sm:block">å°å§¨å­çš„è¯±æƒ‘</span>
      </a>
      <a href="/" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-white transition">â† è¿”å›é¢æ¿</a>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-4 sm:px-6 py-8 space-y-6">

    <!-- æ ‡é¢˜ -->
    <div class="text-center py-2">
      <h1 class="text-2xl sm:text-3xl font-bold donate-title">ğŸ‘ å…±å»ºèœœæ¡ƒç½‘ç»œ</h1>
      <p class="text-gray-500 text-sm mt-2">ä¸€å°é—²ç½®çš„æœåŠ¡å™¨ï¼Œå°±èƒ½è®©æ›´å¤šäººè‡ªç”±ä¸Šç½‘</p>
    </div>

    <!-- è¯´æ˜å¡ç‰‡ -->
    <div class="glass rounded-2xl p-6 space-y-4">
      <h2 class="text-white font-semibold text-base">âœ¨ ä¸‰åˆ†é’Ÿï¼Œä¸€è¡Œå‘½ä»¤</h2>
      <div class="space-y-3 text-gray-300 text-sm leading-relaxed">
        <div class="flex gap-3 items-start">
          <span class="step-badge shrink-0">1</span>
          <span>é€‰æ‹©åè®®ï¼Œå¤åˆ¶å®‰è£…å‘½ä»¤</span>
        </div>
        <div class="flex gap-3 items-start">
          <span class="step-badge shrink-0">2</span>
          <span>åœ¨æœåŠ¡å™¨ä¸Šä»¥ root æ‰§è¡Œï¼Œå‰©ä¸‹çš„äº¤ç»™èœœæ¡ƒé…±</span>
        </div>
        <div class="flex gap-3 items-start">
          <span class="step-badge shrink-0">3</span>
          <span>è‡ªåŠ¨éƒ¨ç½²ã€è‡ªåŠ¨å®¡æ ¸ã€è‡ªåŠ¨ä¸Šçº¿ â€” å…¨ç¨‹æ— éœ€äººå·¥å¹²é¢„</span>
        </div>
      </div>
      <div class="mt-3 p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-emerald-300 text-xs">
        ğŸ <b>æèµ è€…ä¸“å±</b>ï¼šæèµ è€…å¾½ç«  + è®¢é˜…æµé‡æ¯æœˆé‡ç½®ï¼ˆæ™®é€šç”¨æˆ·æ¯å‘¨ï¼‰
      </div>
      <div class="mt-2 p-3 rounded-xl bg-rose-500/10 border border-rose-500/20 text-rose-300 text-xs">
        ğŸ”’ <b>å®‰å…¨ä¿éšœ</b>ï¼šèœœæ¡ƒé…±ä¼šæŒç»­æ ¡éªŒèŠ‚ç‚¹é…ç½®å®Œæ•´æ€§ï¼Œç¯¡æ”¹å³ä¸‹çº¿ï¼Œä¿æŠ¤æ¯ä¸€ä½ç”¨æˆ·çš„æµé‡å®‰å…¨
      </div>
      <div class="mt-2 p-3 rounded-xl bg-amber-500/10 border border-amber-500/20 text-amber-300 text-xs">
        ğŸ’» <b>æœåŠ¡å™¨è¦æ±‚</b>ï¼šLinuxï¼ˆDebian / Ubuntu / CentOSï¼‰Â· å…¬ç½‘ IP Â· root æƒé™ Â· 512MB+ å†…å­˜
      </div>
    </div>

    <!-- å®‰è£…å‘½ä»¤ -->
    <div class="glass rounded-2xl p-6 space-y-4">
      <h2 class="text-white font-semibold">ğŸš€ ä¸€é”®éƒ¨ç½²</h2>
      <% if (donations.some(d => d.status === 'pending')) { %>
        <div class="p-3 rounded-xl bg-emerald-500/20 border border-emerald-400/40 text-white text-xs mb-3 font-medium">
          âœ… Agent å·²è¿æ¥ï¼ŒğŸ‘ èœœæ¡ƒé…±æ­£åœ¨è‡ªåŠ¨å®¡æ ¸ä¸­...
        </div>
      <% } %>

      <!-- åè®®é€‰æ‹© -->
      <div class="space-y-2">
        <p class="text-gray-400 text-xs">é€‰æ‹©éƒ¨ç½²åè®®ï¼š</p>
        <div class="flex flex-wrap gap-2">
          <button onclick="setProtocol('vless')" id="proto-vless" class="proto-btn proto-active text-xs px-4 py-2 rounded-xl transition font-medium">
            ğŸŒ VLESS (IPv4)
          </button>
          <button onclick="setProtocol('ss')" id="proto-ss" class="proto-btn text-xs px-4 py-2 rounded-xl transition font-medium">
            ğŸ”® Shadowsocks (IPv6)
          </button>
          <button onclick="setProtocol('dual')" id="proto-dual" class="proto-btn text-xs px-4 py-2 rounded-xl transition font-medium">
            âš¡ åŒåè®® (IPv4+IPv6)
          </button>
        </div>
        <p class="text-gray-600 text-[11px]" id="proto-hint">VLESS Reality åè®®ï¼Œä½¿ç”¨æœåŠ¡å™¨çš„ IPv4 åœ°å€</p>
      </div>

      <!-- NAT é€‰é¡¹ -->
      <div class="space-y-2">
        <p class="text-gray-400 text-xs">ç½‘ç»œç±»å‹ï¼š</p>
        <button onclick="toggleNat()" id="nat-toggle" class="proto-btn text-xs px-4 py-2 rounded-xl transition font-medium">ğŸ§± NAT æœºå™¨ï¼ˆä»…è½®æ¢ UUIDï¼Œä¸è½®æ¢ç«¯å£ï¼‰</button>
      </div>

      <pre class="cmd-box rounded-xl p-4 text-green-400 text-xs overflow-x-auto whitespace-pre-wrap break-all select-all" id="install-cmd"><%= installCmd %></pre>
      <div class="flex items-center gap-3 mt-3">
        <button onclick="copyCmd()" class="copy-cta text-sm px-5 py-2.5 rounded-xl text-white font-medium transition" id="copy-btn">ğŸ“‹ å¤åˆ¶å‘½ä»¤</button>
        <span class="text-gray-500 text-xs">ç²˜è´´åˆ°æœåŠ¡å™¨å›è½¦å³å¯ï¼Œèœœæ¡ƒé…±ä¼šè‡ªåŠ¨æ¥ç®¡åç»­æµç¨‹</span>
      </div>
    </div>

    <!-- æˆ‘çš„æèµ  -->
    <% if (donations.length > 0) { %>
    <div class="glass rounded-2xl p-6 space-y-4">
      <h2 class="text-white font-semibold">ğŸ“¦ æˆ‘çš„è´¡çŒ®</h2>
      <div class="space-y-2">
        <% donations.forEach(d => { %>
          <div class="flex items-center justify-between p-3 rounded-xl bg-white/[0.02] border border-white/5">
            <div>
              <span class="text-gray-300 text-sm"><%= d.server_ip || 'ç­‰å¾…è¿æ¥' %></span>
              <span class="text-gray-400 text-xs ml-2"><%= d.region || '' %></span>
              <% const _protoMap = { vless: 'ğŸŒ VLESS', ss: 'ğŸ”® SS', dual: 'âš¡ åŒåè®®' }; %>
              <span class="text-gray-500 text-[11px] ml-1"><%= _protoMap[d.protocol_choice] || '' %></span>
            </div>
            <span class="text-xs px-2 py-1 rounded-full
              <% const _realOnline = d.status === 'online' && d.node_is_active === 1; %>
              <% if (_realOnline) { %>bg-green-500/20 text-green-400<% } else if (d.status === 'pending') { %>bg-amber-500/20 text-amber-400<% } else if (d.status === 'online' && !d.node_is_active) { %>bg-red-500/20 text-red-400<% } else if (d.status === 'rejected') { %>bg-red-500/20 text-red-400<% } else { %>bg-gray-500/20 text-gray-400<% } %>
            ">
              <% if (_realOnline) { %>âœ… åœ¨çº¿
              <% } else if (d.status === 'pending') { %>â³ å®¡æ ¸ä¸­
              <% } else if (d.status === 'online' && !d.node_is_active) { %>ğŸ”´ ç¦»çº¿
              <% } else if (d.status === 'rejected') { %>âŒ æ‹’ç»
              <% } else { %>âš« ç¦»çº¿<% } %>
            </span>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- æèµ è€…è£èª‰ -->
    <% if (donors.length > 0) { %>
    <div class="glass rounded-2xl p-6 space-y-4">
      <h2 class="text-white font-semibold">ğŸ† æ„Ÿè°¢æœ‰ä½ ä»¬</h2>
      <div class="space-y-2">
        <% donors.forEach((d, i) => { %>
          <div class="flex items-center justify-between p-3 rounded-xl bg-white/[0.02]">
            <div class="flex items-center gap-3">
              <span class="text-lg"><%= i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'â­' %></span>
              <span class="text-gray-300 text-sm"><%= d.name || d.username %></span>
            </div>
            <span class="text-rose-400 text-sm font-medium"><%= d.count %> ä¸ªèŠ‚ç‚¹</span>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>

  </main>

  <!-- é¡µè„š -->
  <footer class="text-center py-6 text-gray-600 text-xs">æ¯ä¸€å°æœåŠ¡å™¨ï¼Œéƒ½æ˜¯ä¸€ä»½å–„æ„ Â· ğŸ‘ èœœæ¡ƒé…±</footer>

  <style nonce="<%= nonce %>">
    /* æ ‡é¢˜æ¸å˜ */
    .donate-title {
      background: linear-gradient(135deg, #fff 0%, #fda4af 50%, #fb923c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    /* æ­¥éª¤å¾½ç«  */
    .step-badge {
      display: inline-flex; align-items: center; justify-content: center;
      width: 22px; height: 22px; border-radius: 50%;
      background: linear-gradient(135deg, #f43f5e, #e11d48);
      color: #fff; font-size: 11px; font-weight: 700;
      box-shadow: 0 2px 8px rgba(244,63,94,0.3);
      margin-top: 1px;
    }
    /* åè®®æŒ‰é’® */
    .proto-btn {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12);
      color: #d1d5db; cursor: pointer;
    }
    .proto-btn:hover { background: rgba(255,255,255,0.09); color: #fff; border-color: rgba(255,255,255,0.2); }
    .proto-active {
      background: rgba(244,63,94,0.18) !important;
      border-color: rgba(244,63,94,0.5) !important;
      color: #fff !important;
      box-shadow: 0 0 12px rgba(244,63,94,0.15);
    }
    /* å‘½ä»¤æ¡† */
    .cmd-box {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(74,222,128,0.12);
      box-shadow: inset 0 1px 0 rgba(74,222,128,0.05);
    }
    /* å¤åˆ¶æŒ‰é’® CTA */
    .copy-cta {
      background: linear-gradient(135deg, #f43f5e, #e11d48);
      box-shadow: 0 4px 20px rgba(244,63,94,0.35);
    }
    .copy-cta:hover {
      box-shadow: 0 6px 28px rgba(244,63,94,0.5);
      transform: translateY(-1px);
    }
    .copy-cta:active { transform: translateY(0); }
  </style>
  <script nonce="<%= nonce %>">
    const protoHints = {
      vless: 'VLESS Reality åè®®ï¼Œä½¿ç”¨æœåŠ¡å™¨çš„ IPv4 åœ°å€',
      ss: 'Shadowsocks åè®®ï¼Œéœ€è¦æœåŠ¡å™¨æœ‰ IPv6 åœ°å€',
      dual: 'åŒæ—¶éƒ¨ç½² VLESS (IPv4) + Shadowsocks (IPv6)ï¼Œéœ€è¦æœåŠ¡å™¨åŒæ—¶æœ‰ IPv4 å’Œ IPv6'
    };
    let currentProto = '<%= protocolChoice || "vless" %>';
    let natMode = <%= natMode ? 'true' : 'false' %>;

    function setProtocol(proto) {
      currentProto = proto;
      document.querySelectorAll('.proto-btn').forEach(b => b.classList.remove('proto-active'));
      document.getElementById('proto-' + proto).classList.add('proto-active');
      document.getElementById('proto-hint').textContent = protoHints[proto];
      // æ›´æ–°å‘½ä»¤ä¸­çš„åè®®å‚æ•°
      const cmdEl = document.getElementById('install-cmd');
      cmdEl.textContent = cmdEl.textContent.replace(/\s+(vless|ss|dual)\s*$/, ' ' + proto);
      // ä¿å­˜é€‰æ‹©åˆ°åç«¯
      fetch('/donate/set-protocol', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ protocol: proto, token: '<%= donateToken %>', natMode })
      });
    }


    function toggleNat() {
      natMode = !natMode;
      const btn = document.getElementById('nat-toggle');
      btn.classList.toggle('proto-active', natMode);
      fetch('/donate/set-protocol', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ protocol: currentProto, token: '<%= donateToken %>', natMode })
      });
    }

    function copyCmd() {
      const cmd = document.getElementById('install-cmd').textContent;
      navigator.clipboard.writeText(cmd).then(() => {
        const btn = document.getElementById('copy-btn');
        btn.textContent = 'å·²å¤åˆ¶ âœ“';
        setTimeout(() => btn.textContent = 'ğŸ“‹ å¤åˆ¶å‘½ä»¤', 2000);
      });
    }
    function generateToken() {
      const btn = document.getElementById('gen-btn');
      btn.disabled = true;
      btn.textContent = 'ç”Ÿæˆä¸­...';
      fetch('/donate/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r => r.json())
        .then(d => {
          if (d.ok) {
            location.reload();
          } else {
            btn.textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œé‡è¯•';
            btn.disabled = false;
          }
        })
        .catch(() => { btn.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œé‡è¯•'; btn.disabled = false; });
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤é€‰æ‹©
    if (currentProto !== 'vless') setProtocol(currentProto);
    if (natMode) document.getElementById('nat-toggle')?.classList.add('proto-active');
  </script>
</body>
</html>
