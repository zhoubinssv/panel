<%- include('partials/head', { title: 'æèµ èŠ‚ç‚¹' }) %>

  <!-- å¯¼èˆª -->
  <nav class="glass-solid sticky top-0 z-40 px-6 py-3">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-sm">ğŸ‘</div>
        <span class="text-white font-semibold hidden sm:block">å°å§¨å­çš„è¯±æƒ‘</span>
      </a>
      <a href="/" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-white transition">â† è¿”å›é¢æ¿</a>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-4 sm:px-6 py-8 space-y-6">

    <!-- æ ‡é¢˜ -->
    <div class="text-center">
      <h1 class="text-white text-2xl font-bold">ğŸ æèµ èŠ‚ç‚¹</h1>
      <p class="text-gray-400 text-sm mt-2">åˆ†äº«ä½ çš„é—²ç½®æœåŠ¡å™¨ï¼ŒğŸ‘ èœœæ¡ƒé…±ä¼šå¸®ä½ æå®šä¸€åˆ‡</p>
    </div>

    <!-- è¯´æ˜å¡ç‰‡ -->
    <div class="glass rounded-2xl p-6 space-y-4">
      <h2 class="text-white font-semibold">ğŸ“‹ å¦‚ä½•æèµ </h2>
      <div class="space-y-3 text-gray-400 text-sm leading-relaxed">
        <div class="flex gap-3">
          <span class="text-rose-400 font-bold shrink-0">1</span>
          <span>é€‰æ‹©éƒ¨ç½²åè®®ï¼Œå¤åˆ¶ä¸‹æ–¹å®‰è£…å‘½ä»¤</span>
        </div>
        <div class="flex gap-3">
          <span class="text-rose-400 font-bold shrink-0">2</span>
          <span>åœ¨ä½ çš„æœåŠ¡å™¨ä¸Šä»¥ root èº«ä»½æ‰§è¡Œ</span>
        </div>
        <div class="flex gap-3">
          <span class="text-rose-400 font-bold shrink-0">3</span>
          <span>è„šæœ¬è‡ªåŠ¨å®‰è£… Xray + Agent å¹¶è¿å›å¹³å°</span>
        </div>
        <div class="flex gap-3">
          <span class="text-rose-400 font-bold shrink-0">4</span>
          <span>ğŸ‘ èœœæ¡ƒé…±è‡ªåŠ¨å®¡æ ¸ä¸Šçº¿ï¼Œæ— éœ€ç­‰å¾…äººå·¥å¤„ç†</span>
        </div>
      </div>
      <div class="mt-3 p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-emerald-300 text-xs">
        ğŸ æèµ è€…ç¦åˆ©ï¼šæèµ è€…å¾½ç«  + è®¢é˜…æ¯æœˆé‡ç½®ï¼ˆè€Œéæ¯å‘¨ï¼‰
      </div>
      <div class="mt-2 p-3 rounded-xl bg-amber-500/10 border border-amber-500/20 text-amber-300 text-xs">
        âš ï¸ è¦æ±‚ï¼šLinux ç³»ç»Ÿï¼ˆDebian/Ubuntu/CentOSï¼‰ã€å…¬ç½‘ IPã€root æƒé™ã€è‡³å°‘ 512MB å†…å­˜
      </div>
    </div>

    <!-- å®‰è£…å‘½ä»¤ -->
    <div class="glass rounded-2xl p-6 space-y-4">
      <h2 class="text-white font-semibold">ğŸš€ å®‰è£…å‘½ä»¤</h2>
      <% if (donations.some(d => d.status === 'pending')) { %>
        <div class="p-3 rounded-xl bg-emerald-500/20 border border-emerald-400/40 text-white text-xs mb-3 font-medium">
          âœ… Agent å·²è¿æ¥ï¼ŒğŸ‘ èœœæ¡ƒé…±æ­£åœ¨è‡ªåŠ¨å®¡æ ¸ä¸­...
        </div>
      <% } %>

      <!-- åè®®é€‰æ‹© -->
      <div class="space-y-2">
        <p class="text-gray-400 text-xs">é€‰æ‹©éƒ¨ç½²åè®®ï¼š</p>
        <div class="flex flex-wrap gap-2">
          <button onclick="setProtocol('vless')" id="proto-vless" class="proto-btn proto-active text-xs px-4 py-2 rounded-xl transition font-medium">
            ğŸŒ VLESS (IPv4)
          </button>
          <button onclick="setProtocol('ss')" id="proto-ss" class="proto-btn text-xs px-4 py-2 rounded-xl transition font-medium">
            ğŸ”® Shadowsocks (IPv6)
          </button>
          <button onclick="setProtocol('dual')" id="proto-dual" class="proto-btn text-xs px-4 py-2 rounded-xl transition font-medium">
            âš¡ åŒåè®® (IPv4+IPv6)
          </button>
        </div>
        <p class="text-gray-600 text-[11px]" id="proto-hint">VLESS Reality åè®®ï¼Œä½¿ç”¨æœåŠ¡å™¨çš„ IPv4 åœ°å€</p>
      </div>

      <pre class="bg-black/40 rounded-xl p-4 text-green-400 text-xs overflow-x-auto whitespace-pre-wrap break-all select-all" id="install-cmd"><%= installCmd %></pre>
      <div class="flex items-center gap-3 mt-3">
        <button onclick="copyCmd()" class="text-xs px-4 py-2 rounded-lg bg-rose-500 text-white hover:bg-rose-400 transition shadow-lg font-medium" id="copy-btn">ğŸ“‹ å¤åˆ¶å‘½ä»¤</button>
        <span class="text-gray-300 text-xs">åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œæ­¤å‘½ä»¤ï¼ŒAgent è¿æ¥æˆåŠŸåå°†è‡ªåŠ¨æäº¤å®¡æ ¸</span>
      </div>
    </div>

    <!-- æˆ‘çš„æèµ  -->
    <% if (donations.length > 0) { %>
    <div class="glass rounded-2xl p-6 space-y-4">
      <h2 class="text-white font-semibold">ğŸ“¦ æˆ‘çš„æèµ </h2>
      <div class="space-y-2">
        <% donations.forEach(d => { %>
          <div class="flex items-center justify-between p-3 rounded-xl bg-white/[0.02] border border-white/5">
            <div>
              <span class="text-gray-300 text-sm"><%= d.server_ip || 'ç­‰å¾…è¿æ¥' %></span>
              <span class="text-gray-400 text-xs ml-2"><%= d.region || '' %></span>
              <% const _protoMap = { vless: 'ğŸŒ VLESS', ss: 'ğŸ”® SS', dual: 'âš¡ åŒåè®®' }; %>
              <span class="text-gray-500 text-[11px] ml-1"><%= _protoMap[d.protocol_choice] || '' %></span>
            </div>
            <span class="text-xs px-2 py-1 rounded-full
              <% const _realOnline = d.status === 'online' && d.node_is_active === 1; %>
              <% if (_realOnline) { %>bg-green-500/20 text-green-400<% } else if (d.status === 'pending') { %>bg-amber-500/20 text-amber-400<% } else if (d.status === 'online' && !d.node_is_active) { %>bg-red-500/20 text-red-400<% } else if (d.status === 'rejected') { %>bg-red-500/20 text-red-400<% } else { %>bg-gray-500/20 text-gray-400<% } %>
            ">
              <% if (_realOnline) { %>âœ… åœ¨çº¿
              <% } else if (d.status === 'pending') { %>â³ å®¡æ ¸ä¸­
              <% } else if (d.status === 'online' && !d.node_is_active) { %>ğŸ”´ ç¦»çº¿
              <% } else if (d.status === 'rejected') { %>âŒ æ‹’ç»
              <% } else { %>âš« ç¦»çº¿<% } %>
            </span>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- æèµ è€…è£èª‰ -->
    <% if (donors.length > 0) { %>
    <div class="glass rounded-2xl p-6 space-y-4">
      <h2 class="text-white font-semibold">ğŸ† æèµ è€…è£èª‰</h2>
      <div class="space-y-2">
        <% donors.forEach((d, i) => { %>
          <div class="flex items-center justify-between p-3 rounded-xl bg-white/[0.02]">
            <div class="flex items-center gap-3">
              <span class="text-lg"><%= i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'â­' %></span>
              <span class="text-gray-300 text-sm"><%= d.name || d.username %></span>
            </div>
            <span class="text-rose-400 text-sm font-medium"><%= d.count %> ä¸ªèŠ‚ç‚¹</span>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>

  </main>

  <!-- é¡µè„š -->
  <footer class="text-center py-6 text-gray-600 text-xs">ç”± ğŸ‘ èœœæ¡ƒé…± AI æ— äººå€¼å®ˆè¿ç»´</footer>

  <style nonce="<%= nonce %>">
    .proto-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); color: #9ca3af; }
    .proto-btn:hover { background: rgba(255,255,255,0.06); color: #fff; }
    .proto-active { background: rgba(244,63,94,0.2) !important; border-color: rgba(244,63,94,0.4) !important; color: #fff !important; }
  </style>
  <script nonce="<%= nonce %>">
    const protoHints = {
      vless: 'VLESS Reality åè®®ï¼Œä½¿ç”¨æœåŠ¡å™¨çš„ IPv4 åœ°å€',
      ss: 'Shadowsocks åè®®ï¼Œéœ€è¦æœåŠ¡å™¨æœ‰ IPv6 åœ°å€',
      dual: 'åŒæ—¶éƒ¨ç½² VLESS (IPv4) + Shadowsocks (IPv6)ï¼Œéœ€è¦æœåŠ¡å™¨åŒæ—¶æœ‰ IPv4 å’Œ IPv6'
    };
    let currentProto = '<%= protocolChoice || "vless" %>';

    function setProtocol(proto) {
      currentProto = proto;
      document.querySelectorAll('.proto-btn').forEach(b => b.classList.remove('proto-active'));
      document.getElementById('proto-' + proto).classList.add('proto-active');
      document.getElementById('proto-hint').textContent = protoHints[proto];
      // ä¿å­˜é€‰æ‹©åˆ°åç«¯
      fetch('/donate/set-protocol', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ protocol: proto, token: '<%= donateToken %>' })
      });
    }

    function copyCmd() {
      const cmd = document.getElementById('install-cmd').textContent;
      navigator.clipboard.writeText(cmd).then(() => {
        const btn = document.getElementById('copy-btn');
        btn.textContent = 'å·²å¤åˆ¶ âœ“';
        setTimeout(() => btn.textContent = 'ğŸ“‹ å¤åˆ¶å‘½ä»¤', 2000);
      });
    }
    function generateToken() {
      const btn = document.getElementById('gen-btn');
      btn.disabled = true;
      btn.textContent = 'ç”Ÿæˆä¸­...';
      fetch('/donate/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r => r.json())
        .then(d => {
          if (d.ok) {
            location.reload();
          } else {
            btn.textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œé‡è¯•';
            btn.disabled = false;
          }
        })
        .catch(() => { btn.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œé‡è¯•'; btn.disabled = false; });
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤é€‰æ‹©
    if (currentProto !== 'vless') setProtocol(currentProto);
  </script>
</body>
</html>
