<%- include('partials/head', { title: '节点面板' }) %>

  <!-- 导航 -->
  <nav class="glass-solid sticky top-0 z-40 px-6 py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-sm">🍑</div>
        <span class="text-white font-semibold hidden sm:block">小姨子的诱惑</span>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-gray-300 text-sm hidden sm:block"><%= user.name || user.username %></span>
        <% if (user.is_admin) { %><a href="/admin" class="text-xs px-3 py-1.5 rounded-full bg-amber-500/20 text-amber-300 hover:bg-amber-500/30 transition">管理</a><% } %>
        <a href="/auth/logout" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-red-400 transition">退出</a>
      </div>
    </div>
  </nav>

  <% if (announcement) { %>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 mt-4">
    <div class="bg-rose-500/10 border border-rose-500/20 rounded-2xl">
      <div class="px-4 py-2 flex items-center gap-2 text-xs">
        <span class="text-rose-400 shrink-0">📢</span>
        <div class="marquee-wrap">
          <span class="animate-marquee text-rose-200/80"><%= announcement %></span>
        </div>
      </div>
    </div>
  </div>
  <% } %>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 space-y-6">

    <!-- 流量概览 -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#f43f5e">
        <p class="text-gray-500 text-xs mb-1">节点在线用户</p>
        <p class="text-rose-400 text-lg font-bold" id="online-count">-</p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#8b5cf6">
        <p class="text-gray-500 text-xs mb-1">全站已用</p>
        <p class="text-violet-400 text-lg font-bold"><%= formatBytes(globalTraffic.total_up + globalTraffic.total_down) %></p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#fb923c">
        <p class="text-gray-500 text-xs mb-1">已用流量</p>
        <p class="text-orange-400 text-lg font-bold"><%= formatBytes(traffic.total_up + traffic.total_down) %></p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#06b6d4">
        <p class="text-gray-500 text-xs mb-1">剩余流量</p>
        <p class="text-cyan-400 text-lg font-bold"><%= trafficLimit > 0 ? formatBytes(Math.max(0, trafficLimit - traffic.total_up - traffic.total_down)) : '∞' %></p>
      </div>
      <% if (expiresAt) { %>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#a78bfa">
        <p class="text-gray-500 text-xs mb-1">账号到期</p>
        <% const _daysLeft = Math.ceil((new Date(expiresAt).getTime() - Date.now()) / 86400000); %>
        <p class="<%= _daysLeft <= 3 ? 'text-red-400' : 'text-violet-400' %> text-lg font-bold"><%= _daysLeft > 0 ? _daysLeft + ' 天' : '已过期' %></p>
      </div>
      <% } %>
    </div>

    <!-- 订阅链接 -->
    <div class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-1.5">
        <h2 class="text-white font-semibold text-sm">📡 个人订阅</h2>
        <div class="text-[11px] text-gray-300 text-right">
          <div>UUID 下次重置：<span id="uuid-reset-countdown" class="text-rose-300">计算中...</span></div>
          <div>订阅链接下次重置：<span id="sub-reset-countdown" class="text-cyan-300">计算中...</span></div>
        </div>
      </div>
      <div class="flex gap-2">
        <input type="text" readonly value="<%= subUrl %>" id="sub-link"
               class="flex-1 bg-black/30 text-rose-300 text-xs px-4 py-2.5 rounded-xl border border-white/5 font-mono">
        <button onclick="copySubLink()" class="bg-rose-600 hover:bg-rose-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">复制</button>
        <button onclick="showSubQr()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">二维码</button>
      </div>
    </div>

    <!-- 订阅二维码弹窗 -->
    <div id="sub-qr-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm" onclick="if(event.target===this)hideSubQr()">
      <div class="glass-solid rounded-2xl p-5 w-[92%] max-w-sm border border-white/10">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-white font-semibold text-sm">📱 扫码添加订阅</h3>
          <button onclick="hideSubQr()" class="text-gray-400 hover:text-white text-lg leading-none">✕</button>
        </div>
        <p class="text-gray-400 text-xs mb-3">用手机客户端扫码即可导入当前账号订阅链接</p>
        <div class="bg-white rounded-xl p-3 mx-auto w-fit mb-3">
          <img id="sub-qr-img" alt="订阅二维码" class="w-[220px] h-[220px] block" />
        </div>
        <p class="text-[11px] text-gray-500 break-all font-mono select-all" id="sub-qr-text"></p>
      </div>
    </div>

    <!-- 节点列表（按分组展示） -->
    <div>
      <div class="flex items-center justify-between mb-3 gap-2">
        <h2 class="text-white font-semibold">🌐 可用节点</h2>
        <div class="flex items-center gap-2">
          <button onclick="testLatency(this)" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-white transition">⚡ 延迟测试</button>
          <span class="text-gray-600 text-xs"><%= userNodes.length %> 个节点</span>
        </div>
      </div>
      <div class="mb-3">
        <input id="node-search" type="text" placeholder="搜索节点名 / 地区 / 标签..." oninput="filterNodes(this.value)" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" />
      </div>
      <%
        // 按 group_name 分组
        const _groups = {};
        userNodes.forEach(n => {
          const g = n.group_name || '默认';
          if (!_groups[g]) _groups[g] = [];
          _groups[g].push(n);
        });
        const _groupNames = Object.keys(_groups).sort((a, b) => a === '默认' ? 1 : b === '默认' ? -1 : a.localeCompare(b));
      %>
      <% _groupNames.forEach(gName => { %>
        <% if (_groupNames.length > 1) { %>
        <h3 class="text-gray-400 text-sm font-medium mb-2 mt-4 flex items-center gap-1.5">
          <span class="w-1 h-4 rounded-full bg-rose-500/50"></span> <%= gName %>
          <span class="text-gray-600 text-xs">(<%= _groups[gName].length %>)</span>
        </h3>
        <% } %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 node-card-grid mb-3">
        <% if (userNodes.length === 0 && gName === _groupNames[0]) { %>
          <div class="glass rounded-2xl p-8 col-span-full text-center">
            <p class="text-gray-500">暂无可用节点</p>
          </div>
        <% } else { _groups[gName].forEach(function(n) { %>
          <div class="glass rounded-2xl p-4 node-card" data-search="<%= (n.name || '') + ' ' + (n.region || '') + ' ' + (n.tags || '') %>">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-white font-medium text-sm"><%= n.name %></h3>
              <div class="flex items-center gap-1.5">
                <span class="text-gray-600 text-[10px] latency-badge" id="latency-<%= n.id %>"></span>
                <% if (n.remark && n.remark.includes('被墙')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="被墙"></span>
                <% } else if (n.remark && n.remark.includes('离线')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="离线"></span>
                <% } else if (n.is_active) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="在线"></span>
                <% } else { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_6px_rgba(250,204,21,0.6)]" title="检测中"></span>
                <% } %>
              </div>
            </div>
            <% if (n.region) { %><p class="text-gray-500 text-xs mb-3"><%= n.region %><% if (n.tags) { %> · <span class="text-gray-600"><%= n.tags %></span><% } %></p><% } %>
            <div class="bg-black/30 rounded-lg p-2.5 mb-2.5 overflow-hidden">
              <code class="text-rose-300 text-[11px] break-all select-all font-mono vless-link leading-relaxed block max-h-20 overflow-y-auto" id="link-<%= n.id %>"><%= n.link %></code>
            </div>
            <button onclick="copyLink(<%= n.id %>)" class="w-full bg-rose-600/80 hover:bg-rose-500 text-white text-xs py-2 rounded-lg transition">复制链接</button>
          </div>
        <% }); } %>
      </div>
      <% }); %>
    </div>

    <!-- 流量使用明细 (已移除) -->
  </main>

  <script>
    function copyLink(id) {
      navigator.clipboard.writeText(document.getElementById('link-' + id).textContent).then(() => toast('✅ 链接已复制'));
    }
    function copySubLink() {
      navigator.clipboard.writeText(document.getElementById('sub-link').value).then(() => toast('✅ 订阅链接已复制'));
    }
    function showSubQr() {
      const link = document.getElementById('sub-link').value;
      const modal = document.getElementById('sub-qr-modal');
      const img = document.getElementById('sub-qr-img');
      document.getElementById('sub-qr-text').textContent = link;
      img.src = '/sub-qr?t=' + Date.now();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function hideSubQr() {
      const modal = document.getElementById('sub-qr-modal');
      modal.classList.remove('flex');
      modal.classList.add('hidden');
    }

    function filterNodes(keyword) {
      const q = (keyword || '').trim().toLowerCase();
      document.querySelectorAll('.node-card').forEach(card => {
        const text = (card.dataset.search || '').toLowerCase();
        card.style.display = !q || text.includes(q) ? '' : 'none';
      });
    }

    // 加载在线人数
    fetch('/online-count').then(r=>r.json()).then(d=>{
      const el = document.getElementById('online-count');
      if (el) el.textContent = d.online + ' 人';
    }).catch(()=>{});

    // 订阅重置倒计时
    const nextUuidResetAt = <%- JSON.stringify(nextUuidResetAt || 0) %>;
    const nextSubResetAt = <%- JSON.stringify(nextSubResetAt || 0) %>;

    function fmtCountdown(ms) {
      if (ms <= 0) return '即将重置';
      const s = Math.floor(ms / 1000);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      if (d > 0) return `${d}天 ${h}小时 ${m}分钟`;
      if (h > 0) return `${h}小时 ${m}分钟`;
      return `${m}分钟`;
    }

    function tickResetCountdown() {
      const now = Date.now();
      const u = document.getElementById('uuid-reset-countdown');
      const t = document.getElementById('sub-reset-countdown');
      if (u) u.textContent = fmtCountdown(nextUuidResetAt - now);
      if (t) t.textContent = fmtCountdown(nextSubResetAt - now);
    }
    tickResetCountdown();
    setInterval(tickResetCountdown, 30000);

    // Sprint 6: 延迟测试
    async function testLatency(btn) {
      const orig = btn.textContent;
      btn.textContent = '⏳ 测试中...';
      btn.disabled = true;
      try {
        const r = await fetch('/api/ping-nodes');
        const d = await r.json();
        if (d.ok) {
          d.results.forEach(n => {
            const el = document.getElementById('latency-' + n.id);
            if (el) {
              if (n.latency >= 0) {
                const color = n.latency < 100 ? 'text-emerald-400' : n.latency < 300 ? 'text-yellow-400' : 'text-red-400';
                el.className = `text-[10px] latency-badge ${color}`;
                el.textContent = n.latency + 'ms';
              } else {
                el.className = 'text-[10px] latency-badge text-red-400';
                el.textContent = '超时';
              }
            }
          });
          toast('✅ 延迟测试完成');
        }
      } catch(e) { toast('❌ 测试失败'); }
      btn.textContent = orig;
      btn.disabled = false;
    }

    loadTrafficDetail = function(){};
  </script>
<%- include('partials/foot') %>
