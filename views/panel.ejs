<%- include('partials/head', { title: 'èŠ‚ç‚¹é¢æ¿' }) %>

  <!-- å¯¼èˆª -->
  <nav class="glass-solid sticky top-0 z-40 px-6 py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-sm">ğŸ‘</div>
        <span class="text-white font-semibold hidden sm:block">å°å§¨å­çš„è¯±æƒ‘</span>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-gray-300 text-sm hidden sm:block"><%= user.name || user.username %></span>
        <a href="/donate" class="text-xs px-3 py-1.5 rounded-full bg-rose-500/20 text-rose-300 hover:bg-rose-500/30 transition">ğŸ æèµ </a>
        <% if (user.is_admin) { %><a href="/admin" class="text-xs px-3 py-1.5 rounded-full bg-amber-500/20 text-amber-300 hover:bg-amber-500/30 transition">ç®¡ç†</a><% } %>
        <a href="/auth/logout" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-red-400 transition">é€€å‡º</a>
      </div>
    </div>
  </nav>

  <% if (announcement) { %>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 mt-4">
    <div class="bg-rose-500/10 border border-rose-500/20 rounded-2xl">
      <div class="px-4 py-2 flex items-center gap-2 text-xs">
        <span class="text-rose-400 shrink-0">ğŸ“¢</span>
        <div class="marquee-wrap">
          <span class="animate-marquee text-rose-200/80"><%= announcement %></span>
        </div>
      </div>
    </div>
  </div>
  <% } %>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 space-y-6">

    <!-- æµé‡æ¦‚è§ˆ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#f43f5e">
        <p class="text-gray-500 text-xs mb-1">èŠ‚ç‚¹åœ¨çº¿ç”¨æˆ·</p>
        <p class="text-rose-400 text-lg font-bold" id="online-count">0 äºº</p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#8b5cf6">
        <p class="text-gray-500 text-xs mb-1">å…¨ç«™å·²ç”¨</p>
        <p class="text-violet-400 text-lg font-bold" id="global-traffic"><%= formatBytes(globalTraffic.total_up + globalTraffic.total_down) %></p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#fb923c">
        <p class="text-gray-500 text-xs mb-1">å·²ç”¨æµé‡</p>
        <p class="text-orange-400 text-lg font-bold" id="used-traffic"><%= formatBytes(traffic.total_up + traffic.total_down) %></p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#06b6d4">
        <p class="text-gray-500 text-xs mb-1"><%= expiresAt ? 'å‰©ä½™æµé‡ / åˆ°æœŸ' : 'å‰©ä½™æµé‡' %></p>
        <p class="text-cyan-400 text-lg font-bold" id="remaining-traffic">
          <%= trafficLimit > 0 ? formatBytes(Math.max(0, trafficLimit - traffic.total_up - traffic.total_down)) : 'âˆ' %>
          <% if (expiresAt) { %>
            <% const _daysLeft = Math.ceil((new Date(expiresAt).getTime() - Date.now()) / 86400000); %>
            <span class="text-xs <%= _daysLeft <= 3 ? 'text-red-400' : 'text-gray-500' %> ml-1">Â· <%= _daysLeft > 0 ? _daysLeft + 'å¤©' : 'å·²è¿‡æœŸ' %></span>
          <% } %>
        </p>
      </div>
    </div>

    <!-- è®¢é˜…é“¾æ¥ -->
    <div class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-1.5">
        <h2 class="text-white font-semibold text-sm">ğŸ“¡ ä¸ªäººè®¢é˜…</h2>
        <div class="text-[11px] text-gray-300 text-right">
          <div>UUID ä¸‹æ¬¡é‡ç½®ï¼š<span id="uuid-reset-countdown" class="text-rose-300">è®¡ç®—ä¸­...</span></div>
          <div>è®¢é˜…é“¾æ¥ä¸‹æ¬¡é‡ç½®ï¼š<span id="sub-reset-countdown" class="text-cyan-300">è®¡ç®—ä¸­...</span></div>
        </div>
      </div>
      <div class="space-y-2">
        <div>
          <div class="text-[11px] text-gray-400 mb-1">ğŸŒ IPv4 è®¢é˜…ï¼ˆVLESSï¼‰</div>
          <div class="flex gap-2">
            <input type="text" readonly value="<%= subUrl %>" id="sub-link"
                   class="flex-1 bg-black/30 text-rose-300 text-xs px-4 py-2.5 rounded-xl border border-white/5 font-mono">
            <button onclick="copySubLink()" class="bg-rose-600 hover:bg-rose-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">å¤åˆ¶</button>
            <button onclick="showSubQr()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">äºŒç»´ç </button>
          </div>
        </div>
        <div>
          <div class="text-[11px] text-gray-400 mb-1">ğŸŒ IPv6 è®¢é˜…ï¼ˆShadowsocksï¼‰</div>
          <div class="flex gap-2">
            <input type="text" readonly value="<%= subUrl6 %>" id="sub6-link"
                   class="flex-1 bg-black/30 text-cyan-300 text-xs px-4 py-2.5 rounded-xl border border-white/5 font-mono">
            <button onclick="copySub6Link()" class="bg-rose-600 hover:bg-rose-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">å¤åˆ¶</button>
            <button onclick="showSub6Qr()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">äºŒç»´ç </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¢é˜…äºŒç»´ç å¼¹çª— -->
    <div id="sub-qr-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm" onclick="if(event.target===this)hideSubQr()">
      <div class="glass-solid rounded-2xl p-5 w-[92%] max-w-sm border border-white/10">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-white font-semibold text-sm">ğŸ“± æ‰«ç æ·»åŠ è®¢é˜…</h3>
          <button onclick="hideSubQr()" class="text-gray-400 hover:text-white text-lg leading-none">âœ•</button>
        </div>
        <p class="text-gray-400 text-xs mb-3">ç”¨æ‰‹æœºå®¢æˆ·ç«¯æ‰«ç å³å¯å¯¼å…¥å½“å‰è´¦å·è®¢é˜…é“¾æ¥</p>
        <div class="bg-white rounded-xl p-3 mx-auto w-fit mb-3">
          <img id="sub-qr-img" alt="è®¢é˜…äºŒç»´ç " class="w-[220px] h-[220px] block" />
        </div>
        <p class="text-[11px] text-gray-500 break-all font-mono select-all" id="sub-qr-text"></p>
      </div>
    </div>

    <!-- èœœæ¡ƒé…±å¡ç‰‡å·²ç§»é™¤ï¼Œæ•°æ®å±•ç¤ºåœ¨æ°”æ³¡é¢æ¿ä¸­ -->

    <!-- èŠ‚ç‚¹åˆ—è¡¨ï¼ˆæŒ‰åˆ†ç»„å±•ç¤ºï¼‰ -->
    <div>
      <div class="flex items-center justify-between mb-3 gap-2">
        <h2 class="text-white font-semibold">ğŸŒ å¯ç”¨èŠ‚ç‚¹</h2>
        <div class="flex items-center gap-2">
          <span class="text-gray-600 text-xs"><%= userNodes.length %> ä¸ªèŠ‚ç‚¹</span>
        </div>
      </div>
      <div class="mb-3">
        <input id="node-search" type="text" placeholder="æœç´¢èŠ‚ç‚¹å / åœ°åŒº / æ ‡ç­¾..." oninput="filterNodes(this.value)" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" />
      </div>
      <%
        // æŒ‰ group_name åˆ†ç»„
        const _groups = {};
        userNodes.forEach(n => {
          const g = n.group_name || 'é»˜è®¤';
          if (!_groups[g]) _groups[g] = [];
          _groups[g].push(n);
        });
        const _groupNames = Object.keys(_groups).sort((a, b) => a === 'é»˜è®¤' ? 1 : b === 'é»˜è®¤' ? -1 : a.localeCompare(b));
      %>
      <% _groupNames.forEach(gName => { %>
        <% if (_groupNames.length > 1) { %>
        <h3 class="text-gray-400 text-sm font-medium mb-2 mt-4 flex items-center gap-1.5">
          <span class="w-1 h-4 rounded-full bg-rose-500/50"></span> <%= gName %>
          <span class="text-gray-600 text-xs">(<%= _groups[gName].length %>)</span>
        </h3>
        <% } %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 node-card-grid mb-3">
        <% if (userNodes.length === 0 && gName === _groupNames[0]) { %>
          <div class="glass rounded-2xl p-8 col-span-full text-center">
            <p class="text-gray-500">æš‚æ— å¯ç”¨èŠ‚ç‚¹</p>
          </div>
        <% } else { _groups[gName].forEach(function(n) { %>
          <div class="glass rounded-2xl p-4 node-card" data-search="<%= (n.name || '') + ' ' + (n.region || '') + ' ' + (n.tags || '') %>">
            <div class="flex items-center justify-between mb-2.5">
              <div class="flex items-center gap-2 min-w-0">
                <% if (n.remark && n.remark.includes('è¢«å¢™')) { %>
                  <span class="shrink-0 inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="è¢«å¢™"></span>
                <% } else if (n.remark && n.remark.includes('ç¦»çº¿')) { %>
                  <span class="shrink-0 inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="ç¦»çº¿"></span>
                <% } else if (n.is_active) { %>
                  <span class="shrink-0 inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="åœ¨çº¿"></span>
                <% } else { %>
                  <span class="shrink-0 inline-block w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_6px_rgba(250,204,21,0.6)]" title="æ£€æµ‹ä¸­"></span>
                <% } %>
                <h3 class="text-white font-semibold text-sm truncate"><%= n.name %></h3>
              </div>
              <div class="flex items-center gap-1.5 shrink-0">
                <% if (nodeAiTags[n.id] && nodeAiTags[n.id].includes('ai_swap')) { %>
                  <span class="text-[9px] px-1.5 py-0.5 rounded-full bg-amber-500/20 text-amber-300 whitespace-nowrap">ğŸ”„ AIæ¢IP</span>
                <% } %>
              </div>
            </div>
            <% if (n.region) { %><p class="text-gray-400 text-xs mb-3"><%= n.region %><% if (n.tags) { %> Â· <span class="text-gray-500 text-[11px]"><%= n.tags %></span><% } %></p><% } %>
            <div class="bg-black/30 rounded-lg p-2.5 mb-2.5 overflow-hidden">
              <code class="text-rose-300 text-[11px] break-all select-all font-mono vless-link leading-relaxed block max-h-20 overflow-y-auto" id="link-<%= n.id %>"><%= n.link %></code>
            </div>
            <button onclick="copyLink(<%= n.id %>)" class="w-full bg-rose-600/80 hover:bg-rose-500 focus-visible:ring-2 focus-visible:ring-rose-400 focus-visible:outline-none text-white text-xs py-2.5 rounded-lg transition font-medium">å¤åˆ¶é“¾æ¥</button>
          </div>
        <% }); } %>
      </div>
      <% }); %>
    </div>

    <!-- æµé‡ä½¿ç”¨æ˜ç»† (å·²ç§»é™¤) -->
  </main>

  <script nonce="<%= nonce %>">
    function copyLink(id) {
      navigator.clipboard.writeText(document.getElementById('link-' + id).textContent).then(() => toast('âœ… é“¾æ¥å·²å¤åˆ¶'));
    }
    function copySubLink() {
      navigator.clipboard.writeText(document.getElementById('sub-link').value).then(() => toast('âœ… è®¢é˜…é“¾æ¥å·²å¤åˆ¶'));
    }
    function showSubQr() {
      const link = document.getElementById('sub-link').value;
      const modal = document.getElementById('sub-qr-modal');
      const img = document.getElementById('sub-qr-img');
      document.getElementById('sub-qr-text').textContent = link;
      img.src = '/sub-qr?t=' + Date.now();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function hideSubQr() {
      const modal = document.getElementById('sub-qr-modal');
      modal.classList.remove('flex');
      modal.classList.add('hidden');
    }
    function copySub6Link() {
      navigator.clipboard.writeText(document.getElementById('sub6-link').value).then(() => toast('âœ… IPv6 è®¢é˜…é“¾æ¥å·²å¤åˆ¶'));
    }
    function showSub6Qr() {
      const link = document.getElementById('sub6-link').value;
      const modal = document.getElementById('sub-qr-modal');
      const img = document.getElementById('sub-qr-img');
      document.getElementById('sub-qr-text').textContent = link;
      // ç”¨é€šç”¨ QR ç”Ÿæˆï¼ˆå¤ç”¨åŒä¸€å¼¹çª—ï¼ŒåŠ¨æ€ç”ŸæˆäºŒç»´ç ï¼‰
      img.src = '/sub6-qr?t=' + Date.now();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function filterNodes(keyword) {
      const q = (keyword || '').trim().toLowerCase();
      document.querySelectorAll('.node-card').forEach(card => {
        const text = (card.dataset.search || '').toLowerCase();
        card.style.display = !q || text.includes(q) ? '' : 'none';
      });
    }

    // formatBytes å‰ç«¯ç‰ˆæœ¬
    function fmtBytes(b) {
      if (b <= 0) return '0 B';
      const u = ['B','KB','MB','GB','TB'];
      const i = Math.min(Math.floor(Math.log(b) / Math.log(1024)), u.length - 1);
      return (b / Math.pow(1024, i)).toFixed(i > 0 ? 2 : 0) + ' ' + u[i];
    }

    // å®æ—¶åˆ·æ–°ç»Ÿè®¡æ•°æ®ï¼ˆæ¯ 30 ç§’ï¼‰
    function refreshStats() {
      fetch('/api/stats').then(r => r.json()).then(d => {
        const el = document.getElementById('online-count');
        if (el) el.textContent = (d.online || 0) + ' äºº';
        const gt = document.getElementById('global-traffic');
        if (gt) gt.textContent = fmtBytes((d.globalUp || 0) + (d.globalDown || 0));
        const ut = document.getElementById('used-traffic');
        if (ut) ut.textContent = fmtBytes(d.totalUsed || 0);
        const rt = document.getElementById('remaining-traffic');
        if (rt) {
          // ä¿ç•™åˆ°æœŸä¿¡æ¯ span
          const expirySpan = rt.querySelector('span');
          const txt = d.remaining < 0 ? 'âˆ' : fmtBytes(d.remaining);
          if (expirySpan) {
            rt.childNodes[0].textContent = txt + ' ';
          } else {
            rt.textContent = txt;
          }
        }
      }).catch(() => {});
    }
    refreshStats();
    setInterval(refreshStats, 30000);

    // è®¢é˜…é‡ç½®å€’è®¡æ—¶
    const nextUuidResetAt = <%- JSON.stringify(nextUuidResetAt || 0) %>;
    const nextSubResetAt = <%- JSON.stringify(nextSubResetAt || 0) %>;

    function fmtCountdown(ms) {
      if (ms <= 0) return 'å³å°†é‡ç½®';
      const s = Math.floor(ms / 1000);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      if (d > 0) return `${d}å¤© ${h}å°æ—¶ ${m}åˆ†é’Ÿ`;
      if (h > 0) return `${h}å°æ—¶ ${m}åˆ†é’Ÿ`;
      return `${m}åˆ†é’Ÿ`;
    }

    function tickResetCountdown() {
      const now = Date.now();
      const u = document.getElementById('uuid-reset-countdown');
      const t = document.getElementById('sub-reset-countdown');
      if (u) u.textContent = fmtCountdown(nextUuidResetAt - now);
      if (t) t.textContent = fmtCountdown(nextSubResetAt - now);
    }
    tickResetCountdown();
    setInterval(tickResetCountdown, 30000);

    loadTrafficDetail = function(){};
  </script>

  <!-- ğŸ‘ èœœæ¡ƒé…±æµ®åŠ¨æ°”æ³¡ -->
  <div id="peach-bubble" onclick="togglePeachPanel()" style="position:fixed;bottom:max(20px, env(safe-area-inset-bottom, 0px) + 12px);right:max(16px, env(safe-area-inset-right, 0px) + 8px);z-index:999;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#f43f5e,#f97316);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(244,63,94,0.4);font-size:24px;transition:all .3s" role="button" aria-label="èœœæ¡ƒé…±çŠ¶æ€é¢æ¿" tabindex="0">
    ğŸ‘
    <span style="position:absolute;top:2px;right:2px;width:10px;height:10px;border-radius:50%;background:#34d399;border:2px solid #0f0b1e;animation:pulse 2s infinite" aria-hidden="true"></span>
  </div>

  <!-- èœœæ¡ƒé…±å±•å¼€é¢æ¿ -->
  <div id="peach-panel" style="display:none;position:fixed;bottom:max(80px, env(safe-area-inset-bottom, 0px) + 72px);right:max(16px, env(safe-area-inset-right, 0px) + 8px);z-index:998;width:min(300px, calc(100vw - 32px));background:rgba(15,11,30,0.95);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,0.6);max-height:calc(100vh - 120px);overflow-y:auto">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
      <span style="font-size:20px">ğŸ‘</span>
      <span style="color:#fff;font-size:14px;font-weight:600">èœœæ¡ƒé…±å®ˆæŠ¤ä¸­</span>
      <span style="width:8px;height:8px;border-radius:50%;background:#34d399;animation:pulse 2s infinite"></span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
      <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:8px;text-align:center">
        <p style="color:#fff;font-size:14px;font-weight:700" id="pb-patrols">-</p>
        <p style="color:#6b7280;font-size:10px">ä»Šæ—¥å·¡æ£€</p>
      </div>
      <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:8px;text-align:center">
        <p style="color:#fbbf24;font-size:14px;font-weight:700" id="pb-swaps">-</p>
        <p style="color:#6b7280;font-size:10px">ä»Šæ—¥æ¢IP</p>
      </div>
    </div>
    <div style="margin-bottom:8px">
      <p style="color:#9ca3af;font-size:10px;margin-bottom:6px">æœ€è¿‘åŠ¨æ€</p>
      <div id="pb-events" style="max-height:140px;overflow-y:auto"></div>
    </div>
    <p style="color:#4b5563;font-size:9px;text-align:center">æœ€è¿‘å·¡æ£€: <span id="pb-last">-</span></p>
  </div>

  <style nonce="<%= nonce %>">@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}</style>

  <!-- èœœæ¡ƒé…±æ•°æ®åŠ è½½ -->
  <script nonce="<%= nonce %>">
  (function(){
    function esc(s){if(s==null)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
    const icons = {health_check:'ğŸ’“',auto_swap_ip:'ğŸ”„',swap_ip:'ğŸ”„',ip_rotated:'ğŸ”„',node_recovered:'âœ…',auto_repair:'ğŸ”§',deploy:'ğŸš€',node_blocked:'ğŸš«',node_xray_down:'ğŸ”´'};
    async function loadPeach() {
      try {
        const r = await fetch('/api/peach-status');
        const d = await r.json();
        // é¡¶éƒ¨æˆå°±æ 
        const el = id => document.getElementById(id);
        const set = (id, v) => { const e = el(id); if(e) e.textContent = v; };
        set('peach-days', d.uptimeDays + ' å¤©');
        set('peach-patrols', d.totalPatrols);
        set('peach-fixes', d.totalSwaps + d.totalFixes);
        set('peach-avail', d.nodeAvailability + '%');
        // æ°”æ³¡é¢æ¿
        el('pb-patrols').textContent = d.todayPatrols;
        el('pb-swaps').textContent = d.todaySwaps;
        el('pb-last').textContent = d.lastPatrol ? d.lastPatrol.replace('T',' ').slice(0,16) : 'æš‚æ— ';
        const evDiv = el('pb-events');
        if (d.recentEvents && d.recentEvents.length) {
          evDiv.innerHTML = d.recentEvents.map(e =>
            '<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.03)">' +
            '<span style="font-size:12px">' + (icons[e.action]||'ğŸ“‹') + '</span>' +
            '<div style="flex:1;min-width:0"><p style="color:#d1d5db;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + esc(e.detail||e.action) + '</p>' +
            '<p style="color:#6b7280;font-size:9px">' + esc(e.time) + '</p></div></div>'
          ).join('');
        } else {
          evDiv.innerHTML = '<p style="color:#6b7280;font-size:11px;text-align:center;padding:8px 0">æš‚æ— è¿ç»´äº‹ä»¶</p>';
        }
      } catch(e) { console.error('peach error', e); }
    }
    loadPeach();
    setInterval(loadPeach, 60000);
  })();
  function togglePeachPanel() {
    const p = document.getElementById('peach-panel');
    p.style.display = p.style.display === 'none' ? 'block' : 'none';
  }
  // é”®ç›˜è§¦å‘æ°”æ³¡
  document.getElementById('peach-bubble').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); togglePeachPanel(); }
  });
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#peach-bubble') && !e.target.closest('#peach-panel')) {
      document.getElementById('peach-panel').style.display = 'none';
    }
  });
  </script>

  <!-- å“ç‰Œæ ‡è¯† -->
  <div style="text-align:center;padding:16px 0 24px;color:#4b5563;font-size:11px">
    ç”± ğŸ‘ èœœæ¡ƒé…± AI æ— äººå€¼å®ˆè¿ç»´
  </div>

<%- include('partials/foot') %>
