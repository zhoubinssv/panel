<%- include('partials/head', { title: 'èŠ‚ç‚¹é¢æ¿' }) %>

  <!-- å¯¼èˆª -->
  <nav class="glass-solid sticky top-0 z-40 px-6 py-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center text-sm">ğŸ‘</div>
        <span class="text-white font-semibold hidden sm:block">å°å§¨å­çš„è¯±æƒ‘</span>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-gray-300 text-sm hidden sm:block"><%= user.name || user.username %></span>
        <% if (user.is_admin) { %><a href="/admin" class="text-xs px-3 py-1.5 rounded-full bg-amber-500/20 text-amber-300 hover:bg-amber-500/30 transition">ç®¡ç†</a><% } %>
        <a href="/auth/logout" class="text-xs px-3 py-1.5 rounded-full glass text-gray-300 hover:text-red-400 transition">é€€å‡º</a>
      </div>
    </div>
  </nav>

  <% if (announcement) { %>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 mt-4">
    <div class="bg-rose-500/10 border border-rose-500/20 rounded-2xl">
      <div class="px-4 py-2 flex items-center gap-2 text-xs">
        <span class="text-rose-400 shrink-0">ğŸ“¢</span>
        <div class="marquee-wrap">
          <span class="animate-marquee text-rose-200/80"><%= announcement %></span>
        </div>
      </div>
    </div>
  </div>
  <% } %>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6 space-y-6">

    <!-- æµé‡æ¦‚è§ˆ -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#f43f5e">
        <p class="text-gray-500 text-xs mb-1">èŠ‚ç‚¹åœ¨çº¿ç”¨æˆ·</p>
        <p class="text-rose-400 text-lg font-bold" id="online-count">-</p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#8b5cf6">
        <p class="text-gray-500 text-xs mb-1">å…¨ç«™å·²ç”¨</p>
        <p class="text-violet-400 text-lg font-bold"><%= formatBytes(globalTraffic.total_up + globalTraffic.total_down) %></p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#fb923c">
        <p class="text-gray-500 text-xs mb-1">å·²ç”¨æµé‡</p>
        <p class="text-orange-400 text-lg font-bold"><%= formatBytes(traffic.total_up + traffic.total_down) %></p>
      </div>
      <div class="glass rounded-2xl p-4 stat-card" style="--accent-color:#06b6d4">
        <p class="text-gray-500 text-xs mb-1">å‰©ä½™æµé‡</p>
        <p class="text-cyan-400 text-lg font-bold"><%= trafficLimit > 0 ? formatBytes(Math.max(0, trafficLimit - traffic.total_up - traffic.total_down)) : 'âˆ' %></p>
      </div>
    </div>

    <!-- è®¢é˜…é“¾æ¥ -->
    <div class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-3 flex-wrap gap-1.5">
        <h2 class="text-white font-semibold text-sm">ğŸ“¡ ä¸ªäººè®¢é˜…</h2>
        <div class="text-[11px] text-gray-300 text-right">
          <div>UUID ä¸‹æ¬¡é‡ç½®ï¼š<span id="uuid-reset-countdown" class="text-rose-300">è®¡ç®—ä¸­...</span></div>
          <div>è®¢é˜…é“¾æ¥ä¸‹æ¬¡é‡ç½®ï¼š<span id="sub-reset-countdown" class="text-cyan-300">è®¡ç®—ä¸­...</span></div>
        </div>
      </div>
      <div class="flex gap-2">
        <input type="text" readonly value="<%= subUrl %>" id="sub-link"
               class="flex-1 bg-black/30 text-rose-300 text-xs px-4 py-2.5 rounded-xl border border-white/5 font-mono">
        <button onclick="copySubLink()" class="bg-rose-600 hover:bg-rose-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">å¤åˆ¶</button>
        <button onclick="showSubQr()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl text-sm transition font-medium">äºŒç»´ç </button>
      </div>
    </div>

    <!-- è®¢é˜…äºŒç»´ç å¼¹çª— -->
    <div id="sub-qr-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm" onclick="if(event.target===this)hideSubQr()">
      <div class="glass-solid rounded-2xl p-5 w-[92%] max-w-sm border border-white/10">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-white font-semibold text-sm">ğŸ“± æ‰«ç æ·»åŠ è®¢é˜…</h3>
          <button onclick="hideSubQr()" class="text-gray-400 hover:text-white text-lg leading-none">âœ•</button>
        </div>
        <p class="text-gray-400 text-xs mb-3">ç”¨æ‰‹æœºå®¢æˆ·ç«¯æ‰«ç å³å¯å¯¼å…¥å½“å‰è´¦å·è®¢é˜…é“¾æ¥</p>
        <div class="bg-white rounded-xl p-3 mx-auto w-fit mb-3">
          <img id="sub-qr-img" alt="è®¢é˜…äºŒç»´ç " class="w-[220px] h-[220px] block" />
        </div>
        <p class="text-[11px] text-gray-500 break-all font-mono select-all" id="sub-qr-text"></p>
      </div>
    </div>

    <!-- èŠ‚ç‚¹åˆ—è¡¨ -->
    <div>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-white font-semibold">ğŸŒ å¯ç”¨èŠ‚ç‚¹</h2>
        <span class="text-gray-600 text-xs"><%= userNodes.length %> ä¸ªèŠ‚ç‚¹</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 node-card-grid">
        <% if (userNodes.length === 0) { %>
          <div class="glass rounded-2xl p-8 col-span-full text-center">
            <p class="text-gray-500">æš‚æ— å¯ç”¨èŠ‚ç‚¹</p>
          </div>
        <% } else { userNodes.forEach(function(n) { %>
          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-white font-medium text-sm"><%= n.name %></h3>
              <% if (n.remark && n.remark.includes('è¢«å¢™')) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="è¢«å¢™"></span>
              <% } else if (n.remark && n.remark.includes('ç¦»çº¿')) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="ç¦»çº¿"></span>
              <% } else if (n.is_active) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="åœ¨çº¿"></span>
              <% } else { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_6px_rgba(250,204,21,0.6)]" title="æ£€æµ‹ä¸­"></span>
              <% } %>
            </div>
            <% if (n.region) { %><p class="text-gray-500 text-xs mb-3"><%= n.region %></p><% } %>
            <div class="bg-black/30 rounded-lg p-2.5 mb-2.5 overflow-hidden">
              <code class="text-rose-300 text-[11px] break-all select-all font-mono vless-link leading-relaxed block max-h-20 overflow-y-auto" id="link-<%= n.id %>"><%= n.link %></code>
            </div>
            <button onclick="copyLink(<%= n.id %>)" class="w-full bg-rose-600/80 hover:bg-rose-500 text-white text-xs py-2 rounded-lg transition">å¤åˆ¶é“¾æ¥</button>
          </div>
        <% }); } %>
      </div>
    </div>
  </main>

  <script>
    function copyLink(id) {
      navigator.clipboard.writeText(document.getElementById('link-' + id).textContent).then(() => toast('âœ… é“¾æ¥å·²å¤åˆ¶'));
    }
    function copySubLink() {
      navigator.clipboard.writeText(document.getElementById('sub-link').value).then(() => toast('âœ… è®¢é˜…é“¾æ¥å·²å¤åˆ¶'));
    }
    function showSubQr() {
      const link = document.getElementById('sub-link').value;
      const modal = document.getElementById('sub-qr-modal');
      const img = document.getElementById('sub-qr-img');
      document.getElementById('sub-qr-text').textContent = link;
      img.src = '/sub-qr?t=' + Date.now();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function hideSubQr() {
      const modal = document.getElementById('sub-qr-modal');
      modal.classList.remove('flex');
      modal.classList.add('hidden');
    }

    // åŠ è½½åœ¨çº¿äººæ•°
    fetch('/online-count').then(r=>r.json()).then(d=>{
      const el = document.getElementById('online-count');
      if (el) el.textContent = d.online + ' äºº';
    }).catch(()=>{});

    // è®¢é˜…é‡ç½®å€’è®¡æ—¶
    const nextUuidResetAt = <%- JSON.stringify(nextUuidResetAt || 0) %>;
    const nextSubResetAt = <%- JSON.stringify(nextSubResetAt || 0) %>;

    function fmtCountdown(ms) {
      if (ms <= 0) return 'å³å°†é‡ç½®';
      const s = Math.floor(ms / 1000);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      if (d > 0) return `${d}å¤© ${h}å°æ—¶ ${m}åˆ†é’Ÿ`;
      if (h > 0) return `${h}å°æ—¶ ${m}åˆ†é’Ÿ`;
      return `${m}åˆ†é’Ÿ`;
    }

    function tickResetCountdown() {
      const now = Date.now();
      const u = document.getElementById('uuid-reset-countdown');
      const t = document.getElementById('sub-reset-countdown');
      if (u) u.textContent = fmtCountdown(nextUuidResetAt - now);
      if (t) t.textContent = fmtCountdown(nextSubResetAt - now);
    }
    tickResetCountdown();
    setInterval(tickResetCountdown, 30000);
  </script>
<%- include('partials/foot') %>
