<!-- æèµ ç®¡ç† Tab -->
<div class="tab-panel space-y-4" data-tab="donations">
  <div class="flex flex-wrap gap-2 mb-2">
    <button onclick="loadDonations()" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">ğŸ”„ åˆ·æ–°</button>
    <span id="donations-count" class="text-gray-500 text-xs self-center ml-2"></span>
  </div>

  <div id="donations-list" class="space-y-2">
    <p class="text-gray-500 text-sm">åŠ è½½ä¸­...</p>
  </div>
</div>

<script nonce="<%= nonce %>">
function loadDonations() {
  fetch('/admin/api/donations').then(r => r.json()).then(d => {
    if (!d.ok) return;
    const list = document.getElementById('donations-list');
    const count = document.getElementById('donations-count');
    const items = d.donations;
    count.textContent = `å…± ${items.length} æ¡`;
    if (!items.length) { list.innerHTML = '<p class="text-gray-500 text-sm">æš‚æ— æèµ è®°å½•</p>'; return; }
    list.innerHTML = items.map(dn => {
      const statusMap = {
        pending: { text: 'â³ ç­‰å¾…è¿æ¥', cls: 'text-amber-400' },
        online: { text: 'âœ… åœ¨çº¿', cls: 'text-green-400' },
        offline: { text: 'âš« ç¦»çº¿', cls: 'text-gray-400' },
        rejected: { text: 'âŒ å·²æ‹’ç»', cls: 'text-red-400' }
      };
      const st = statusMap[dn.status] || { text: dn.status, cls: 'text-gray-400' };
      const ip = dn.server_ip || 'æœªè¿æ¥';
      const user = dn.user_name || dn.username || 'æœªçŸ¥';
      const time = dn.created_at || '';
      const actions = dn.status === 'pending' || dn.status === 'offline'
        ? `<button onclick="approveDonation(${dn.id})" class="text-xs px-3 py-1 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 transition">âœ… é€šè¿‡</button>
           <button onclick="rejectDonation(${dn.id})" class="text-xs px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition">âŒ æ‹’ç»</button>`
        : dn.status === 'rejected'
        ? `<button onclick="deleteDonation(${dn.id})" class="text-xs px-3 py-1 rounded-lg bg-gray-500/20 text-gray-400 hover:bg-gray-500/30 transition">ğŸ—‘ åˆ é™¤</button>`
        : `<span class="text-xs text-gray-600">èŠ‚ç‚¹#${dn.node_id || '-'}</span>`;
      return `<div class="glass rounded-xl p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div class="space-y-1">
          <div class="flex items-center gap-2">
            <span class="text-white text-sm font-medium">${ip}</span>
            <span class="text-xs ${st.cls}">${st.text}</span>
          </div>
          <div class="text-xs text-gray-500">æèµ è€…: ${user} Â· ${dn.region || 'æœªçŸ¥åœ°åŒº'} Â· ${time}</div>
        </div>
        <div class="flex gap-2 shrink-0">${actions}</div>
      </div>`;
    }).join('');
  });
}

function approveDonation(id) {
  const name = prompt('èŠ‚ç‚¹åç§°ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰:', '');
  const group = prompt('åˆ†ç»„åç§°:', 'æèµ èŠ‚ç‚¹');
  fetch('/admin/api/donations/' + id + '/approve', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name || '', group_name: group || 'æèµ èŠ‚ç‚¹' })
  }).then(r => r.json()).then(d => {
    if (d.ok) { showToast('âœ… å·²é€šè¿‡ï¼ŒèŠ‚ç‚¹å·²åˆ›å»º'); loadDonations(); }
    else showToast('âŒ ' + (d.error || 'æ“ä½œå¤±è´¥'), 'error');
  });
}

function rejectDonation(id) {
  if (!confirm('ç¡®å®šæ‹’ç»è¯¥æèµ ï¼Ÿ')) return;
  fetch('/admin/api/donations/' + id + '/reject', { method: 'POST' })
    .then(r => r.json()).then(d => {
      if (d.ok) { showToast('å·²æ‹’ç»'); loadDonations(); }
      else showToast('âŒ ' + (d.error || 'æ“ä½œå¤±è´¥'), 'error');
    });
}

function deleteDonation(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ')) return;
  fetch('/admin/api/donations/' + id, { method: 'DELETE' })
    .then(r => r.json()).then(d => {
      if (d.ok) { showToast('å·²åˆ é™¤'); loadDonations(); }
      else showToast('âŒ æ“ä½œå¤±è´¥', 'error');
    });
}

// åˆ‡æ¢åˆ°è¯¥tabæ—¶è‡ªåŠ¨åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
  const observer = new MutationObserver(() => {
    const panel = document.querySelector('[data-tab="donations"]');
    if (panel && !panel.classList.contains('hidden')) loadDonations();
  });
  const panel = document.querySelector('[data-tab="donations"]');
  if (panel) observer.observe(panel, { attributes: true, attributeFilter: ['class'] });
});
</script>
