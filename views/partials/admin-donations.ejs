<!-- æèµ ç®¡ç† Tab -->
<div class="tab-panel space-y-4" data-tab="donations">
  <div class="flex flex-wrap gap-2 mb-2">
    <button onclick="loadDonations()" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">ğŸ”„ åˆ·æ–°</button>
    <span id="donations-count" class="text-gray-500 text-xs self-center ml-2"></span>
  </div>

  <div id="donations-list" class="space-y-2">
    <p class="text-gray-500 text-sm">ç‚¹å‡»ã€ŒğŸ æèµ ã€æ ‡ç­¾åŠ è½½æ•°æ®</p>
  </div>
</div>

<script nonce="<%= nonce %>">
function loadDonations() {
  fetch('/admin/api/donations', { headers: { 'X-CSRF-Token': _csrf } }).then(r => r.json()).then(d => {
    if (!d.ok) return;
    const list = document.getElementById('donations-list');
    const count = document.getElementById('donations-count');
    const items = d.donations;
    count.textContent = `å…± ${items.length} æ¡`;
    if (!items.length) { list.innerHTML = '<p class="text-gray-500 text-sm">æš‚æ— æèµ è®°å½•</p>'; return; }
    list.innerHTML = items.map(dn => {
      const statusMap = {
        pending: { text: 'â³ å¾…å®¡æ ¸', cls: 'text-amber-400' },
        online: { text: 'âœ… åœ¨çº¿', cls: 'text-green-400' },
        offline: { text: 'âš« ç¦»çº¿', cls: 'text-gray-400' },
        rejected: { text: 'âŒ å·²æ‹’ç»', cls: 'text-red-400' }
      };
      const st = statusMap[dn.status] || { text: dn.status, cls: 'text-gray-400' };
      const ip = dn.server_ip || 'æœªçŸ¥';
      const user = dn.user_name || dn.username || 'æœªçŸ¥';
      const time = dn.created_at || '';
      const actions = dn.status === 'pending' || dn.status === 'offline'
        ? `<button onclick="approveDonation(${dn.id})" class="text-xs px-3 py-1 rounded-lg bg-emerald-600/40 text-emerald-300 hover:bg-emerald-600/60 border border-emerald-500/30 transition">âœ… é€šè¿‡</button>
           <button onclick="rejectDonation(${dn.id})" class="text-xs px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition">âŒ æ‹’ç»</button>`
        : dn.status === 'rejected'
        ? `<button onclick="deleteDonation(${dn.id})" class="text-xs px-3 py-1 rounded-lg bg-gray-500/20 text-gray-400 hover:bg-gray-500/30 transition">ğŸ—‘ åˆ é™¤</button>`
        : `<span class="text-xs text-gray-400">${dn.node_name || "èŠ‚ç‚¹#"+dn.node_id}</span>`;
      return `<div class="glass rounded-xl p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <div class="space-y-1">
          <div class="flex items-center gap-2">
            <span class="text-white text-sm font-medium">${ip}</span>
            <span class="text-xs ${st.cls}">${st.text}</span>
          </div>
          <div class="text-xs text-gray-500">æèµ è€…: ${user} Â· ${dn.region || 'æœªçŸ¥åœ°åŒº'} Â· ${time}</div>
        </div>
        <div class="flex gap-2 shrink-0">${actions}</div>
      </div>`;
    }).join('');
  });
}

async function approveDonation(id) {
  const ok = await _confirm('ç¡®å®šé€šè¿‡ï¼ŸèŠ‚ç‚¹å°†è‡ªåŠ¨å‘½åå¹¶åŠ å…¥ã€Œæèµ èŠ‚ç‚¹ã€åˆ†ç»„');
  if (!ok) return;
  fetch('/admin/api/donations/' + id + '/approve', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
    body: JSON.stringify({ name: '', group_name: 'æèµ èŠ‚ç‚¹' })
  }).then(r => r.json()).then(d => {
    if (d.ok) { showToast('âœ… å·²é€šè¿‡ï¼ŒèŠ‚ç‚¹å·²åˆ›å»º'); loadDonations(); }
    else showToast('âŒ ' + (d.error || 'æ“ä½œå¤±è´¥'), 3000);
  });
}

async function rejectDonation(id) {
  const ok = await _confirm('ç¡®å®šæ‹’ç»è¯¥æèµ ï¼Ÿ');
  if (!ok) return;
  fetch('/admin/api/donations/' + id + '/reject', {
    method: 'POST',
    headers: { 'X-CSRF-Token': _csrf }
  }).then(r => r.json()).then(d => {
    if (d.ok) { showToast('å·²æ‹’ç»'); loadDonations(); }
    else showToast('âŒ ' + (d.error || 'æ“ä½œå¤±è´¥'), 3000);
  });
}

async function deleteDonation(id) {
  const ok = await _confirm('ç¡®å®šåˆ é™¤è¯¥è®°å½•ï¼Ÿ');
  if (!ok) return;
  fetch('/admin/api/donations/' + id, {
    method: 'DELETE',
    headers: { 'X-CSRF-Token': _csrf }
  }).then(r => r.json()).then(d => {
    if (d.ok) { showToast('å·²åˆ é™¤'); loadDonations(); }
    else showToast('âŒ æ“ä½œå¤±è´¥', 3000);
  });
}
</script>
