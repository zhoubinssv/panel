<!-- 节点管理 Tab -->
<div class="tab-panel active space-y-4" data-tab="nodes">
  <div class="flex flex-wrap gap-2 mb-2">
    <form method="POST" action="/admin/api/health-check" class="inline">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">🔍 检测状态</button>
    </form>
    <form method="POST" action="/admin/api/rotate" class="inline">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="button" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition" onclick="_confirm('确定轮换？').then(ok=>{if(ok)this.closest('form').submit()})">🔄 手动轮换</button>
    </form>
  </div>

  <div class="glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs">
          <tr>
            <th class="py-3 px-4">名称</th><th class="py-3 px-4">地址</th><th class="py-3 px-4">端口</th>
            <th class="py-3 px-4">等级</th><th class="py-3 px-4">状态</th><th class="py-3 px-4">最后检测</th><th class="py-3 px-4">操作</th>
          </tr>
        </thead>
        <tbody class="text-gray-300">
          <% nodes.forEach(function(n) { %>
          <tr class="border-b border-white/5 hover:bg-white/[0.02]">
            <td class="py-3 px-4 font-medium text-white"><%= n.name %></td>
            <td class="py-3 px-4">
              <code class="text-xs text-gray-400" id="host-display-<%= n.id %>"><%= n.host %></code>
              <form method="POST" action="/admin/api/nodes/<%= n.id %>/update-host" class="hidden mt-1" id="host-form-<%= n.id %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="flex gap-1">
                  <input type="text" name="host" value="<%= n.host %>" class="bg-black/30 text-white px-2 py-1 rounded-lg border border-white/10 text-xs w-32">
                  <button class="text-emerald-400 text-xs">✓</button>
                  <button type="button" onclick="toggleEdit(<%= n.id %>)" class="text-gray-500 text-xs">✕</button>
                </div>
              </form>
            </td>
            <td class="py-3 px-4 text-xs"><%= n.port %></td>
            <td class="py-3 px-4">
              <select onchange="updateNodeLevel(<%= n.id %>, this.value)" class="bg-black/30 text-white text-xs px-2 py-1 rounded-lg border border-white/10">
                <% for (let lv = 0; lv <= 4; lv++) { %>
                <option value="<%= lv %>" <%= (n.min_level||0) === lv ? 'selected' : '' %>>Lv.<%= lv %></option>
                <% } %>
              </select>
            </td>
            <td class="py-3 px-4">
              <% if (n.remark && n.remark.includes('被墙')) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="被墙"></span>
              <% } else if (n.remark && n.remark.includes('离线')) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]" title="离线"></span>
              <% } else if (n.remark && n.remark.includes('部署中')) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_6px_rgba(250,204,21,0.6)]" title="部署中"></span>
              <% } else if (n.is_active) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="在线"></span>
              <% } else { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-500" title="未知"></span>
              <% } %>
            </td>
            <td class="py-3 px-4 text-xs text-gray-500"><%= n.last_check || '-' %></td>
            <td class="py-3 px-4 space-x-2">
              <button onclick="toggleEdit(<%= n.id %>)" class="text-rose-400 hover:text-rose-300 text-xs">编辑</button>
              <form method="POST" action="/admin/api/nodes/<%= n.id %>/delete" class="inline">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="button" class="text-red-400 hover:text-red-300 text-xs" onclick="_confirm('确定删除？').then(ok=>{if(ok)this.closest('form').submit()})">删除</button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 添加节点 -->
  <details class="glass rounded-2xl">
    <summary class="text-rose-400 text-sm cursor-pointer hover:text-rose-300 p-4">➕ 添加节点（SSH 自动部署）</summary>
    <form method="POST" action="/admin/api/nodes/deploy" class="px-4 pb-4 grid grid-cols-2 gap-3">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="text" name="host" placeholder="服务器 IP *" required class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="password" name="ssh_password" placeholder="SSH 密码 *" required class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="number" name="ssh_port" placeholder="SSH 端口（默认 22）" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="text" name="ssh_user" placeholder="SSH 用户名（默认 root）" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <details class="col-span-2">
        <summary class="text-gray-500 text-xs cursor-pointer hover:text-gray-300">🔗 Socks5 落地（可选）</summary>
        <div class="grid grid-cols-2 gap-3 mt-2">
          <input type="text" name="socks5_host" placeholder="Socks5 地址" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="number" name="socks5_port" placeholder="端口（默认 1080）" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="text" name="socks5_user" placeholder="用户名" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="password" name="socks5_pass" placeholder="密码" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
      </details>
      <button class="bg-rose-600 hover:bg-rose-500 text-white py-2.5 rounded-xl text-sm col-span-2 transition font-medium">🚀 部署</button>
    </form>
  </details>
</div>
