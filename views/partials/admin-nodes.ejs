<!-- èŠ‚ç‚¹ç®¡ç† Tab -->
<div class="tab-panel active space-y-4" data-tab="nodes">
  <div class="flex flex-wrap gap-2 mb-2">
    <button onclick="doHealthCheck(this)" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">ğŸ” æ£€æµ‹çŠ¶æ€</button>
    <form method="POST" action="/admin/api/rotate" class="inline">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="button" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition" onclick="_confirm('ç¡®å®šè½®æ¢ï¼Ÿ').then(ok=>{if(ok)this.closest('form').submit()})">ğŸ”„ æ‰‹åŠ¨è½®æ¢</button>
    </form>
    <button onclick="doUpdateAllAgents(this)" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">ğŸ”„ æ›´æ–° Agent</button>
  </div>

  <div class="glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs">
          <tr>
            <th class="py-3 px-2 sm:px-4">åç§°</th><th class="py-3 px-2 sm:px-4">åœ°å€</th><th class="py-3 px-2 sm:px-4">ç«¯å£</th>
            <th class="py-3 px-2 sm:px-4">ç­‰çº§</th><th class="py-3 px-2 sm:px-4">çŠ¶æ€</th><th class="py-3 px-4 hidden sm:table-cell">Agent</th><th class="py-3 px-4 hidden md:table-cell">æœ€åæ£€æµ‹</th><th class="py-3 px-2 sm:px-4">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="text-gray-300">
          <% nodes.forEach(function(n) { %>
          <tr class="border-b border-white/5 hover:bg-white/[0.02]" data-node-id="<%= n.id %>">
            <td class="py-3 px-2 sm:px-4 font-medium text-white text-xs"><%= n.name %></td>
            <td class="py-3 px-2 sm:px-4">
              <code class="text-xs text-gray-400 break-all" id="host-display-<%= n.id %>"><%= n.host %></code>
              <form method="POST" action="/admin/api/nodes/<%= n.id %>/update-host" class="hidden mt-1" id="host-form-<%= n.id %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="flex gap-1">
                  <input type="text" name="host" value="<%= n.host %>" class="bg-black/30 text-white px-2 py-1 rounded-lg border border-white/10 text-xs w-32">
                  <button class="text-emerald-400 text-xs">âœ“</button>
                  <button type="button" onclick="toggleEdit(<%= n.id %>)" class="text-gray-500 text-xs">âœ•</button>
                </div>
              </form>
            </td>
            <td class="py-3 px-2 sm:px-4 text-xs"><%= n.port %></td>
            <td class="py-3 px-2 sm:px-4">
              <select onchange="updateNodeLevel(<%= n.id %>, this.value)" class="bg-black/30 text-white text-xs px-2 py-1 rounded-lg border border-white/10">
                <% for (let lv = 0; lv <= 4; lv++) { %>
                <option value="<%= lv %>" <%= (n.min_level||0) === lv ? 'selected' : '' %>>Lv.<%= lv %></option>
                <% } %>
              </select>
            </td>
            <td class="py-3 px-2 sm:px-4" data-status-cell="<%= n.id %>">
              <div class="flex items-center gap-1.5">
                <% if (n.remark && n.remark.includes('è¢«å¢™')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]"></span>
                  <span class="text-xs text-red-400" title="<%= n.remark %>">ğŸ§± è¢«å¢™</span>
                <% } else if (n.remark && n.remark.includes('ç¦»çº¿')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]"></span>
                  <span class="text-xs text-red-400" title="<%= n.remark %>">ç¦»çº¿</span>
                <% } else if (n.remark && n.remark.includes('éƒ¨ç½²ä¸­')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_6px_rgba(250,204,21,0.6)]"></span>
                  <span class="text-xs text-yellow-400">éƒ¨ç½²ä¸­</span>
                <% } else if (n.is_active) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]"></span>
                  <span class="text-xs text-emerald-400">åœ¨çº¿</span>
                <% } else { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                  <span class="text-xs text-gray-500">æœªçŸ¥</span>
                <% } %>
                <% if (n.remark && !['è¢«å¢™','ç¦»çº¿','éƒ¨ç½²ä¸­'].some(k => n.remark.includes(k))) { %>
                  <span class="text-xs text-gray-500" title="<%= n.remark %>">(<%= n.remark.substring(0, 15) %>)</span>
                <% } %>
              </div>
            </td>
            <td class="py-3 px-4 hidden sm:table-cell" data-agent-cell="<%= n.id %>">
              <% if (onlineAgents.has(n.id)) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="Agent åœ¨çº¿"></span>
              <% } else { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-600" title="Agent ç¦»çº¿"></span>
              <% } %>
            </td>
            <td class="py-3 px-4 text-xs text-gray-500 hidden md:table-cell"><%= n.last_check || '-' %></td>
            <td class="py-3 px-2 sm:px-4 space-x-1 sm:space-x-2">
              <button onclick="toggleEdit(<%= n.id %>)" class="text-rose-400 hover:text-rose-300 text-xs">ç¼–è¾‘</button>
              <button onclick="restartXray(<%= n.id %>, this)" class="text-amber-400 hover:text-amber-300 text-xs">é‡å¯</button>
              <form method="POST" action="/admin/api/nodes/<%= n.id %>/delete" class="inline">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="button" class="text-red-400 hover:text-red-300 text-xs" onclick="_confirm('ç¡®å®šåˆ é™¤ï¼Ÿå°†åœæ­¢è¿œç«¯ Xray å’Œ Agent æœåŠ¡').then(ok=>{if(ok)this.closest('form').submit()})">åˆ é™¤</button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- æ·»åŠ èŠ‚ç‚¹ -->
  <details class="glass rounded-2xl">
    <summary class="text-rose-400 text-sm cursor-pointer hover:text-rose-300 p-4">â• æ·»åŠ èŠ‚ç‚¹ï¼ˆSSH è‡ªåŠ¨éƒ¨ç½²ï¼‰</summary>
    <form method="POST" action="/admin/api/nodes/deploy" class="px-4 pb-4 grid grid-cols-2 gap-3" onsubmit="return validateDeployForm(this)">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="text" name="host" placeholder="æœåŠ¡å™¨ IP *" required pattern="^[a-zA-Z0-9._-]{1,253}$" title="è¯·è¾“å…¥æœ‰æ•ˆçš„ IP æˆ–åŸŸå" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="password" name="ssh_password" placeholder="SSH å¯†ç  *" required minlength="1" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="number" name="ssh_port" placeholder="SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼‰" min="1" max="65535" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="text" name="ssh_user" placeholder="SSH ç”¨æˆ·åï¼ˆé»˜è®¤ rootï¼‰" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <details class="col-span-2">
        <summary class="text-gray-500 text-xs cursor-pointer hover:text-gray-300">ğŸ”— Socks5 è½åœ°ï¼ˆå¯é€‰ï¼‰</summary>
        <div class="grid grid-cols-2 gap-3 mt-2">
          <input type="text" name="socks5_host" placeholder="Socks5 åœ°å€" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="number" name="socks5_port" placeholder="ç«¯å£ï¼ˆé»˜è®¤ 1080ï¼‰" min="1" max="65535" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="text" name="socks5_user" placeholder="ç”¨æˆ·å" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="password" name="socks5_pass" placeholder="å¯†ç " class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
      </details>
      <button class="bg-rose-600 hover:bg-rose-500 text-white py-2.5 rounded-xl text-sm col-span-2 transition font-medium" id="deploy-btn">ğŸš€ éƒ¨ç½²</button>
    </form>
  </details>

</div>

<script>
// CSRF token
const _csrf = '<%= csrfToken %>';

// éƒ¨ç½²è¡¨å•æ ¡éªŒ
function validateDeployForm(form) {
  const host = form.host.value.trim();
  const pwd = form.ssh_password.value;
  if (!host) { toast('è¯·å¡«å†™æœåŠ¡å™¨ IP', 2500, 'error'); form.host.focus(); return false; }
  if (!/^[a-zA-Z0-9._-]{1,253}$/.test(host)) { toast('IP/åŸŸåæ ¼å¼ä¸æ­£ç¡®', 2500, 'error'); form.host.focus(); return false; }
  if (!pwd) { toast('è¯·å¡«å†™ SSH å¯†ç ', 2500, 'error'); form.ssh_password.focus(); return false; }
  const port = form.ssh_port.value;
  if (port && (parseInt(port) < 1 || parseInt(port) > 65535)) { toast('SSH ç«¯å£èŒƒå›´ 1-65535', 2500, 'error'); form.ssh_port.focus(); return false; }
  const btn = document.getElementById('deploy-btn');
  btn.textContent = 'â³ éƒ¨ç½²ä¸­...';
  btn.classList.add('btn-loading');
  return true;
}

// æ£€æµ‹çŠ¶æ€ (AJAX)
async function doHealthCheck(btn) {
  const origText = btn.textContent;
  btn.textContent = 'â³ æ£€æµ‹ä¸­...';
  btn.disabled = true;
  try {
    const resp = await fetch('/admin/api/health-check', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
      body: JSON.stringify({})
    });
    const data = await resp.json();
    if (data.ok && data.results) {
      data.results.forEach(r => {
        const agentCell = document.querySelector(`[data-agent-cell="${r.nodeId}"]`);
        if (agentCell) {
          agentCell.innerHTML = r.agent
            ? `<span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="Agent åœ¨çº¿${r.online ? '' : ' (ping å¤±è´¥)'}"></span>`
            : `<span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-600" title="Agent ç¦»çº¿"></span>`;
        }
      });
      btn.textContent = `âœ… æ£€æµ‹å®Œæˆ (${data.results.filter(r => r.online).length}/${data.results.length})`;
    } else {
      btn.textContent = 'âŒ æ£€æµ‹å¤±è´¥';
    }
  } catch (e) {
    btn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
  }
  setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 3000);
}

// é‡å¯ Xray
async function restartXray(nodeId, btn) {
  const origText = btn.textContent;
  btn.textContent = 'â³';
  btn.disabled = true;
  try {
    const resp = await fetch(`/admin/api/nodes/${nodeId}/restart-xray`, {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
      body: JSON.stringify({})
    });
    const data = await resp.json();
    btn.textContent = data.success ? 'âœ…' : 'âŒ';
  } catch {
    btn.textContent = 'âŒ';
  }
  setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 2000);
}

// æ‰¹é‡æ›´æ–° Agent
async function doUpdateAllAgents(btn) {
  const ok = await _confirm('ç¡®å®šå‘æ‰€æœ‰åœ¨çº¿ Agent å‘é€æ›´æ–°æŒ‡ä»¤ï¼Ÿ');
  if (!ok) return;
  const origText = btn.textContent;
  btn.textContent = 'â³ æ›´æ–°ä¸­...';
  btn.disabled = true;
  try {
    const resp = await fetch('/admin/api/agents/update-all', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
      body: JSON.stringify({})
    });
    const data = await resp.json();
    if (data.ok) {
      const ok = data.results.filter(r => r.success).length;
      btn.textContent = `âœ… ${ok}/${data.results.length} æˆåŠŸ`;
    } else {
      btn.textContent = 'âŒ å¤±è´¥';
    }
  } catch {
    btn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
  }
  setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 3000);
}
</script>
