<!-- èŠ‚ç‚¹ç®¡ç† Tab -->
<div class="tab-panel active space-y-4" data-tab="nodes">
  <div class="flex flex-wrap gap-2 mb-2">
    <button onclick="doHealthCheck(this)" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">ğŸ” æ£€æµ‹çŠ¶æ€</button>
    <form method="POST" action="/admin/api/rotate" class="inline">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="button" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition" onclick="_confirm('ç¡®å®šè½®æ¢ï¼Ÿ').then(ok=>{if(ok)this.closest('form').submit()})">ğŸ”„ æ‰‹åŠ¨è½®æ¢</button>
    </form>
    <button onclick="doUpdateAllAgents(this)" class="glass text-white px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition">ğŸ”„ æ›´æ–° Agent</button>
  </div>

  <!-- ç§»åŠ¨ç«¯å¡ç‰‡å¸ƒå±€ -->
  <div class="sm:hidden space-y-3">
    <% nodes.forEach(function(n) { %>
    <div class="glass rounded-2xl p-4 space-y-3" data-node-id="<%= n.id %>">
      <div class="flex items-center justify-between">
        <span class="font-medium text-white text-sm"><%= n.name %></span>
        <% if (n.protocol === 'ss') { %><span class="text-[10px] bg-cyan-800/60 text-cyan-300 px-1.5 py-0.5 rounded ml-1">SS</span><% } %>
        <% if (n.ip_version === 6) { %><span class="text-[10px] bg-violet-800/60 text-violet-300 px-1.5 py-0.5 rounded ml-0.5">v6</span><% } %>
        <div class="flex items-center gap-1.5" data-status-cell="<%= n.id %>">
          <% if (n.remark && n.remark.includes('è¢«å¢™')) { %>
            <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]"></span>
            <span class="text-xs text-red-400">ğŸ§± è¢«å¢™</span>
          <% } else if (n.remark && n.remark.includes('ç¦»çº¿')) { %>
            <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]"></span>
            <span class="text-xs text-red-400">ç¦»çº¿</span>
          <% } else if (n.remark && n.remark.includes('éƒ¨ç½²ä¸­')) { %>
            <span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_6px_rgba(250,204,21,0.6)]"></span>
            <span class="text-xs text-yellow-400">éƒ¨ç½²ä¸­</span>
          <% } else if (n.is_active) { %>
            <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]"></span>
            <span class="text-xs text-emerald-400">åœ¨çº¿</span>
          <% } else { %>
            <span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-500"></span>
            <span class="text-xs text-gray-500">æœªçŸ¥</span>
          <% } %>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-2 text-xs">
        <div><span class="text-gray-500">åœ°å€</span>
          <code class="block text-gray-400 break-all mt-0.5" id="host-display-m-<%= n.id %>"><%= n.host %></code>
        </div>
        <div><span class="text-gray-500">ç«¯å£</span><span class="block text-gray-300 mt-0.5"><%= n.port %></span></div>
        <div><span class="text-gray-500">ç­‰çº§</span>
          <select onchange="updateNodeLevel(<%= n.id %>, this.value)" class="block mt-0.5 bg-black/30 text-white text-xs px-2 py-1 rounded-lg border border-white/10">
            <% for (let lv = 0; lv <= 4; lv++) { %>
            <option value="<%= lv %>" <%= (n.min_level||0) === lv ? 'selected' : '' %>>Lv.<%= lv %></option>
            <% } %>
          </select>
        </div>
        <div><span class="text-gray-500">åœ¨çº¿</span>
          <% const _ocm = (typeof nodeOnlineCount !== 'undefined' && nodeOnlineCount.get(n.id)) || 0; %>
          <span class="block mt-0.5 text-xs <%= _ocm > 0 ? 'text-emerald-400' : 'text-gray-500' %>"><%= _ocm %> äºº</span>
        </div>
        <div><span class="text-gray-500">Agent</span>
          <span class="block mt-0.5" data-agent-cell="<%= n.id %>">
            <% if (onlineAgents.has(n.id)) { %>
              <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="Agent åœ¨çº¿"></span>
            <% } else { %>
              <span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-600" title="Agent ç¦»çº¿"></span>
            <% } %>
          </span>
        </div>
        <div><span class="text-gray-500">æœ€åæ£€æµ‹</span><span class="block text-gray-500 mt-0.5"><%= n.last_check || '-' %></span></div>
      </div>
      <!-- åœ°å€ç¼–è¾‘è¡¨å• -->
      <form method="POST" action="/admin/api/nodes/<%= n.id %>/update-host" class="hidden" id="host-form-m-<%= n.id %>">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="flex gap-1">
          <input type="text" name="host" value="<%= n.host %>" class="flex-1 bg-black/30 text-white px-2 py-1 rounded-lg border border-white/10 text-xs">
          <button class="text-emerald-400 text-xs">âœ“</button>
          <button type="button" onclick="toggleEdit(<%= n.id %>)" class="text-gray-500 text-xs">âœ•</button>
        </div>
      </form>
      <div class="flex gap-2 pt-1 border-t border-white/5">
        <button onclick="toggleEdit(<%= n.id %>)" class="text-rose-400 hover:text-rose-300 text-xs">ç¼–è¾‘</button>
        <button onclick="restartXray(<%= n.id %>, this)" class="text-amber-400 hover:text-amber-300 text-xs">é‡å¯</button>
        <form method="POST" action="/admin/api/nodes/<%= n.id %>/delete" class="inline">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <button type="button" class="text-red-400 hover:text-red-300 text-xs" onclick="_confirm('ç¡®å®šåˆ é™¤ï¼Ÿå°†åœæ­¢è¿œç«¯ Xray å’Œ Agent æœåŠ¡').then(ok=>{if(ok)this.closest('form').submit()})">åˆ é™¤</button>
        </form>
      </div>
    </div>
    <% }); %>
  </div>

  <!-- æ¡Œé¢ç«¯è¡¨æ ¼å¸ƒå±€ -->
  <div class="hidden sm:block glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs">
          <tr>
            <th class="py-3 px-4">åç§°</th><th class="py-3 px-4">åœ°å€</th><th class="py-3 px-4">ç«¯å£</th>
            <th class="py-3 px-4">ç­‰çº§</th><th class="py-3 px-4">åœ¨çº¿</th><th class="py-3 px-4">çŠ¶æ€</th><th class="py-3 px-4">Agent</th><th class="py-3 px-4 hidden md:table-cell">æœ€åæ£€æµ‹</th><th class="py-3 px-4">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="text-gray-300">
          <% nodes.forEach(function(n) { %>
          <tr class="border-b border-white/5 hover:bg-white/[0.02]" data-node-id="<%= n.id %>">
            <td class="py-3 px-4 font-medium text-white text-xs"><%= n.name %></td>
            <td class="py-3 px-4">
              <code class="text-xs text-gray-400 break-all" id="host-display-<%= n.id %>"><%= n.host %></code>
              <form method="POST" action="/admin/api/nodes/<%= n.id %>/update-host" class="hidden mt-1" id="host-form-<%= n.id %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="flex gap-1">
                  <input type="text" name="host" value="<%= n.host %>" class="bg-black/30 text-white px-2 py-1 rounded-lg border border-white/10 text-xs w-32">
                  <button class="text-emerald-400 text-xs">âœ“</button>
                  <button type="button" onclick="toggleEdit(<%= n.id %>)" class="text-gray-500 text-xs">âœ•</button>
                </div>
              </form>
            </td>
            <td class="py-3 px-4 text-xs"><%= n.port %></td>
            <td class="py-3 px-4">
              <select onchange="updateNodeLevel(<%= n.id %>, this.value)" class="bg-black/30 text-white text-xs px-2 py-1 rounded-lg border border-white/10">
                <% for (let lv = 0; lv <= 4; lv++) { %>
                <option value="<%= lv %>" <%= (n.min_level||0) === lv ? 'selected' : '' %>>Lv.<%= lv %></option>
                <% } %>
              </select>
            </td>
            <td class="py-3 px-4">
              <% const _oc = (typeof nodeOnlineCount !== 'undefined' && nodeOnlineCount.get(n.id)) || 0; %>
              <span class="text-xs <%= _oc > 0 ? 'text-emerald-400' : 'text-gray-500' %>"><%= _oc %> äºº</span>
            </td>
            <td class="py-3 px-4" data-status-cell="<%= n.id %>">
              <div class="flex items-center gap-1.5">
                <% if (n.remark && n.remark.includes('è¢«å¢™')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]"></span>
                  <span class="text-xs text-red-400" title="<%= n.remark %>">ğŸ§± è¢«å¢™</span>
                <% } else if (n.remark && n.remark.includes('ç¦»çº¿')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,0.6)]"></span>
                  <span class="text-xs text-red-400" title="<%= n.remark %>">ç¦»çº¿</span>
                <% } else if (n.remark && n.remark.includes('éƒ¨ç½²ä¸­')) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_6px_rgba(250,204,21,0.6)]"></span>
                  <span class="text-xs text-yellow-400">éƒ¨ç½²ä¸­</span>
                <% } else if (n.is_active) { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]"></span>
                  <span class="text-xs text-emerald-400">åœ¨çº¿</span>
                <% } else { %>
                  <span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                  <span class="text-xs text-gray-500">æœªçŸ¥</span>
                <% } %>
                <% if (n.remark && !['è¢«å¢™','ç¦»çº¿','éƒ¨ç½²ä¸­'].some(k => n.remark.includes(k))) { %>
                  <span class="text-xs text-gray-500" title="<%= n.remark %>">(<%= n.remark.substring(0, 15) %>)</span>
                <% } %>
              </div>
            </td>
            <td class="py-3 px-4" data-agent-cell="<%= n.id %>">
              <% if (onlineAgents.has(n.id)) { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="Agent åœ¨çº¿"></span>
              <% } else { %>
                <span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-600" title="Agent ç¦»çº¿"></span>
              <% } %>
            </td>
            <td class="py-3 px-4 text-xs text-gray-500 hidden md:table-cell"><%= n.last_check || '-' %></td>
            <td class="py-3 px-4 space-x-2">
              <button onclick="toggleEdit(<%= n.id %>)" class="text-rose-400 hover:text-rose-300 text-xs">ç¼–è¾‘</button>
              <button onclick="restartXray(<%= n.id %>, this)" class="text-amber-400 hover:text-amber-300 text-xs">é‡å¯</button>
              <form method="POST" action="/admin/api/nodes/<%= n.id %>/delete" class="inline">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="button" class="text-red-400 hover:text-red-300 text-xs" onclick="_confirm('ç¡®å®šåˆ é™¤ï¼Ÿå°†åœæ­¢è¿œç«¯ Xray å’Œ Agent æœåŠ¡').then(ok=>{if(ok)this.closest('form').submit()})">åˆ é™¤</button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ä¸€é”®éƒ¨ç½² -->
  <details class="glass rounded-2xl">
    <summary class="text-rose-400 text-sm cursor-pointer hover:text-rose-300 p-4">ğŸš€ ä¸€é”®éƒ¨ç½²èŠ‚ç‚¹</summary>
    <form method="POST" action="/admin/api/nodes/deploy-smart" class="px-4 pb-4 grid grid-cols-2 gap-3" onsubmit="return validateSmartDeploy(this)">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="text" name="host" placeholder="æœåŠ¡å™¨ IP *" required class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="password" name="ssh_password" placeholder="SSH å¯†ç  *" required minlength="1" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="number" name="ssh_port" placeholder="SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼‰" min="1" max="65535" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      <input type="text" name="ssh_user" placeholder="SSH ç”¨æˆ·åï¼ˆé»˜è®¤ rootï¼‰" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">

      <!-- åè®®æ»‘å— -->
      <div class="col-span-2 flex items-center py-2" style="gap:2rem">
        <div class="flex items-center gap-2 cursor-pointer select-none" onclick="toggleDeploy('vless')">
          <input type="checkbox" name="enable_vless" checked style="position:absolute;width:0;height:0;opacity:0">
          <div id="sw-vless" style="position:relative;width:40px;height:22px;flex-shrink:0">
            <div id="sw-vless-track" style="position:absolute;inset:0;background:#e11d48;border-radius:11px;transition:background 0.2s"></div>
            <div id="sw-vless-thumb" style="position:absolute;top:2px;left:2px;width:18px;height:18px;background:white;border-radius:50%;transition:transform 0.2s;transform:translateX(18px)"></div>
          </div>
          <span class="text-sm text-white">VLESS <span class="text-gray-400 text-xs">IPv4</span></span>
        </div>
        <div class="flex items-center gap-2 cursor-pointer select-none" onclick="toggleDeploy('ss')">
          <input type="checkbox" name="enable_ss" style="position:absolute;width:0;height:0;opacity:0">
          <div id="sw-ss" style="position:relative;width:40px;height:22px;flex-shrink:0">
            <div id="sw-ss-track" style="position:absolute;inset:0;background:#4b5563;border-radius:11px;transition:background 0.2s"></div>
            <div id="sw-ss-thumb" style="position:absolute;top:2px;left:2px;width:18px;height:18px;background:white;border-radius:50%;transition:transform 0.2s;transform:translateX(0)"></div>
          </div>
          <span class="text-sm text-white">Shadowsocks <span class="text-gray-400 text-xs">IPv6</span></span>
        </div>
      </div>

      <!-- SS åŠ å¯†æ–¹å¼ï¼ˆSS å¼€å¯æ—¶æ˜¾ç¤ºï¼‰ -->
      <div class="col-span-2 hidden" id="ss-method-row">
        <select name="ss_method" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <option value="aes-256-gcm">SS åŠ å¯†ï¼šaes-256-gcmï¼ˆæ¨èï¼‰</option>
          <option value="aes-128-gcm">aes-128-gcm</option>
          <option value="chacha20-ietf-poly1305">chacha20-ietf-poly1305</option>
        </select>
      </div>

      <details class="col-span-2">
        <summary class="text-gray-500 text-xs cursor-pointer hover:text-gray-300">ğŸ”— Socks5 è½åœ°ï¼ˆå¯é€‰ï¼Œä»… VLESSï¼‰</summary>
        <div class="grid grid-cols-2 gap-3 mt-2">
          <input type="text" name="socks5_host" placeholder="Socks5 åœ°å€" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="number" name="socks5_port" placeholder="ç«¯å£ï¼ˆé»˜è®¤ 1080ï¼‰" min="1" max="65535" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="text" name="socks5_user" placeholder="ç”¨æˆ·å" class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <input type="password" name="socks5_pass" placeholder="å¯†ç " class="bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
      </details>

      <p class="text-[11px] col-span-2" id="deploy-hint">
        <span class="text-gray-400">å½“å‰æ¨¡å¼ï¼š</span>
        <span class="text-rose-400" id="deploy-mode-text">ä»… VLESSï¼ˆIPv4ï¼‰</span>
      </p>
      <button class="bg-rose-600 hover:bg-rose-500 text-white py-2.5 rounded-xl text-sm col-span-2 transition font-medium" id="deploy-btn">ğŸš€ éƒ¨ç½²</button>
    </form>
  </details>

</div>

<script nonce="<%= nonce %>">
// CSRF token
const _csrf = '<%= csrfToken %>';

// æ»‘å—å¼€å…³åˆ‡æ¢
function toggleDeploy(type) {
  var cb = document.querySelector('[name="enable_' + type + '"]');
  cb.checked = !cb.checked;
  var track = document.getElementById('sw-' + type + '-track');
  var thumb = document.getElementById('sw-' + type + '-thumb');
  if (cb.checked) {
    track.style.background = type === 'vless' ? '#e11d48' : '#06b6d4';
    thumb.style.transform = 'translateX(18px)';
  } else {
    track.style.background = '#4b5563';
    thumb.style.transform = 'translateX(0)';
  }
  updateDeployHint();
}

// éƒ¨ç½²æ¨¡å¼æç¤ºæ›´æ–°
function updateDeployHint() {
  const vless = document.querySelector('[name="enable_vless"]').checked;
  const ss = document.querySelector('[name="enable_ss"]').checked;
  const modeText = document.getElementById('deploy-mode-text');
  const ssRow = document.getElementById('ss-method-row');
  const btn = document.getElementById('deploy-btn');

  ssRow.classList.toggle('hidden', !ss);

  if (vless && ss) {
    modeText.textContent = 'âš¡ åŒåè®®ï¼ˆVLESS IPv4 + SS IPv6ï¼‰';
    modeText.className = 'text-amber-400';
    btn.className = btn.className.replace(/bg-\w+-600/g, 'bg-amber-600').replace(/hover:bg-\w+-500/g, 'hover:bg-amber-500');
    btn.textContent = 'âš¡ åŒåè®®éƒ¨ç½²';
  } else if (vless) {
    modeText.textContent = 'ä»… VLESSï¼ˆIPv4ï¼‰';
    modeText.className = 'text-rose-400';
    btn.className = btn.className.replace(/bg-\w+-600/g, 'bg-rose-600').replace(/hover:bg-\w+-500/g, 'hover:bg-rose-500');
    btn.textContent = 'ğŸš€ éƒ¨ç½² VLESS';
  } else if (ss) {
    modeText.textContent = 'ä»… Shadowsocksï¼ˆIPv6ï¼‰';
    modeText.className = 'text-cyan-400';
    btn.className = btn.className.replace(/bg-\w+-600/g, 'bg-cyan-600').replace(/hover:bg-\w+-500/g, 'hover:bg-cyan-500');
    btn.textContent = 'ğŸš€ éƒ¨ç½² SS';
  } else {
    modeText.textContent = 'âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåè®®';
    modeText.className = 'text-red-400';
  }
}

// ç»Ÿä¸€éƒ¨ç½²è¡¨å•æ ¡éªŒ
function validateSmartDeploy(form) {
  const host = form.host.value.trim();
  const pwd = form.ssh_password.value;
  const vless = form.enable_vless.checked;
  const ss = form.enable_ss.checked;
  if (!vless && !ss) { toast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåè®®', 2500, 'error'); return false; }
  if (!host) { toast('è¯·å¡«å†™æœåŠ¡å™¨ IP', 2500, 'error'); form.host.focus(); return false; }
  if (!pwd) { toast('è¯·å¡«å†™ SSH å¯†ç ', 2500, 'error'); form.ssh_password.focus(); return false; }
  const btn = document.getElementById('deploy-btn');
  btn.textContent = 'â³ éƒ¨ç½²ä¸­...';
  btn.classList.add('btn-loading');
  return true;
}

// æ£€æµ‹çŠ¶æ€ (AJAX)
async function doHealthCheck(btn) {
  const origText = btn.textContent;
  btn.textContent = 'â³ æ£€æµ‹ä¸­...';
  btn.disabled = true;
  try {
    const resp = await fetch('/admin/api/health-check', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
      body: JSON.stringify({})
    });
    const data = await resp.json();
    if (data.ok && data.results) {
      // æ”¶é›†åœ¨çº¿èŠ‚ç‚¹çš„ SSH hostï¼ŒåŒæœºèŠ‚ç‚¹ä¹Ÿæ ‡è®°ä¸ºåœ¨çº¿
      const onlineHosts = new Set();
      data.results.forEach(r => { if (r.agent && r.online) onlineHosts.add(r.sshHost || ''); });
      data.results.forEach(r => {
        const isOnline = r.agent || onlineHosts.has(r.sshHost || '');
        const agentCell = document.querySelector(`[data-agent-cell="${r.nodeId}"]`);
        if (agentCell) {
          agentCell.innerHTML = isOnline
            ? `<span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.6)]" title="Agent åœ¨çº¿${r.agent ? '' : ' (åŒæœº)'}"></span>`
            : `<span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-600" title="Agent ç¦»çº¿"></span>`;
        }
      });
      btn.textContent = `âœ… æ£€æµ‹å®Œæˆ (${data.results.filter(r => r.online).length}/${data.results.length})`;
    } else {
      btn.textContent = 'âŒ æ£€æµ‹å¤±è´¥';
    }
  } catch (e) {
    btn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
  }
  setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 3000);
}

// é‡å¯ Xray
async function restartXray(nodeId, btn) {
  const origText = btn.textContent;
  btn.textContent = 'â³';
  btn.disabled = true;
  try {
    const resp = await fetch(`/admin/api/nodes/${nodeId}/restart-xray`, {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
      body: JSON.stringify({})
    });
    const data = await resp.json();
    btn.textContent = data.success ? 'âœ…' : 'âŒ';
  } catch {
    btn.textContent = 'âŒ';
  }
  setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 2000);
}

// èŠ‚ç‚¹åˆ†ç»„ç¼–è¾‘
async function editNodeGroup(nodeId, groupName, tags) {
  const g = await _prompt('è®¾ç½®åˆ†ç»„åç§°', { value: groupName, placeholder: 'ç•™ç©ºåˆ™å½’å…¥é»˜è®¤ç»„', hint: 'å¦‚ï¼šäºšæ´²ã€æ¬§ç¾ã€é«˜é€Ÿçº¿è·¯' });
  if (g === null) return;
  const t = await _prompt('è®¾ç½®æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰', { value: tags, placeholder: 'å¦‚ï¼šIPLC,é«˜é€Ÿ', hint: 'å¤šä¸ªæ ‡ç­¾é€—å·åˆ†éš”' });
  if (t === null) return;
  const res = await fetch('/admin/api/nodes/' + nodeId + '/update-group', {
    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
    body: JSON.stringify({ group_name: g, tags: t })
  });
  if (res.ok) { toast('âœ… åˆ†ç»„å·²æ›´æ–°'); setTimeout(() => location.reload(), 500); }
  else toast('âŒ æ›´æ–°å¤±è´¥');
}

// æ‰¹é‡æ›´æ–° Agent
async function doUpdateAllAgents(btn) {
  const ok = await _confirm('ç¡®å®šå‘æ‰€æœ‰åœ¨çº¿ Agent å‘é€æ›´æ–°æŒ‡ä»¤ï¼Ÿ');
  if (!ok) return;
  const origText = btn.textContent;
  btn.textContent = 'â³ æ›´æ–°ä¸­...';
  btn.disabled = true;
  try {
    const resp = await fetch('/admin/api/agents/update-all', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': _csrf },
      body: JSON.stringify({})
    });
    const data = await resp.json();
    if (data.ok) {
      const ok = data.results.filter(r => r.success).length;
      btn.textContent = `âœ… ${ok}/${data.results.length} æˆåŠŸ`;
    } else {
      btn.textContent = 'âŒ å¤±è´¥';
    }
  } catch {
    btn.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
  }
  setTimeout(() => { btn.textContent = origText; btn.disabled = false; }, 3000);
}
</script>
