<!-- è¿ç»´ä»ªè¡¨ç›˜ Tab -->
<div class="tab-panel space-y-4" data-tab="ops">

  <!-- èŠ‚ç‚¹å¥åº·æ€»è§ˆ -->
  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-white text-sm font-medium">ğŸ“Š èŠ‚ç‚¹å¥åº·æ€»è§ˆ</h3>
      <button onclick="loadOpsDashboard()" class="text-[11px] px-3 py-1 rounded-full bg-white/5 text-gray-400 hover:bg-white/10 transition">ğŸ”„ åˆ·æ–°</button>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="ops-health-cards">
      <div class="rounded-xl bg-black/30 p-4 text-center border border-white/5">
        <div class="text-3xl font-bold text-white" id="ops-total">-</div>
        <div class="text-[11px] text-gray-500 mt-1">æ€»èŠ‚ç‚¹</div>
      </div>
      <div class="rounded-xl bg-black/30 p-4 text-center border border-emerald-500/20">
        <div class="text-3xl font-bold text-emerald-400" id="ops-online">-</div>
        <div class="text-[11px] text-gray-500 mt-1">åœ¨çº¿</div>
      </div>
      <div class="rounded-xl bg-black/30 p-4 text-center border border-yellow-500/20">
        <div class="text-3xl font-bold text-yellow-400" id="ops-offline">-</div>
        <div class="text-[11px] text-gray-500 mt-1">ç¦»çº¿</div>
      </div>
      <div class="rounded-xl bg-black/30 p-4 text-center border border-red-500/20">
        <div class="text-3xl font-bold text-red-400" id="ops-blocked">-</div>
        <div class="text-[11px] text-gray-500 mt-1">ç–‘ä¼¼è¢«å¢™</div>
      </div>
    </div>
  </div>

  <!-- å°ä¹–å·¡æ£€çŠ¶æ€ -->
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">ğŸ± å°ä¹–å·¡æ£€çŠ¶æ€</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="rounded-xl bg-black/20 p-3 text-center">
        <div class="text-lg font-bold text-blue-400" id="ops-last-patrol">-</div>
        <div class="text-[10px] text-gray-500 mt-1">æœ€è¿‘å·¡æ£€</div>
      </div>
      <div class="rounded-xl bg-black/20 p-3 text-center">
        <div class="text-lg font-bold text-cyan-400" id="ops-patrol-count">0</div>
        <div class="text-[10px] text-gray-500 mt-1">ä»Šæ—¥å·¡æ£€</div>
      </div>
      <div class="rounded-xl bg-black/20 p-3 text-center">
        <div class="text-lg font-bold text-orange-400" id="ops-swap-count">0</div>
        <div class="text-[10px] text-gray-500 mt-1">ä»Šæ—¥æ¢IP</div>
      </div>
      <div class="rounded-xl bg-black/20 p-3 text-center">
        <div class="text-lg font-bold text-green-400" id="ops-fix-count">0</div>
        <div class="text-[10px] text-gray-500 mt-1">ä»Šæ—¥ä¿®å¤</div>
      </div>
    </div>
  </div>

  <!-- è¿ç»´äº‹ä»¶ -->
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">ğŸ• è¿ç»´äº‹ä»¶</h3>
    <div id="ops-timeline" class="space-y-2 max-h-[400px] overflow-y-auto">
      <p class="text-gray-600 text-xs text-center py-4">åŠ è½½ä¸­...</p>
    </div>
  </div>

  <!-- è¿ç»´é…ç½® -->
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-4">âš™ï¸ è¿ç»´é…ç½®</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="text-gray-500 text-xs block mb-1">ç›®æ ‡èŠ‚ç‚¹æ•°ï¼ˆ0=ä¸è‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰</label>
        <input type="number" id="ops-target-nodes" min="0" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" value="0">
      </div>
      <div>
        <label class="text-gray-500 text-xs block mb-1">å·¡æ£€é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
        <input type="number" id="ops-patrol-interval" min="5" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" value="30">
      </div>
      <div>
        <label class="text-gray-500 text-xs block mb-1">æ¯æ—¥æ¢ IP ä¸Šé™</label>
        <input type="number" id="ops-max-daily-swaps" min="0" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" value="10">
      </div>
      <div>
        <label class="text-gray-500 text-xs block mb-1">æ¯æ—¥åˆ›å»ºå®ä¾‹ä¸Šé™</label>
        <input type="number" id="ops-max-daily-creates" min="0" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" value="3">
      </div>
    </div>

    <div class="mt-4 space-y-2">
      <label class="flex items-center justify-between p-3 rounded-xl bg-black/20 cursor-pointer hover:bg-white/5 transition">
        <div>
          <span class="text-white text-sm">ğŸ”„ è¢«å¢™è‡ªåŠ¨æ¢ IP</span>
          <span class="text-emerald-400 text-[10px] ml-2">âœ… å·²ç”Ÿæ•ˆ</span>
          <span class="text-gray-600 text-xs ml-1">health.js å·²å®ç°</span>
        </div>
        <input type="checkbox" id="ops-auto-swap-ip" class="accent-rose-500">
      </label>
      <label class="flex items-center justify-between p-3 rounded-xl bg-black/20 cursor-pointer hover:bg-white/5 transition">
        <div>
          <span class="text-white text-sm">ğŸ”§ èŠ‚ç‚¹è‡ªåŠ¨ä¿®å¤</span>
          <span class="text-gray-500 text-[10px] ml-2">ğŸ”² ç”± OpenClaw AI å·¡æ£€æ—¶æ‰§è¡Œ</span>
        </div>
        <input type="checkbox" id="ops-auto-repair" class="accent-rose-500">
      </label>
      <label class="flex items-center justify-between p-3 rounded-xl bg-black/20 cursor-pointer hover:bg-white/5 transition">
        <div>
          <span class="text-white text-sm">ğŸ“ˆ è‡ªåŠ¨æ‰©ç¼©å®¹</span>
          <span class="text-gray-500 text-[10px] ml-2">ğŸ”² ç”± OpenClaw AI å·¡æ£€æ—¶æ‰§è¡Œ</span>
        </div>
        <input type="checkbox" id="ops-auto-scale" class="accent-rose-500">
      </label>
      <label class="flex items-center justify-between p-3 rounded-xl bg-black/20 cursor-pointer hover:bg-white/5 transition">
        <div>
          <span class="text-white text-sm">ğŸ›¡ï¸ é¢æ¿å®ˆæŠ¤</span>
          <span class="text-emerald-400 text-[10px] ml-2">âœ… å·²ç”Ÿæ•ˆ</span>
          <span class="text-gray-600 text-xs ml-1">PM2 å·²å®ç°</span>
        </div>
        <input type="checkbox" id="ops-panel-guard" class="accent-rose-500">
      </label>
    </div>

    <button onclick="saveOpsConfig()" class="mt-4 w-full bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition">ä¿å­˜é…ç½®</button>
  </div>
</div>

<script>
(function() {
  const OPS_KEYS = [
    { id: 'ops-target-nodes', key: 'ops_target_nodes', type: 'int' },
    { id: 'ops-patrol-interval', key: 'ops_patrol_interval', type: 'int' },
    { id: 'ops-max-daily-swaps', key: 'ops_max_daily_swaps', type: 'int' },
    { id: 'ops-max-daily-creates', key: 'ops_max_daily_creates', type: 'int' },
    { id: 'ops-auto-swap-ip', key: 'ops_auto_swap_ip', type: 'bool' },
    { id: 'ops-auto-repair', key: 'ops_auto_repair', type: 'bool' },
    { id: 'ops-auto-scale', key: 'ops_auto_scale', type: 'bool' },
    { id: 'ops-panel-guard', key: 'ops_panel_guard', type: 'bool' },
  ];

  const EVENT_ICONS = {
    node_blocked: { icon: 'ğŸš«', color: 'text-red-400' },
    auto_swap_ip: { icon: 'ğŸ”„', color: 'text-orange-400' },
    swap_ip: { icon: 'ğŸ”„', color: 'text-orange-400' },
    ip_rotated: { icon: 'ğŸ”„', color: 'text-orange-400' },
    node_recovered: { icon: 'âœ…', color: 'text-emerald-400' },
    deploy: { icon: 'ğŸš€', color: 'text-blue-400' },
    health_check: { icon: 'ğŸ’“', color: 'text-cyan-400' },
    auto_repair: { icon: 'ğŸ”§', color: 'text-yellow-400' },
    ops_config: { icon: 'âš™ï¸', color: 'text-gray-400' },
    node_create: { icon: 'â•', color: 'text-green-400' },
    node_delete: { icon: 'â–', color: 'text-red-400' },
    patrol: { icon: 'ğŸ±', color: 'text-purple-400' },
    instance_create: { icon: 'â˜ï¸', color: 'text-blue-400' },
    instance_terminate: { icon: 'ğŸ’€', color: 'text-red-400' },
    diagnosis_pending: { icon: 'ğŸ©º', color: 'text-yellow-400' },
    diagnosis_resolved: { icon: 'ğŸ’Š', color: 'text-emerald-400' },
    diagnosis_failed: { icon: 'âŒ', color: 'text-red-400' },
    auto_swap_ip_start: { icon: 'ğŸ”„', color: 'text-orange-400' },
    auto_swap_ip_ok: { icon: 'âœ…', color: 'text-emerald-400' },
    auto_swap_ip_fail: { icon: 'âŒ', color: 'text-red-400' },
    node_xray_down: { icon: 'ğŸ”´', color: 'text-red-400' },
    traffic_exceed: { icon: 'âš ï¸', color: 'text-yellow-400' },
  };

  const STATUS_COLORS = { pending: 'text-yellow-400 border-yellow-500/20', resolved: 'text-emerald-400 border-emerald-500/20', failed: 'text-red-400 border-red-500/20' };

  window.loadOpsDashboard = async function() {
    try {
      const [dashRes, eventsRes, cfgRes] = await Promise.all([
        fetch('/admin/api/ops-dashboard'), fetch('/admin/api/ops-events'),
        fetch('/admin/api/ops-config')
      ]);
      const dash = await dashRes.json();
      const events = await eventsRes.json();
      const cfg = await cfgRes.json();

      // å¥åº·å¡ç‰‡
      document.getElementById('ops-total').textContent = dash.total;
      document.getElementById('ops-online').textContent = dash.online;
      document.getElementById('ops-offline').textContent = dash.offline;
      document.getElementById('ops-blocked').textContent = dash.blocked;

      // å·¡æ£€çŠ¶æ€
      const lp = dash.lastPatrol;
      document.getElementById('ops-last-patrol').textContent = lp ? lp.replace('T', ' ').slice(0, 16) : 'ä»æœª';
      document.getElementById('ops-patrol-count').textContent = dash.todayStats?.patrols || 0;
      document.getElementById('ops-swap-count').textContent = dash.todayStats?.swaps || 0;
      document.getElementById('ops-fix-count').textContent = dash.todayStats?.fixes || 0;

      // äº‹ä»¶æ—¶é—´çº¿
      const tl = document.getElementById('ops-timeline');
      if (!events.length) {
        tl.innerHTML = '<p class="text-gray-600 text-xs text-center py-4">æš‚æ— è¿ç»´äº‹ä»¶</p>';
      } else {
        tl.innerHTML = events.map(e => {
          const ei = EVENT_ICONS[e.action] || { icon: 'ğŸ“‹', color: 'text-gray-400' };
          const time = (e.created_at || '').replace('T', ' ').slice(0, 16);
          return `<div class="flex items-start gap-3 p-2 rounded-lg bg-black/20 hover:bg-white/5 transition">
            <span class="text-lg flex-shrink-0">${ei.icon}</span>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="${ei.color} text-xs font-medium">${e.action}</span>
                <span class="text-gray-600 text-[10px]">${time}</span>
              </div>
              <p class="text-gray-500 text-[11px] truncate mt-0.5">${e.detail || ''}</p>
            </div>
          </div>`;
        }).join('');
      }

      // é…ç½®
      for (const k of OPS_KEYS) {
        const el = document.getElementById(k.id);
        if (!el) continue;
        const val = cfg[k.key];
        if (k.type === 'bool') el.checked = val === 'true';
        else if (val) el.value = val;
      }
    } catch (e) { console.error('ops dashboard error', e); }
  };

  window.saveOpsConfig = async function() {
    const data = {};
    for (const k of OPS_KEYS) {
      const el = document.getElementById(k.id);
      if (!el) continue;
      data[k.key] = k.type === 'bool' ? String(el.checked) : el.value;
    }
    try {
      const res = await fetch('/admin/api/ops-config', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (res.ok) showToast('âœ… è¿ç»´é…ç½®å·²ä¿å­˜');
      else showToast('âŒ ä¿å­˜å¤±è´¥');
    } catch (e) { showToast('âŒ ' + e.message); }
  };

  window.loadOpsConfig = window.loadOpsDashboard;
})();
if (location.hash === '#ops') setTimeout(loadOpsDashboard, 100);
</script>
