<!-- 用户管理 Tab -->
<div class="tab-panel" data-tab="users">
  <div class="glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs">
          <tr><th class="py-3 px-4">用户</th><th class="py-3 px-4">ID</th><th class="py-3 px-4">等级</th><th class="py-3 px-4">流量</th><th class="py-3 px-4">最后登录</th><th class="py-3 px-4">状态</th><th class="py-3 px-4">操作</th></tr>
        </thead>
        <tbody class="text-gray-300">
          <% users.forEach(function(u) { %>
          <tr class="border-b border-white/5 hover:bg-white/[0.02]">
            <td class="py-3 px-4 flex items-center gap-2">
              <img src="<%= u.avatar_url || '' %>" class="w-6 h-6 rounded-full ring-1 ring-white/10 bg-gray-800" onerror="this.style.display='none'">
              <span class="text-white text-sm"><%= u.username %></span>
              <% if (u.is_admin) { %><span class="text-[10px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300">管理</span><% } %>
            </td>
            <td class="py-3 px-4 text-xs text-gray-500"><%= u.nodeloc_id %></td>
            <td class="py-3 px-4 text-xs"><%= u.trust_level %></td>
            <td class="py-3 px-4 text-xs text-gray-400"><%= formatBytes(u.total_traffic || 0) %></td>
            <td class="py-3 px-4 text-xs text-gray-500"><%= u.last_login || '-' %></td>
            <td class="py-3 px-4">
              <span class="text-[10px] px-2 py-0.5 rounded-full <%= u.is_blocked ? 'bg-red-500/20 text-red-300' : 'bg-emerald-500/20 text-emerald-300' %>"><%= u.is_blocked ? '已封禁' : '正常' %></span>
            </td>
            <td class="py-3 px-4 space-x-2">
              <form method="POST" action="/admin/api/users/<%= u.id %>/toggle-block" class="inline">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button class="text-xs <%= u.is_blocked ? 'text-emerald-400' : 'text-red-400' %> hover:underline"><%= u.is_blocked ? '解封' : '封禁' %></button>
              </form>
              <form method="POST" action="/admin/api/users/<%= u.id %>/reset-token" class="inline">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="button" class="text-xs text-amber-400 hover:underline" onclick="_confirm('重置订阅？').then(ok=>{if(ok)this.closest('form').submit()})">重置</button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- AI 配置 Tab -->
<div class="tab-panel space-y-4" data-tab="ai">
  <!-- 服务商列表 -->
  <div class="space-y-3">
    <% if (aiProviders.length === 0) { %><div class="glass rounded-2xl p-6 text-center text-gray-600 text-sm">暂未配置 AI 服务</div><% } %>
    <% aiProviders.forEach(function(p) { %>
    <div class="glass rounded-2xl p-4 flex items-center justify-between" data-provider-id="<%= p.id %>" data-prompt="<%= (p.system_prompt || '').replace(/"/g, '&quot;') %>">
      <div class="flex items-center gap-3">
        <span class="text-lg"><%= p.type === 'openai' ? '🟢' : p.type === 'gemini' ? '🔵' : '🟣' %></span>
        <div>
          <p class="text-white text-sm font-medium"><%= p.name %></p>
          <p class="text-gray-500 text-xs"><%= p.type.toUpperCase() %> · <%= p.model_id %></p>
          <p class="text-gray-600 text-xs"><%= p.endpoint %></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="toggleProvider(<%= p.id %>)" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors <%= p.enabled ? 'bg-emerald-600' : 'bg-gray-700' %>">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform <%= p.enabled ? 'translate-x-6' : 'translate-x-1' %>"></span>
        </button>
        <button onclick="editProvider(<%= p.id %>)" class="text-rose-400 hover:text-rose-300 text-xs">编辑</button>
        <button onclick="deleteProvider(<%= p.id %>)" class="text-red-400 hover:text-red-300 text-xs">删除</button>
      </div>
    </div>
    <% }); %>
  </div>

  <details id="add-provider-details" class="glass rounded-2xl">
    <summary class="text-rose-400 text-sm cursor-pointer hover:text-rose-300 p-4">➕ 添加 AI 服务</summary>
    <div class="px-4 pb-4" id="provider-form-container">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-gray-500 text-xs block mb-1">类型</label>
          <select id="pf-type" onchange="fillDefaults()" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <option value="openai">OpenAI 兼容</option><option value="gemini">Gemini</option><option value="claude">Claude</option>
          </select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">名称</label>
          <input type="text" id="pf-name" placeholder="如：GPT-4o" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div class="col-span-2">
          <label class="text-gray-500 text-xs block mb-1">API 端点</label>
          <input type="text" id="pf-endpoint" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div class="col-span-2">
          <label class="text-gray-500 text-xs block mb-1">API Key</label>
          <input type="password" id="pf-key" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">模型 ID</label>
          <input type="text" id="pf-model-id" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">&nbsp;</label>
          <button onclick="saveProvider()" class="w-full bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition" id="pf-save-btn">保存</button>
        </div>
        <div class="col-span-2">
          <label class="text-gray-500 text-xs block mb-1">系统提示词 <span class="text-gray-600">（可选，留空使用默认）</span></label>
          <textarea id="pf-prompt" rows="3" placeholder="如：你是一个专业的网络工程师助手，请用中文回答。" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm"></textarea>
        </div>
      </div>
      <input type="hidden" id="pf-edit-id" value="">
    </div>
  </details>

  <!-- AI 助手 -->
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">🤖 AI 助手</h3>
    <div class="flex gap-2 mb-3">
      <select id="admin-ai-model" class="bg-black/30 text-gray-300 text-sm px-3 py-2 rounded-xl border border-white/10 min-w-[120px]">
        <% var enabled = aiProviders.filter(function(p){ return p.enabled; }); %>
        <% if (enabled.length === 0) { %><option value="">无可用模型</option><% } %>
        <% enabled.forEach(function(p) { %><option value="<%= p.id %>"><%= p.name %></option><% }); %>
      </select>
      <input type="text" id="ai-input" placeholder="问点什么..." class="flex-1 bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" onkeydown="if(event.key==='Enter')askAI()">
      <button onclick="askAI()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition" id="ai-btn">提问</button>
    </div>
    <div id="ai-response" class="hidden bg-black/30 rounded-xl p-4 text-gray-300 text-sm whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
  </div>
</div>

<!-- 审计日志 Tab -->
<div class="tab-panel" data-tab="logs">
  <div class="glass rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-white/5">
      <h3 class="text-white text-sm font-medium">📋 审计日志 <span id="log-total" class="text-gray-500 text-xs"></span></h3>
      <button onclick="clearLogs()" class="text-red-400 hover:text-red-300 text-xs">🗑 清空</button>
    </div>
    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs sticky top-0" style="background:rgba(15,11,30,0.95)">
          <tr><th class="py-3 px-4">时间</th><th class="py-3 px-4">用户</th><th class="py-3 px-4">操作</th><th class="py-3 px-4">详情</th></tr>
        </thead>
        <tbody class="text-gray-300" id="log-body">
          <% logs.rows.forEach(function(l) { %>
          <tr class="border-b border-white/5">
            <td class="py-2 px-4 text-xs text-gray-500"><%= l.created_at %></td>
            <td class="py-2 px-4 text-xs"><%= l.username || '-' %></td>
            <td class="py-2 px-4 text-xs"><%= l.action %></td>
            <td class="py-2 px-4 text-xs text-gray-500 max-w-xs truncate"><%= l.detail || '' %></td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    <div class="flex items-center justify-between p-3 border-t border-white/5">
      <span class="text-gray-600 text-xs" id="log-info">共 <%= logs.total %> 条</span>
      <div class="flex gap-1" id="log-pager"></div>
    </div>
  </div>
</div>

<!-- 订阅监控 Tab -->
<div class="tab-panel space-y-4" data-tab="abuse">
  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-white text-sm font-medium">🔍 订阅滥用检测</h3>
      <div class="flex items-center gap-2">
        <select id="abuse-hours" class="bg-black/30 text-gray-300 text-xs px-2 py-1 rounded-lg border border-white/10">
          <option value="24">24小时 ≥20IP</option><option value="168">7天 ≥100IP</option>
        </select>
        <button onclick="checkAbuse()" class="bg-rose-600 hover:bg-rose-500 text-white text-xs px-3 py-1.5 rounded-lg transition">检测</button>
      </div>
    </div>
    <div id="abuse-result">
      <p class="text-gray-600 text-sm text-center py-4">点击「检测」查看结果</p>
    </div>
  </div>
  <div class="glass rounded-2xl p-5 hidden" id="abuse-detail-panel">
    <h3 class="text-white text-sm font-medium mb-3" id="abuse-detail-title">IP 详情</h3>
    <div id="abuse-detail"></div>
  </div>
</div>

<!-- 运维 Tab -->
<div class="tab-panel space-y-4" data-tab="ops">
  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h3 class="text-white text-sm font-medium">🤖 运维 AI 配置</h3>
        <p class="text-gray-600 text-xs mt-1">节点异常时自动重启，失败则 AI 分析并生成修复方案</p>
      </div>
      <span id="ops-ai-status" class="text-xs px-2 py-0.5 rounded-full bg-gray-500/20 text-gray-400">未配置</span>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <select id="ops-type" class="bg-black/30 text-white text-sm px-3 py-2 rounded-xl border border-white/10">
        <option value="openai">OpenAI 兼容</option><option value="gemini">Gemini</option><option value="claude">Claude</option>
      </select>
      <input type="text" id="ops-model" placeholder="模型 ID（如 gemini-2.0-flash）" class="bg-black/30 text-white text-sm px-3 py-2 rounded-xl border border-white/10">
      <input type="text" id="ops-endpoint" placeholder="API 端点" class="bg-black/30 text-white text-sm px-3 py-2 rounded-xl border border-white/10 col-span-2">
      <input type="password" id="ops-key" placeholder="API Key（留空保留原值）" class="bg-black/30 text-white text-sm px-3 py-2 rounded-xl border border-white/10 col-span-2">
      <button onclick="saveOpsAi()" class="bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition col-span-2">保存</button>
    </div>
  </div>
  <div class="glass rounded-2xl overflow-hidden">
    <div class="p-4 border-b border-white/5 flex items-center justify-between">
      <h3 class="text-white text-sm font-medium">📋 诊断记录</h3>
      <div class="flex items-center gap-2">
        <select id="ops-node-select" class="bg-black/30 text-white text-xs px-2 py-1.5 rounded-lg border border-white/10">
          <% nodes.forEach(n => { %>
          <option value="<%= n.id %>"><%= n.name %></option>
          <% }); %>
        </select>
        <button onclick="manualDiagnose()" class="bg-amber-600 hover:bg-amber-500 text-white text-xs px-3 py-1.5 rounded-lg transition">🔍 手动诊断</button>
        <button onclick="loadOps()" class="text-rose-400 hover:text-rose-300 text-xs">刷新</button>
        <button onclick="clearOps()" class="text-gray-500 hover:text-red-400 text-xs ml-auto">🗑️ 清空记录</button>
      </div>
    </div>
    <div id="ops-list" class="p-4">
      <p class="text-gray-600 text-sm text-center py-4">加载中...</p>
    </div>
  </div>
</div>

<!-- 通知 Tab -->
<div class="tab-panel space-y-4" data-tab="notify">
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">📢 公告管理</h3>
    <div class="flex gap-2">
      <input type="text" id="announcement-text" value="<%= announcement %>" placeholder="输入公告内容（留空则不显示）" class="flex-1 bg-black/30 text-white px-4 py-2 rounded-xl border border-white/10 text-sm">
      <button onclick="saveAnnouncement()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition">保存</button>
    </div>
  </div>

  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-4">🔔 Telegram 通知配置</h3>
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div>
        <label class="text-gray-500 text-xs block mb-1">Bot Token</label>
        <input type="password" id="tg-token" value="" placeholder="<%= tgBotToken ? '已配置（留空保留原值）' : '123456:ABC-DEF...' %>" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <div>
        <label class="text-gray-500 text-xs block mb-1">Chat ID</label>
        <input type="text" id="tg-chat-id" value="<%= (typeof tgChatId !== 'undefined' ? tgChatId : '') %>" placeholder="-100123456789" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
    </div>
    <div class="flex gap-2 mb-6">
      <button onclick="saveTG()" class="bg-rose-600 hover:bg-rose-500 text-white text-xs px-4 py-2 rounded-xl transition">保存</button>
      <button onclick="testTG()" class="glass text-gray-300 hover:text-white text-xs px-4 py-2 rounded-xl transition">发送测试</button>
    </div>
    <h3 class="text-white text-sm font-medium mb-3">通知事件</h3>
    <div class="space-y-2">
      <% var events = [
        { key: 'tg_on_login', label: '👤 用户登录', desc: '有用户登录时通知' },
        { key: 'tg_on_node_down', label: '🔴 节点离线/恢复', desc: '节点状态变化时通知' },
        { key: 'tg_on_rotate', label: '🔄 自动轮换', desc: '每日轮换完成后通知' },
        { key: 'tg_on_admin', label: '⚙️ 管理操作', desc: '管理员操作时通知' },
        { key: 'tg_on_abuse', label: '⚠️ 订阅异常', desc: '检测到多IP拉取时通知' },
        { key: 'tg_on_traffic', label: '📊 流量超标', desc: '用户日流量超10GB时通知' },
        { key: 'tg_on_ops', label: '🔧 运维诊断', desc: '节点自动诊断/AI分析结果通知' }
      ]; events.forEach(function(ev) { %>
        <label class="flex items-center justify-between p-3 rounded-xl bg-black/20 cursor-pointer hover:bg-white/5 transition">
          <div>
            <span class="text-white text-sm"><%= ev.label %></span>
            <span class="text-gray-600 text-xs ml-2"><%= ev.desc %></span>
          </div>
          <input type="checkbox" class="tg-event accent-rose-500" data-key="<%= ev.key %>" <%= (typeof tgEvents !== 'undefined' && tgEvents[ev.key]) ? 'checked' : '' %> onchange="toggleEvent(this)">
        </label>
      <% }); %>
    </div>
  </div>
</div>
