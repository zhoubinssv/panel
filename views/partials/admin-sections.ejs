<!-- 用户管理 Tab -->
<div class="tab-panel" data-tab="users">
  <div class="glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs">
          <tr><th class="py-3 px-4">用户</th><th class="py-3 px-4">ID</th><th class="py-3 px-4">等级</th><th class="py-3 px-4">流量</th><th class="py-3 px-4">最后登录</th><th class="py-3 px-4">状态</th><th class="py-3 px-4">操作</th></tr>
        </thead>
        <tbody class="text-gray-300">
          <% users.forEach(function(u) { %>
          <tr class="border-b border-white/5 hover:bg-white/[0.02]">
            <td class="py-3 px-4 flex items-center gap-2">
              <img src="<%= u.avatar_url || '' %>" class="w-6 h-6 rounded-full ring-1 ring-white/10 bg-gray-800" onerror="this.style.display='none'">
              <span class="text-white text-sm"><%= u.username %></span>
              <% if (u.is_admin) { %><span class="text-[10px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300">管理</span><% } %>
            </td>
            <td class="py-3 px-4 text-xs text-gray-500"><%= u.nodeloc_id %></td>
            <td class="py-3 px-4 text-xs"><%= u.trust_level %></td>
            <td class="py-3 px-4 text-xs text-gray-400"><%= formatBytes(u.total_traffic || 0) %></td>
            <td class="py-3 px-4 text-xs text-gray-500"><%= u.last_login || '-' %></td>
            <td class="py-3 px-4">
              <span class="text-[10px] px-2 py-0.5 rounded-full <%= u.is_blocked ? 'bg-red-500/20 text-red-300' : 'bg-emerald-500/20 text-emerald-300' %>"><%= u.is_blocked ? '已封禁' : '正常' %></span>
            </td>
            <td class="py-3 px-4 space-x-2">
              <form method="POST" action="/admin/api/users/<%= u.id %>/toggle-block" class="inline">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button class="text-xs <%= u.is_blocked ? 'text-emerald-400' : 'text-red-400' %> hover:underline"><%= u.is_blocked ? '解封' : '封禁' %></button>
              </form>
              <form method="POST" action="/admin/api/users/<%= u.id %>/reset-token" class="inline">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="button" class="text-xs text-amber-400 hover:underline" onclick="_confirm('重置订阅？').then(ok=>{if(ok)this.closest('form').submit()})">重置</button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- AI 配置 Tab -->
<div class="tab-panel space-y-4" data-tab="ai">
  <!-- 服务商列表 -->
  <div class="space-y-3">
    <% if (aiProviders.length === 0) { %><div class="glass rounded-2xl p-6 text-center text-gray-600 text-sm">暂未配置 AI 服务</div><% } %>
    <% aiProviders.forEach(function(p) { %>
    <div class="glass rounded-2xl p-4 flex items-center justify-between" data-provider-id="<%= p.id %>" data-prompt="<%= (p.system_prompt || '').replace(/"/g, '&quot;') %>">
      <div class="flex items-center gap-3">
        <span class="text-lg"><%= p.type === 'openai' ? '🟢' : p.type === 'gemini' ? '🔵' : '🟣' %></span>
        <div>
          <p class="text-white text-sm font-medium"><%= p.name %></p>
          <p class="text-gray-500 text-xs"><%= p.type.toUpperCase() %> · <%= p.model_id %></p>
          <p class="text-gray-600 text-xs"><%= p.endpoint %></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="toggleProvider(<%= p.id %>)" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors <%= p.enabled ? 'bg-emerald-600' : 'bg-gray-700' %>">
          <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform <%= p.enabled ? 'translate-x-6' : 'translate-x-1' %>"></span>
        </button>
        <button onclick="editProvider(<%= p.id %>)" class="text-rose-400 hover:text-rose-300 text-xs">编辑</button>
        <button onclick="deleteProvider(<%= p.id %>)" class="text-red-400 hover:text-red-300 text-xs">删除</button>
      </div>
    </div>
    <% }); %>
  </div>

  <details id="add-provider-details" class="glass rounded-2xl">
    <summary class="text-rose-400 text-sm cursor-pointer hover:text-rose-300 p-4">➕ 添加 AI 服务</summary>
    <div class="px-4 pb-4" id="provider-form-container">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-gray-500 text-xs block mb-1">类型</label>
          <select id="pf-type" onchange="fillDefaults()" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <option value="openai">OpenAI 兼容</option><option value="gemini">Gemini</option><option value="claude">Claude</option>
          </select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">名称</label>
          <input type="text" id="pf-name" placeholder="如：GPT-4o" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div class="col-span-2">
          <label class="text-gray-500 text-xs block mb-1">API 端点</label>
          <input type="text" id="pf-endpoint" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div class="col-span-2">
          <label class="text-gray-500 text-xs block mb-1">API Key</label>
          <input type="password" id="pf-key" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">模型 ID</label>
          <input type="text" id="pf-model-id" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">&nbsp;</label>
          <button onclick="saveProvider()" class="w-full bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition" id="pf-save-btn">保存</button>
        </div>
        <div class="col-span-2">
          <label class="text-gray-500 text-xs block mb-1">系统提示词 <span class="text-gray-600">（可选，留空使用默认）</span></label>
          <textarea id="pf-prompt" rows="3" placeholder="如：你是一个专业的网络工程师助手，请用中文回答。" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm"></textarea>
        </div>
      </div>
      <input type="hidden" id="pf-edit-id" value="">
    </div>
  </details>

  <!-- AI 助手 -->
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">🤖 AI 助手</h3>
    <div class="flex gap-2 mb-3">
      <select id="admin-ai-model" class="bg-black/30 text-gray-300 text-sm px-3 py-2 rounded-xl border border-white/10 min-w-[120px]">
        <% var enabled = aiProviders.filter(function(p){ return p.enabled; }); %>
        <% if (enabled.length === 0) { %><option value="">无可用模型</option><% } %>
        <% enabled.forEach(function(p) { %><option value="<%= p.id %>"><%= p.name %></option><% }); %>
      </select>
      <input type="text" id="ai-input" placeholder="问点什么..." class="flex-1 bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" onkeydown="if(event.key==='Enter')askAI()">
      <button onclick="askAI()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition" id="ai-btn">提问</button>
    </div>
    <div id="ai-response" class="hidden bg-black/30 rounded-xl p-4 text-gray-300 text-sm whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
  </div>
</div>

<!-- 审计日志 Tab -->
<div class="tab-panel" data-tab="logs">
  <div class="glass rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-white/5">
      <h3 class="text-white text-sm font-medium">📋 审计日志 <span id="log-total" class="text-gray-500 text-xs"></span></h3>
      <button onclick="clearLogs()" class="text-red-400 hover:text-red-300 text-xs">🗑 清空</button>
    </div>
    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs sticky top-0" style="background:rgba(15,11,30,0.95)">
          <tr><th class="py-3 px-4">时间</th><th class="py-3 px-4">用户</th><th class="py-3 px-4">操作</th><th class="py-3 px-4">详情</th></tr>
        </thead>
        <tbody class="text-gray-300" id="log-body">
          <% logs.rows.forEach(function(l) { %>
          <tr class="border-b border-white/5">
            <td class="py-2 px-4 text-xs text-gray-500"><%= l.created_at %></td>
            <td class="py-2 px-4 text-xs"><%= l.username || '-' %></td>
            <td class="py-2 px-4 text-xs"><%= l.action %></td>
            <td class="py-2 px-4 text-xs text-gray-500 max-w-xs truncate"><%= l.detail || '' %></td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    <div class="flex items-center justify-between p-3 border-t border-white/5">
      <span class="text-gray-600 text-xs" id="log-info">共 <%= logs.total %> 条</span>
      <div class="flex gap-1" id="log-pager"></div>
    </div>
  </div>
</div>

<!-- 订阅监控 Tab -->
<div class="tab-panel space-y-4" data-tab="abuse">
  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-white text-sm font-medium">🔍 订阅滥用检测</h3>
      <div class="flex items-center gap-2">
        <select id="abuse-hours" class="bg-black/30 text-gray-300 text-xs px-2 py-1 rounded-lg border border-white/10">
          <option value="24">24小时 ≥20IP</option><option value="168">7天 ≥100IP</option>
        </select>
        <button onclick="checkAbuse()" class="bg-rose-600 hover:bg-rose-500 text-white text-xs px-3 py-1.5 rounded-lg transition">检测</button>
      </div>
    </div>
    <div id="abuse-result">
      <p class="text-gray-600 text-sm text-center py-4">点击「检测」查看结果</p>
    </div>
  </div>
  <div class="glass rounded-2xl p-5 hidden" id="abuse-detail-panel">
    <h3 class="text-white text-sm font-medium mb-3" id="abuse-detail-title">IP 详情</h3>
    <div id="abuse-detail"></div>
  </div>
</div>

<!-- 通知 Tab -->
<div class="tab-panel space-y-4" data-tab="notify">
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">📢 公告管理</h3>
    <div class="flex gap-2">
      <input type="text" id="announcement-text" value="<%= announcement %>" placeholder="输入公告内容（留空则不显示）" class="flex-1 bg-black/30 text-white px-4 py-2 rounded-xl border border-white/10 text-sm">
      <button onclick="saveAnnouncement()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition">保存</button>
    </div>
  </div>

  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">👥 注册人数限制</h3>
    <p class="text-gray-600 text-xs mb-3">设为 0 表示不限制，当前已注册 <span class="text-rose-400"><%= userCount %></span> 人</p>
    <div class="flex gap-2">
      <input type="number" id="max-users-input" value="<%= maxUsers %>" min="0" placeholder="0 = 不限制" class="flex-1 bg-black/30 text-white px-4 py-2 rounded-xl border border-white/10 text-sm">
      <button onclick="saveMaxUsers()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition">保存</button>
    </div>
  </div>

  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-4">🔔 Telegram 通知配置</h3>
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div>
        <label class="text-gray-500 text-xs block mb-1">Bot Token</label>
        <input type="password" id="tg-token" value="" placeholder="<%= tgBotToken ? '已配置（留空保留原值）' : '123456:ABC-DEF...' %>" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <div>
        <label class="text-gray-500 text-xs block mb-1">Chat ID</label>
        <input type="text" id="tg-chat-id" value="<%= (typeof tgChatId !== 'undefined' ? tgChatId : '') %>" placeholder="-100123456789" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
    </div>
    <div class="flex gap-2 mb-6">
      <button onclick="saveTG()" class="bg-rose-600 hover:bg-rose-500 text-white text-xs px-4 py-2 rounded-xl transition">保存</button>
      <button onclick="testTG()" class="glass text-gray-300 hover:text-white text-xs px-4 py-2 rounded-xl transition">发送测试</button>
    </div>
    <h3 class="text-white text-sm font-medium mb-3">通知事件</h3>
    <div class="space-y-2">
      <% var events = [
        { key: 'tg_on_login', label: '👤 用户登录', desc: '有用户登录时通知' },
        { key: 'tg_on_node_down', label: '🔴 节点离线/恢复', desc: '节点状态变化时通知' },
        { key: 'tg_on_rotate', label: '🔄 自动轮换', desc: '每日轮换完成后通知' },
        { key: 'tg_on_admin', label: '⚙️ 管理操作', desc: '管理员操作时通知' },
        { key: 'tg_on_abuse', label: '⚠️ 订阅异常', desc: '检测到多IP拉取时通知' },
        { key: 'tg_on_traffic', label: '📊 流量超标', desc: '用户日流量超10GB时通知' }
      ]; events.forEach(function(ev) { %>
        <label class="flex items-center justify-between p-3 rounded-xl bg-black/20 cursor-pointer hover:bg-white/5 transition">
          <div>
            <span class="text-white text-sm"><%= ev.label %></span>
            <span class="text-gray-600 text-xs ml-2"><%= ev.desc %></span>
          </div>
          <input type="checkbox" class="tg-event accent-rose-500" data-key="<%= ev.key %>" <%= (typeof tgEvents !== 'undefined' && tgEvents[ev.key]) ? 'checked' : '' %> onchange="toggleEvent(this)">
        </label>
      <% }); %>
    </div>
  </div>
</div>

<!-- AWS Tab -->
<div class="tab-panel space-y-4" data-tab="aws">
  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-white text-sm font-medium">☁️ AWS 配置</h3>
      <span id="aws-status" class="text-xs px-2 py-0.5 rounded-full bg-gray-500/20 text-gray-400">检测中...</span>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="text-gray-500 text-xs block mb-1">账号名称</label>
        <input type="text" id="aws-name" placeholder="如 aws-01" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <!-- 区域策略说明已移除，默认走系统 us-east-1 策略 -->
      <div>
        <label class="text-gray-500 text-xs block mb-1">Access Key ID</label>
        <input type="password" id="aws-ak" placeholder="AKIA..." class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <div class="col-span-2">
        <label class="text-gray-500 text-xs block mb-1">Secret Access Key</label>
        <input type="password" id="aws-sk" placeholder="xxxxxxxx" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <div class="col-span-2">
        <label class="text-gray-500 text-xs block mb-1">SOCKS5 代理 (可选)</label>
        <div class="flex gap-2">
          <input type="text" id="aws-socks-url" placeholder="socks5://user:pass@host:port" class="flex-1 bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <button type="button" onclick="testSocksProxy()" class="glass text-gray-300 hover:text-white px-4 py-2 rounded-xl text-sm transition">验证</button>
        </div>
        <p id="aws-socks-test-result" class="text-[11px] text-gray-500 mt-1"></p>
      </div>
      <div class="col-span-2">
        <button type="button" onclick="saveAwsConfig()" class="w-full bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition mt-1">新增账号</button>
      </div>
    </div>
    <div id="aws-accounts" class="mt-3 space-y-2"></div>
  </div>

  <!-- 节点 AWS 绑定 -->
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">🔗 节点绑定 AWS 实例</h3>
    <p class="text-gray-600 text-xs mb-3">绑定后，被墙时自动换 IP；也可手动换 IP</p>
    <div class="space-y-2">
      <% nodes.forEach(function(n) { %>
      <div class="flex items-center justify-between p-3 rounded-xl bg-black/20">
        <div class="flex items-center gap-2">
          <span class="text-white text-sm"><%= n.name %></span>
          <span class="text-gray-500 text-xs"><%= n.host %></span>
          <% if (n.aws_instance_id) { %>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300"><%= n.aws_type || 'ec2' %>: <%= n.aws_instance_id %> (账号#<%= n.aws_account_id || '-' %>)</span>
          <% } %>
        </div>
        <div class="flex items-center gap-2">
          <% if (n.aws_instance_id) { %>
            <button type="button" onclick="swapNodeIp(<%= n.id %>, '<%= n.name %>')" class="text-xs bg-amber-600 hover:bg-amber-500 text-white px-3 py-1 rounded-lg transition">🔄 换 IP</button>
            <button type="button" onclick="unbindAws(<%= n.id %>)" class="text-xs text-gray-500 hover:text-red-400">解绑</button>
          <% } else { %>
            <button type="button" onclick="showBindAws(<%= n.id %>)" class="text-xs text-blue-400 hover:text-blue-300">绑定</button>
          <% } %>
        </div>
      </div>
      <% }); %>
    </div>
  </div>

  <!-- 账号编辑弹窗 -->
  <div id="aws-edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60" onclick="if(event.target===this)closeAwsEditModal()">
    <div class="glass rounded-2xl p-6 w-[92%] max-w-md border border-white/10">
      <h3 class="text-white text-sm font-medium mb-4">编辑 AWS 账号</h3>
      <input type="hidden" id="edit-aws-id">
      <div class="space-y-3">
        <div>
          <label class="text-gray-500 text-xs block mb-1">备注 / 账号名</label>
          <input type="text" id="edit-aws-name" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-gray-500 text-xs block mb-1">Access Key</label>
            <input type="text" id="edit-aws-ak" readonly class="w-full bg-black/20 text-gray-400 px-3 py-2 rounded-xl border border-white/10 text-sm">
          </div>
          <div>
            <label class="text-gray-500 text-xs block mb-1">Secret Key</label>
            <input type="text" id="edit-aws-sk" readonly value="******** (已保存)" class="w-full bg-black/20 text-gray-400 px-3 py-2 rounded-xl border border-white/10 text-sm">
          </div>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">SOCKS5 URL</label>
          <div class="flex gap-2">
            <input type="text" id="edit-aws-socks" placeholder="socks5://user:pass@host:port（留空清除）" class="flex-1 bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <button type="button" onclick="testSocksProxyInput('edit-aws-socks','edit-aws-socks-test')" class="glass text-gray-300 hover:text-white px-4 py-2 rounded-xl text-sm transition">验证</button>
          </div>
          <p id="edit-aws-socks-test" class="text-[11px] text-gray-500 mt-1"></p>
        </div>
        <div class="flex gap-2 pt-1">
          <button type="button" onclick="saveAwsEdit()" class="flex-1 bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition">保存修改</button>
          <button type="button" onclick="closeAwsEditModal()" class="flex-1 glass text-gray-300 hover:text-white py-2 rounded-xl text-sm transition">取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 绑定弹窗 -->
  <div id="aws-bind-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60">
    <div class="glass rounded-2xl p-6 w-96">
      <h3 class="text-white text-sm font-medium mb-4">绑定 AWS 实例</h3>
      <input type="hidden" id="bind-node-id">
      <div class="space-y-3">
        <div>
          <label class="text-gray-500 text-xs block mb-1">AWS 账号</label>
          <select id="bind-account-id" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm"></select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">实例类型</label>
          <select id="bind-type" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <option value="ec2">EC2</option>
            <option value="lightsail">Lightsail</option>
          </select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">实例 ID / 名称</label>
          <input type="text" id="bind-instance-id" placeholder="i-0abc123... 或 Lightsail 实例名" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">区域</label>
          <input type="text" id="bind-region" placeholder="如 ap-northeast-1（留空用默认）" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div class="flex gap-2">
          <button type="button" onclick="confirmBindAws()" class="flex-1 bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition">确认绑定</button>
          <button type="button" onclick="document.getElementById('aws-bind-modal').classList.add('hidden')" class="flex-1 glass text-gray-300 hover:text-white py-2 rounded-xl text-sm transition">取消</button>
        </div>
      </div>
    </div>
  </div>
</div>
