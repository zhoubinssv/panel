<!-- ç”¨æˆ·ç®¡ç† Tab -->
<div class="tab-panel" data-tab="users">
  <!-- ç”¨æˆ·æ€»æ•° + æœç´¢ -->
  <div class="flex items-center justify-between mb-3">
    <span class="text-gray-500 text-xs">å…± <span class="text-white font-medium" id="users-total-count">-</span> ä¸ªç”¨æˆ·</span>
    <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ·å..." class="bg-black/30 text-white px-3 py-1.5 rounded-xl border border-white/10 text-xs w-40">
  </div>

  <!-- ç§»åŠ¨ç«¯å¡ç‰‡å®¹å™¨ -->
  <div class="sm:hidden space-y-3" id="users-cards">
    <div class="text-center text-gray-500 text-sm py-8">åŠ è½½ä¸­...</div>
  </div>
  <!-- æ¡Œé¢ç«¯è¡¨æ ¼ -->
  <div class="hidden sm:block glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs">
          <tr><th class="py-3 px-4">ç”¨æˆ·</th><th class="py-3 px-4">ID</th><th class="py-3 px-4">ç­‰çº§</th><th class="py-3 px-4">å·²ç”¨/é™é¢</th><th class="py-3 px-4">åˆ°æœŸ</th><th class="py-3 px-4">æœ€åç™»å½•</th><th class="py-3 px-4">çŠ¶æ€</th><th class="py-3 px-4">æ“ä½œ</th></tr>
        </thead>
        <tbody class="text-gray-300" id="users-tbody">
          <tr><td colspan="8" class="py-8 text-center text-gray-500">åŠ è½½ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
    <!-- åˆ†é¡µ -->
    <div class="flex items-center justify-between px-4 py-3 border-t border-white/5">
      <span class="text-gray-500 text-xs" id="users-page-info"></span>
      <div class="flex gap-1" id="users-pagination"></div>
    </div>
  </div>
  <!-- ç§»åŠ¨ç«¯åˆ†é¡µ -->
  <div class="sm:hidden flex items-center justify-between mt-3">
    <span class="text-gray-500 text-xs" id="users-page-info-m"></span>
    <div class="flex gap-1" id="users-pagination-m"></div>
  </div>

  <script nonce="<%= nonce %>">
  (function(){
    const csrfToken = '<%= csrfToken %>';
    let _searchTimer = null;

    function _fmtBytes(b) {
      if (!b || b === 0) return '0 B';
      const u = ['B','KB','MB','GB','TB'];
      const i = Math.min(Math.floor(Math.log(b) / Math.log(1024)), u.length - 1);
      return (b / Math.pow(1024, i)).toFixed(i > 0 ? 2 : 0) + ' ' + u[i];
    }

    window.loadUsers = async function(page = 1) {
      const search = (document.getElementById('user-search').value || '').trim();
      const params = new URLSearchParams({ page, search });
      const resp = await fetch('/admin/api/users?' + params);
      const data = await resp.json();
      const tbody = document.getElementById('users-tbody');
      const cards = document.getElementById('users-cards');
      const total = data.total;
      document.getElementById('users-total-count').textContent = total;

      if (!data.rows || data.rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-500">æ— åŒ¹é…ç”¨æˆ·</td></tr>';
        cards.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">æ— åŒ¹é…ç”¨æˆ·</div>';
        document.getElementById('users-page-info').textContent = '';
        document.getElementById('users-pagination').innerHTML = '';
        document.getElementById('users-page-info-m').textContent = '';
        document.getElementById('users-pagination-m').innerHTML = '';
        return;
      }

      // å…¬å…±æ•°æ®
      const rowsHtml = data.rows.map(u => {
        const statusClass = u.is_blocked ? 'bg-red-500/20 text-red-300' : u.is_frozen ? 'bg-blue-500/20 text-blue-300' : 'bg-emerald-500/20 text-emerald-300';
        const statusText = u.is_blocked ? 'å·²å°ç¦' : u.is_frozen ? 'å·²å†»ç»“' : 'æ­£å¸¸';
        const blockBtnClass = u.is_blocked ? 'text-emerald-400' : 'text-red-400';
        const blockBtnText = u.is_blocked ? 'è§£å°' : 'å°ç¦';
        const limitText = u.traffic_limit ? _fmtBytes(u.traffic_limit) : 'âˆ';
        const expiryText = u.expires_at ? u.expires_at.slice(0,10) : 'æ°¸ä¹…';
        const expiryClass = u.expires_at && new Date(u.expires_at) < new Date() ? 'text-red-400' : 'text-gray-400';
        return { u, statusClass, statusText, blockBtnClass, blockBtnText, limitText, expiryText, expiryClass };
      });

      // æ¡Œé¢ç«¯è¡¨æ ¼
      tbody.innerHTML = rowsHtml.map(({u, statusClass, statusText, blockBtnClass, blockBtnText, limitText, expiryText, expiryClass}) => {
        return `<tr class="border-b border-white/5 hover:bg-white/[0.02]">
          <td class="py-3 px-4 flex items-center gap-2">
            <img src="${u.avatar_url || ''}" class="w-6 h-6 rounded-full ring-1 ring-white/10 bg-gray-800" onerror="this.style.display='none'">
            <span class="text-white text-sm">${u.username}</span>
            ${u.is_admin ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300">ç®¡ç†</span>' : ''}
          </td>
          <td class="py-3 px-4 text-xs text-gray-500">${u.nodeloc_id}</td>
          <td class="py-3 px-4 text-xs">${u.trust_level}</td>
          <td class="py-3 px-4 text-xs text-gray-400">
            ${_fmtBytes(u.total_traffic || 0)} / <span class="cursor-pointer text-cyan-400 hover:underline" onclick="setTrafficLimit(${u.id}, '${u.username}', ${u.traffic_limit || 0})">${limitText}</span>
          </td>
          <td class="py-3 px-4 text-xs"><span class="cursor-pointer ${expiryClass} hover:underline" onclick="setExpiry(${u.id}, '${u.username}', '${u.expires_at || ''}')">${expiryText}</span></td>
          <td class="py-3 px-4 text-xs text-gray-500">${u.last_login || '-'}</td>
          <td class="py-3 px-4"><span class="text-[10px] px-2 py-0.5 rounded-full ${statusClass}">${statusText}</span></td>
          <td class="py-3 px-4 space-x-2">
            <form method="POST" action="/admin/api/users/${u.id}/toggle-block" class="inline"><input type="hidden" name="_csrf" value="${csrfToken}"><button class="text-xs ${blockBtnClass} hover:underline">${blockBtnText}</button></form>
            <form method="POST" action="/admin/api/users/${u.id}/reset-token" class="inline"><input type="hidden" name="_csrf" value="${csrfToken}"><button type="button" class="text-xs text-amber-400 hover:underline" onclick="_confirm('é‡ç½®è®¢é˜…ï¼Ÿ').then(ok=>{if(ok)this.closest('form').submit()})">é‡ç½®</button></form>
          </td>
        </tr>`;
      }).join('');

      // ç§»åŠ¨ç«¯å¡ç‰‡
      cards.innerHTML = rowsHtml.map(({u, statusClass, statusText, blockBtnClass, blockBtnText, limitText, expiryText, expiryClass}) => {
        return `<div class="glass rounded-2xl p-4 space-y-2">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <img src="${u.avatar_url || ''}" class="w-6 h-6 rounded-full ring-1 ring-white/10 bg-gray-800" onerror="this.style.display='none'">
              <span class="text-white text-sm font-medium">${u.username}</span>
              ${u.is_admin ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300">ç®¡ç†</span>' : ''}
            </div>
            <span class="text-[10px] px-2 py-0.5 rounded-full ${statusClass}">${statusText}</span>
          </div>
          <div class="grid grid-cols-2 gap-1.5 text-xs">
            <div><span class="text-gray-500">ID</span><span class="block text-gray-400 mt-0.5">${u.nodeloc_id}</span></div>
            <div><span class="text-gray-500">ç­‰çº§</span><span class="block text-gray-300 mt-0.5">${u.trust_level}</span></div>
            <div><span class="text-gray-500">æµé‡</span><span class="block text-gray-400 mt-0.5">${_fmtBytes(u.total_traffic || 0)} / <span class="cursor-pointer text-cyan-400" onclick="setTrafficLimit(${u.id}, '${u.username}', ${u.traffic_limit || 0})">${limitText}</span></span></div>
            <div><span class="text-gray-500">åˆ°æœŸ</span><span class="block mt-0.5 cursor-pointer ${expiryClass}" onclick="setExpiry(${u.id}, '${u.username}', '${u.expires_at || ''}')">${expiryText}</span></div>
            <div class="col-span-2"><span class="text-gray-500">æœ€åç™»å½•</span><span class="text-gray-500 ml-2">${u.last_login || '-'}</span></div>
          </div>
          <div class="flex gap-3 pt-1.5 border-t border-white/5">
            <form method="POST" action="/admin/api/users/${u.id}/toggle-block" class="inline"><input type="hidden" name="_csrf" value="${csrfToken}"><button class="text-xs ${blockBtnClass} hover:underline">${blockBtnText}</button></form>
            <form method="POST" action="/admin/api/users/${u.id}/reset-token" class="inline"><input type="hidden" name="_csrf" value="${csrfToken}"><button type="button" class="text-xs text-amber-400 hover:underline" onclick="_confirm('é‡ç½®è®¢é˜…ï¼Ÿ').then(ok=>{if(ok)this.closest('form').submit()})">é‡ç½®</button></form>
          </div>
        </div>`;
      }).join('');

      // åˆ†é¡µä¿¡æ¯
      const limit = 20;
      const pages = Math.ceil(total / limit);
      const start = (page - 1) * limit + 1;
      const end = Math.min(page * limit, total);
      document.getElementById('users-page-info').textContent = `ç¬¬ ${start}-${end} æ¡ï¼Œå…± ${total} æ¡`;
      document.getElementById('users-page-info-m').textContent = `${start}-${end} / ${total}`;

      // åˆ†é¡µæŒ‰é’®
      const nav = document.getElementById('users-pagination');
      const navM = document.getElementById('users-pagination-m');
      nav.innerHTML = '';
      navM.innerHTML = '';
      if (pages <= 1) return;
      const mkBtn = (text, p, active) => {
        const b = document.createElement('button');
        b.textContent = text;
        b.className = active ? 'px-2.5 py-1 rounded-lg text-xs bg-rose-600 text-white' : 'px-2.5 py-1 rounded-lg text-xs glass text-gray-400 hover:text-white hover:bg-white/10 transition';
        if (!active) b.onclick = () => loadUsers(p);
        return b;
      };
      if (page > 1) { nav.appendChild(mkBtn('â€¹', page - 1, false)); navM.appendChild(mkBtn('â€¹', page - 1, false)); }
      let s = Math.max(1, page - 3), e = Math.min(pages, s + 6);
      if (e - s < 6) s = Math.max(1, e - 6);
      for (let p = s; p <= e; p++) { nav.appendChild(mkBtn(p, p, p === page)); navM.appendChild(mkBtn(p, p, p === page)); }
      if (page < pages) { nav.appendChild(mkBtn('â€º', page + 1, false)); navM.appendChild(mkBtn('â€º', page + 1, false)); }
    };

    window.filterUsers = function() {
      clearTimeout(_searchTimer);
      _searchTimer = setTimeout(() => loadUsers(1), 300);
    };

    document.getElementById('user-search').addEventListener('input', filterUsers);

    // åˆå§‹åŠ è½½
    loadUsers(1);
  })();
  </script>
</div>

<!-- ç™½åå• Tab -->
<div class="tab-panel space-y-4" data-tab="whitelist">
  <!-- æ³¨å†Œç™½åå• -->
  <div class="glass rounded-2xl p-5">
    <div class="mb-4">
      <h3 class="text-white text-sm font-medium mb-1">ğŸ« æ³¨å†Œç™½åå•</h3>
      <p class="text-gray-500 text-xs">æ³¨å†Œäººæ•°æ»¡é¢æ—¶ï¼Œç™½åå•ä¸­çš„ç”¨æˆ·åä»å¯æ³¨å†Œï¼Œæ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç§»é™¤</p>
    </div>
    <form method="POST" action="/admin/api/register-whitelist/add" class="flex gap-2 mb-4">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="text" name="username" placeholder="è¾“å…¥ NodeLoc ç”¨æˆ·å" class="flex-1 bg-black/30 text-white px-4 py-2 rounded-xl border border-white/10 text-sm" required>
      <button class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition">æ·»åŠ </button>
    </form>
    <div class="flex flex-wrap gap-2">
      <% registerWhitelist.forEach(function(r) { %>
        <form method="POST" action="/admin/api/register-whitelist/remove" class="inline">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="username" value="<%= r.username %>">
          <button class="glass text-gray-300 px-3 py-1 rounded-full text-xs hover:bg-red-500/20 hover:text-red-300 transition"><%= r.username %> âœ•</button>
        </form>
      <% }); %>
      <% if (registerWhitelist.length === 0) { %><p class="text-gray-600 text-sm">æš‚æ— å¾…æ³¨å†Œç”¨æˆ·</p><% } %>
    </div>
  </div>

  <!-- èŠ‚ç‚¹ç™½åå• -->
  <div class="glass rounded-2xl p-5">
    <div class="mb-4">
      <h3 class="text-white text-sm font-medium mb-1">ğŸ”“ èŠ‚ç‚¹ç™½åå•</h3>
      <p class="text-gray-500 text-xs">ç™½åå•ç”¨æˆ·æ— è§†èŠ‚ç‚¹ç­‰çº§é™åˆ¶ï¼Œå¯è·å–å…¨éƒ¨èŠ‚ç‚¹</p>
    </div>
    <form method="POST" action="/admin/api/whitelist/add" class="flex gap-2 mb-4">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="text" name="username" placeholder="è¾“å…¥ç”¨æˆ·å" class="flex-1 bg-black/30 text-white px-4 py-2 rounded-xl border border-white/10 text-sm" required>
      <button class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition">æ·»åŠ </button>
    </form>
    <div class="flex flex-wrap gap-2">
      <% whitelist.forEach(function(w) { %>
        <form method="POST" action="/admin/api/whitelist/remove" class="inline">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="nodeloc_id" value="<%= w.nodeloc_id %>">
          <button class="glass text-gray-300 px-3 py-1 rounded-full text-xs hover:bg-red-500/20 hover:text-red-300 transition"><%= w.username || ('ID:' + w.nodeloc_id) %> âœ•</button>
        </form>
      <% }); %>
      <% if (whitelist.length === 0) { %><p class="text-gray-600 text-sm">ç™½åå•ä¸ºç©º</p><% } %>
    </div>
  </div>
</div>

<div class="tab-panel" data-tab="logs">
  <!-- å­ Tab åˆ‡æ¢ -->
  <div class="flex gap-2 mb-4">
    <button onclick="switchLogType('system')" class="text-xs px-3 py-1.5 rounded-lg transition bg-rose-600 text-white" data-logtype="system">ğŸ–¥ï¸ ç³»ç»Ÿæ—¥å¿—</button>
    <button onclick="switchLogType('user')" class="text-xs px-3 py-1.5 rounded-lg transition glass text-gray-400 hover:text-white" data-logtype="user">ğŸ‘¤ æ“ä½œæ—¥å¿—</button>
    <button onclick="switchLogType('all')" class="text-xs px-3 py-1.5 rounded-lg transition glass text-gray-400 hover:text-white" data-logtype="all">ğŸ“‹ å…¨éƒ¨</button>
    <div class="flex-1"></div>
    <button onclick="clearLogs()" class="text-red-400 hover:text-red-300 text-xs">ğŸ—‘ æ¸…ç©º</button>
  </div>

  <div class="glass rounded-2xl overflow-hidden">
    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-500 border-b border-white/5 text-xs sticky top-0" style="background:rgba(15,11,30,0.95)">
          <tr><th class="py-3 px-4">æ—¶é—´</th><th class="py-3 px-4">æ¥æº</th><th class="py-3 px-4">æ“ä½œ</th><th class="py-3 px-4">è¯¦æƒ…</th></tr>
        </thead>
        <tbody class="text-gray-300" id="log-body">
          <% logs.rows.forEach(function(l) { %>
          <tr class="border-b border-white/5">
            <td class="py-2 px-4 text-xs text-gray-500"><%= l.created_at %></td>
            <td class="py-2 px-4 text-xs"><%= l.ip === 'system' ? '<span class="text-amber-400">ç³»ç»Ÿ</span>' : (l.username || '-') %></td>
            <td class="py-2 px-4 text-xs"><%= l.action %></td>
            <td class="py-2 px-4 text-xs text-gray-500 max-w-xs truncate"><%= l.detail || '' %></td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    <div class="flex items-center justify-between p-3 border-t border-white/5">
      <span class="text-gray-600 text-xs" id="log-info">å…± <%= logs.total %> æ¡</span>
      <div class="flex gap-1" id="log-pager"></div>
    </div>
  </div>
</div>

<!-- è®¢é˜…è®¿é—®ç»Ÿè®¡ Tab -->
<div class="tab-panel space-y-4" data-tab="abuse">
  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-white text-sm font-medium">ğŸ“ˆ è®¢é˜…è®¿é—®ç»Ÿè®¡</h3>
      <div class="flex items-center gap-2 flex-wrap">
        <select id="substats-hours" class="bg-black/30 text-gray-300 text-xs px-2 py-1 rounded-lg border border-white/10">
          <option value="1">1å°æ—¶</option><option value="24" selected>24å°æ—¶</option><option value="168">7å¤©</option>
        </select>
        <select id="substats-sort" class="bg-black/30 text-gray-300 text-xs px-2 py-1 rounded-lg border border-white/10">
          <option value="count">æ‹‰å–æ¬¡æ•°</option><option value="ip">IPæ•°é‡</option><option value="last">æœ€è¿‘æ‹‰å–</option>
        </select>
        <label class="flex items-center gap-1 text-gray-400 text-xs"><input type="checkbox" id="substats-high" class="accent-rose-500"> ä»…é«˜é£é™©</label>
        <button onclick="loadSubStats(1)" class="bg-rose-600 hover:bg-rose-500 text-white text-xs px-3 py-1.5 rounded-lg transition">æŸ¥è¯¢</button>
      </div>
    </div>
    <div id="substats-result">
      <p class="text-gray-600 text-sm text-center py-4">ç‚¹å‡»ã€ŒæŸ¥è¯¢ã€æŸ¥çœ‹ç»Ÿè®¡</p>
    </div>
    <div id="substats-pager" class="flex justify-center gap-2 mt-3"></div>
  </div>
  <div class="glass rounded-2xl p-5 hidden" id="substats-detail-panel">
    <h3 class="text-white text-sm font-medium mb-3" id="substats-detail-title">ç”¨æˆ·è¯¦æƒ…</h3>
    <div id="substats-detail"></div>
  </div>
</div>

<!-- é€šçŸ¥ Tabï¼ˆä»… TG é…ç½®å’Œäº‹ä»¶å¼€å…³ï¼‰ -->
<div class="tab-panel space-y-4" data-tab="notify">
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-4">ğŸ”” Telegram é€šçŸ¥é…ç½®</h3>
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div>
        <label class="text-gray-500 text-xs block mb-1">Bot Token</label>
        <input type="password" id="tg-token" value="" placeholder="<%= tgBotToken ? 'å·²é…ç½®ï¼ˆç•™ç©ºä¿ç•™åŸå€¼ï¼‰' : '123456:ABC-DEF...' %>" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <div>
        <label class="text-gray-500 text-xs block mb-1">Chat ID</label>
        <input type="text" id="tg-chat-id" value="<%= (typeof tgChatId !== 'undefined' ? tgChatId : '') %>" placeholder="-100123456789" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
    </div>
    <div class="flex gap-2 mb-6">
      <button onclick="saveTG()" class="bg-rose-600 hover:bg-rose-500 text-white text-xs px-4 py-2 rounded-xl transition">ä¿å­˜</button>
      <button onclick="testTG()" class="glass text-gray-300 hover:text-white text-xs px-4 py-2 rounded-xl transition">å‘é€æµ‹è¯•</button>
    </div>
    <h3 class="text-white text-sm font-medium mb-3">é€šçŸ¥äº‹ä»¶</h3>
    <div class="space-y-2">
      <% var events = [
        { key: 'tg_on_node_down', label: 'ğŸ”´ èŠ‚ç‚¹ç¦»çº¿/æ¢å¤', desc: 'èŠ‚ç‚¹ä¸Šä¸‹çº¿çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥' },
        { key: 'tg_on_node_blocked', label: 'ğŸ§± èŠ‚ç‚¹è¢«å¢™', desc: 'æ£€æµ‹åˆ°èŠ‚ç‚¹ç–‘ä¼¼è¢«å¢™æ—¶é€šçŸ¥' },
        { key: 'tg_on_rotate', label: 'ğŸ”„ è‡ªåŠ¨è½®æ¢', desc: 'æ¯æ—¥è½®æ¢å®Œæˆåé€šçŸ¥' },
        { key: 'tg_on_abuse', label: 'âš ï¸ è®¢é˜…å¼‚å¸¸', desc: 'æ£€æµ‹åˆ°å¤šIPæ‹‰å–æ—¶é€šçŸ¥' },
        { key: 'tg_on_traffic', label: 'ğŸ“Š æµé‡è¶…æ ‡', desc: 'ç”¨æˆ·æ—¥æµé‡è¶…10GBæ—¶é€šçŸ¥' },
        { key: 'tg_on_register', label: 'ğŸ‘¤ æ–°ç”¨æˆ·æ³¨å†Œ', desc: 'æœ‰æ–°ç”¨æˆ·æ³¨å†Œæ—¶é€šçŸ¥' },
        { key: 'tg_on_deploy', label: 'ğŸš€ èŠ‚ç‚¹éƒ¨ç½²', desc: 'èŠ‚ç‚¹éƒ¨ç½²æˆåŠŸæˆ–å¤±è´¥æ—¶é€šçŸ¥' }
      ]; events.forEach(function(ev) { %>
        <label class="flex items-center justify-between p-3 rounded-xl bg-black/20 cursor-pointer hover:bg-white/5 transition">
          <div>
            <span class="text-white text-sm"><%= ev.label %></span>
            <span class="text-gray-600 text-xs ml-2"><%= ev.desc %></span>
          </div>
          <input type="checkbox" class="tg-event accent-rose-500" data-key="<%= ev.key %>" <%= (typeof tgEvents !== 'undefined' && tgEvents[ev.key]) ? 'checked' : '' %> onchange="toggleEvent(this)">
        </label>
      <% }); %>
    </div>
  </div>
</div>

<!-- è®¾ç½® Tab -->
<div class="tab-panel space-y-4" data-tab="settings">
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">ğŸ“¢ å…¬å‘Šç®¡ç†</h3>
    <div class="flex gap-2">
      <input type="text" id="announcement-text" value="<%= announcement %>" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹ï¼ˆç•™ç©ºåˆ™ä¸æ˜¾ç¤ºï¼‰" class="flex-1 bg-black/30 text-white px-4 py-2 rounded-xl border border-white/10 text-sm">
      <button onclick="saveAnnouncement()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition">ä¿å­˜</button>
    </div>
  </div>

  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">ğŸ‘¥ æ³¨å†Œäººæ•°é™åˆ¶</h3>
    <p class="text-gray-600 text-xs mb-3">è®¾ä¸º 0 è¡¨ç¤ºä¸é™åˆ¶ï¼Œå½“å‰å·²æ³¨å†Œ <span class="text-rose-400"><%= userCount %></span> äºº</p>
    <div class="flex gap-2">
      <input type="number" id="max-users-input" value="<%= maxUsers %>" min="0" placeholder="0 = ä¸é™åˆ¶" class="flex-1 bg-black/30 text-white px-4 py-2 rounded-xl border border-white/10 text-sm">
      <button onclick="saveMaxUsers()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition">ä¿å­˜</button>
    </div>
  </div>

  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">ğŸ“¦ é»˜è®¤æµé‡é™é¢</h3>
    <p class="text-gray-600 text-xs mb-3">æ–°ç”¨æˆ·æ³¨å†Œæ—¶çš„é»˜è®¤æµé‡ä¸Šé™ï¼ˆTBï¼‰ï¼Œ0 = æ— é™</p>
    <div class="flex flex-wrap gap-2">
      <input id="default-traffic-limit" value="<%= defaultTrafficLimit ? (defaultTrafficLimit / 1099511627776).toFixed(2) : 0 %>" min="0" step="any" placeholder="0 = æ— é™" class="flex-1 min-w-[120px] bg-black/30 text-white px-4 py-2 rounded-xl border border-white/10 text-sm [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
      <span class="text-gray-500 text-sm self-center">TB</span>
      <button onclick="saveDefaultTrafficLimit()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 py-2 rounded-xl text-sm transition">ä¿å­˜</button>
      <button onclick="applyDefaultTrafficLimit()" class="glass text-gray-200 px-4 py-2 rounded-xl text-sm hover:bg-white/10 transition whitespace-nowrap">åº”ç”¨åˆ°å…¨éƒ¨ç”¨æˆ·</button>
    </div>
  </div>
</div>

<!-- AWS Tab -->
<div class="tab-panel space-y-4" data-tab="aws">
  <!-- å®ä¾‹ä»ªè¡¨ç›˜ -->
  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-white text-sm font-medium">ğŸ“Š å®ä¾‹ä»ªè¡¨ç›˜</h3>
      <button type="button" onclick="loadAllInstances(true)" class="text-xs glass text-gray-300 hover:text-white px-3 py-1.5 rounded-xl transition">ğŸ”„ åˆ·æ–°å®ä¾‹</button>
    </div>
    <div id="aws-instances-loading" class="hidden text-center py-8 text-gray-500 text-sm">â³ åŠ è½½ä¸­...</div>
    <div id="aws-instances-container" class="text-center py-8 text-gray-500 text-xs">ç‚¹å‡»ã€ŒğŸ”„ åˆ·æ–°å®ä¾‹ã€åŠ è½½</div>
  </div>

  <div class="glass rounded-2xl p-5">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-white text-sm font-medium">â˜ï¸ AWS é…ç½®</h3>
      <span id="aws-status" class="text-xs px-2 py-0.5 rounded-full bg-gray-500/20 text-gray-400">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="text-gray-500 text-xs block mb-1">è´¦å·åç§°</label>
        <input type="text" id="aws-name" placeholder="å¦‚ aws-01" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <!-- åŒºåŸŸç­–ç•¥è¯´æ˜å·²ç§»é™¤ï¼Œé»˜è®¤èµ°ç³»ç»Ÿ us-east-1 ç­–ç•¥ -->
      <div>
        <label class="text-gray-500 text-xs block mb-1">Access Key ID</label>
        <input type="password" id="aws-ak" placeholder="AKIA..." class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <div class="col-span-2">
        <label class="text-gray-500 text-xs block mb-1">Secret Access Key</label>
        <input type="password" id="aws-sk" placeholder="xxxxxxxx" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
      </div>
      <div class="col-span-2">
        <label class="text-gray-500 text-xs block mb-1">SOCKS5 ä»£ç† (å¯é€‰)</label>
        <div class="flex gap-2">
          <input type="text" id="aws-socks-url" placeholder="socks5://user:pass@host:port" class="flex-1 bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
          <button type="button" onclick="testSocksProxy()" class="glass text-gray-300 hover:text-white px-4 py-2 rounded-xl text-sm transition">éªŒè¯</button>
        </div>
        <p id="aws-socks-test-result" class="text-[11px] text-gray-500 mt-1"></p>
      </div>
      <div class="col-span-2">
        <button type="button" onclick="saveAwsConfig()" class="w-full bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition mt-1">æ–°å¢è´¦å·</button>
      </div>
    </div>
    <div id="aws-accounts" class="mt-3 space-y-2"></div>
  </div>

  <!-- èŠ‚ç‚¹ AWS ç»‘å®š -->
  <div class="glass rounded-2xl p-5">
    <h3 class="text-white text-sm font-medium mb-3">ğŸ”— èŠ‚ç‚¹ç»‘å®š AWS å®ä¾‹</h3>
    <p class="text-gray-600 text-xs mb-3">ç»‘å®šåï¼Œè¢«å¢™æ—¶è‡ªåŠ¨æ¢ IPï¼›ä¹Ÿå¯æ‰‹åŠ¨æ¢ IP</p>
    <div class="space-y-2">
      <% nodes.forEach(function(n) { %>
      <div class="flex items-center justify-between p-3 rounded-xl bg-black/20">
        <div class="flex items-center gap-2">
          <span class="text-white text-sm"><%= n.name %></span>
          <span class="text-gray-500 text-xs"><%= n.host %></span>
          <% if (n.aws_instance_id) { %>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300"><%= n.aws_type || 'ec2' %>: <%= n.aws_instance_id %> (è´¦å·#<%= n.aws_account_id || '-' %>)</span>
          <% } %>
        </div>
        <div class="flex items-center gap-2">
          <% if (n.aws_instance_id) { %>
            <button type="button" onclick="swapNodeIp(<%= n.id %>, '<%= n.name %>')" class="text-xs bg-amber-600 hover:bg-amber-500 text-white px-3 py-1 rounded-lg transition">ğŸ”„ æ¢ IP</button>
            <button type="button" onclick="unbindAws(<%= n.id %>)" class="text-xs text-gray-500 hover:text-red-400">è§£ç»‘</button>
          <% } else { %>
            <button type="button" onclick="showBindAws(<%= n.id %>)" class="text-xs text-blue-400 hover:text-blue-300">ç»‘å®š</button>
          <% } %>
        </div>
      </div>
      <% }); %>
    </div>
  </div>

  <!-- è´¦å·ç¼–è¾‘å¼¹çª— -->
  <div id="aws-edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60" onclick="if(event.target===this)closeAwsEditModal()">
    <div class="glass rounded-2xl p-6 w-[92%] max-w-md border border-white/10">
      <h3 class="text-white text-sm font-medium mb-4">ç¼–è¾‘ AWS è´¦å·</h3>
      <input type="hidden" id="edit-aws-id">
      <div class="space-y-3">
        <div>
          <label class="text-gray-500 text-xs block mb-1">å¤‡æ³¨ / è´¦å·å</label>
          <input type="text" id="edit-aws-name" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-gray-500 text-xs block mb-1">Access Key</label>
            <input type="text" id="edit-aws-ak" readonly class="w-full bg-black/20 text-gray-400 px-3 py-2 rounded-xl border border-white/10 text-sm">
          </div>
          <div>
            <label class="text-gray-500 text-xs block mb-1">Secret Key</label>
            <input type="text" id="edit-aws-sk" readonly value="******** (å·²ä¿å­˜)" class="w-full bg-black/20 text-gray-400 px-3 py-2 rounded-xl border border-white/10 text-sm">
          </div>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">SOCKS5 URL</label>
          <div class="flex gap-2">
            <input type="text" id="edit-aws-socks" placeholder="socks5://user:pass@host:portï¼ˆç•™ç©ºæ¸…é™¤ï¼‰" class="flex-1 bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <button type="button" onclick="testSocksProxyInput('edit-aws-socks','edit-aws-socks-test')" class="glass text-gray-300 hover:text-white px-4 py-2 rounded-xl text-sm transition">éªŒè¯</button>
          </div>
          <p id="edit-aws-socks-test" class="text-[11px] text-gray-500 mt-1"></p>
        </div>
        <div class="flex gap-2 pt-1">
          <button type="button" onclick="saveAwsEdit()" class="flex-1 bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition">ä¿å­˜ä¿®æ”¹</button>
          <button type="button" onclick="closeAwsEditModal()" class="flex-1 glass text-gray-300 hover:text-white py-2 rounded-xl text-sm transition">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç»‘å®šå¼¹çª— -->
  <div id="aws-bind-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60">
    <div class="glass rounded-2xl p-6 w-96">
      <h3 class="text-white text-sm font-medium mb-4">ç»‘å®š AWS å®ä¾‹</h3>
      <input type="hidden" id="bind-node-id">
      <div class="space-y-3">
        <div>
          <label class="text-gray-500 text-xs block mb-1">AWS è´¦å·</label>
          <select id="bind-account-id" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm"></select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">å®ä¾‹ç±»å‹</label>
          <select id="bind-type" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <option value="ec2">EC2</option>
            <option value="lightsail">Lightsail</option>
          </select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">å®ä¾‹ ID / åç§°</label>
          <input type="text" id="bind-instance-id" placeholder="i-0abc123... æˆ– Lightsail å®ä¾‹å" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">åŒºåŸŸ</label>
          <select id="bind-region" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <option value="">é»˜è®¤åŒºåŸŸ</option>
            <option value="us-east-1">us-east-1 (å¼—å‰å°¼äºš)</option>
            <option value="us-west-2">us-west-2 (ä¿„å‹’å†ˆ)</option>
            <option value="ap-northeast-1">ap-northeast-1 (ä¸œäº¬)</option>
            <option value="ap-southeast-1">ap-southeast-1 (æ–°åŠ å¡)</option>
            <option value="ap-south-1">ap-south-1 (å­Ÿä¹°)</option>
            <option value="eu-west-1">eu-west-1 (çˆ±å°”å…°)</option>
            <option value="eu-central-1">eu-central-1 (æ³•å…°å…‹ç¦)</option>
            <option value="ca-central-1">ca-central-1 (åŠ æ‹¿å¤§)</option>
            <option value="sa-east-1">sa-east-1 (åœ£ä¿ç½—)</option>
            <option value="ap-east-1">ap-east-1 (é¦™æ¸¯)</option>
            <option value="ap-southeast-2">ap-southeast-2 (æ‚‰å°¼)</option>
            <option value="ap-northeast-2">ap-northeast-2 (é¦–å°”)</option>
            <option value="ap-northeast-3">ap-northeast-3 (å¤§é˜ª)</option>
            <option value="eu-west-2">eu-west-2 (ä¼¦æ•¦)</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button type="button" onclick="confirmBindAws()" class="flex-1 bg-rose-600 hover:bg-rose-500 text-white py-2 rounded-xl text-sm transition">ç¡®è®¤ç»‘å®š</button>
          <button type="button" onclick="document.getElementById('aws-bind-modal').classList.add('hidden')" class="flex-1 glass text-gray-300 hover:text-white py-2 rounded-xl text-sm transition">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å»ºå®ä¾‹å¼¹çª— -->
  <div id="aws-launch-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="glass rounded-2xl p-6 w-[92%] max-w-md border border-white/10">
      <h3 class="text-white text-sm font-medium mb-4">ğŸš€ æ–°å»ºå®ä¾‹å¹¶éƒ¨ç½²</h3>
      <div class="space-y-3">
        <div>
          <label class="text-gray-500 text-xs block mb-1">AWS è´¦å·</label>
          <select id="launch-account-id" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm"></select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">åŒºåŸŸ</label>
          <select id="launch-region" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <option value="us-east-1">us-east-1 (å¼—å‰å°¼äºš)</option>
            <option value="us-west-2">us-west-2 (ä¿„å‹’å†ˆ)</option>
            <option value="ap-northeast-1">ap-northeast-1 (ä¸œäº¬)</option>
            <option value="ap-southeast-1">ap-southeast-1 (æ–°åŠ å¡)</option>
            <option value="ap-south-1">ap-south-1 (å­Ÿä¹°)</option>
            <option value="eu-west-1">eu-west-1 (çˆ±å°”å…°)</option>
            <option value="eu-central-1">eu-central-1 (æ³•å…°å…‹ç¦)</option>
            <option value="ca-central-1">ca-central-1 (åŠ æ‹¿å¤§)</option>
            <option value="sa-east-1">sa-east-1 (åœ£ä¿ç½—)</option>
            <option value="ap-east-1">ap-east-1 (é¦™æ¸¯)</option>
            <option value="ap-southeast-2">ap-southeast-2 (æ‚‰å°¼)</option>
            <option value="ap-northeast-2">ap-northeast-2 (é¦–å°”)</option>
            <option value="ap-northeast-3">ap-northeast-3 (å¤§é˜ª)</option>
            <option value="eu-west-2">eu-west-2 (ä¼¦æ•¦)</option>
          </select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">å®ä¾‹ç±»å‹</label>
          <select id="launch-type" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm" onchange="updateLaunchSpecs()">
            <option value="ec2">EC2</option>
            <option value="lightsail">Lightsail</option>
          </select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">é…ç½®è§„æ ¼</label>
          <select id="launch-spec" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
            <option value="t4g.micro">t4g.micro (1C/1G)</option>
            <option value="t4g.small">t4g.small (2C/2G)</option>
            <option value="t4g.medium">t4g.medium (2C/4G)</option>
          </select>
        </div>
        <div>
          <label class="text-gray-500 text-xs block mb-1">SSH å¯†ç ï¼ˆubuntu ç”¨æˆ·ï¼‰</label>
          <input type="password" id="launch-ssh-password" placeholder="ç”¨äºè‡ªåŠ¨éƒ¨ç½² xray" class="w-full bg-black/30 text-white px-3 py-2 rounded-xl border border-white/10 text-sm">
        </div>
        <p class="text-gray-600 text-[11px]">åˆ›å»ºåå°†è‡ªåŠ¨: ç­‰å¾…å°±ç»ª â†’ éƒ¨ç½² xray â†’ æ·»åŠ é¢æ¿èŠ‚ç‚¹ â†’ ç»‘å®šå®ä¾‹</p>
        <div class="flex gap-2">
          <button type="button" onclick="confirmLaunch()" id="launch-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-xl text-sm transition">ğŸš€ åˆ›å»ºå¹¶éƒ¨ç½²</button>
          <button type="button" onclick="document.getElementById('aws-launch-modal').classList.add('hidden')" class="flex-1 glass text-gray-300 hover:text-white py-2 rounded-xl text-sm transition">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>
</div>
